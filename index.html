<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orden de Servicio</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f9;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    form {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .full-width {
      grid-column: span 2;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }

    /* √Årea de fotos */
    .photo-section {
      background: #eef6ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .photo-preview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .photo-preview img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Orden de Servicio</h1>

  <form id="ordenForm">
    <div class="form-grid">
      <div class="full-width">
        <h2>üì∑ Fotograf√≠as del Servicio (m√°x. 5)</h2>
        <button type="button" onclick="tomarFoto()">Agregar Foto</button>
        <div class="photo-preview" id="photoPreview"></div>
      </div>
    </div>

    <button type="button" onclick="enviarInforme()">üì§ Enviar Informe</button>
  </form>

<script>
// ===============================
// CONFIGURACI√ìN
// ===============================
const APP_URL = "https://script.google.com/macros/s/AKfycbxup14S8YsKJn-tXnOkAigxnZHtPCL5SKj-hPBPHHGxlL2FnqyhQOj4U5CiO2jWrUk/exec";

let fotos = [];
let db;

// ===============================
// INDEXEDDB
// ===============================
function abrirDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("realtechDB", 1);

    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("informes")) {
        db.createObjectStore("informes", { keyPath: "id" });
      }
    };

    request.onsuccess = (e) => {
      db = e.target.result;
      resolve();
    };

    request.onerror = () => reject();
  });
}

// Guardar informe offline
async function guardarInformeOffline(informe) {
  await abrirDB();
  const tx = db.transaction(["informes"], "readwrite");
  tx.objectStore("informes").put(informe);
  return tx.complete;
}

// Leer informes pendientes
async function obtenerPendientes() {
  await abrirDB();
  return new Promise((resolve) => {
    const tx = db.transaction(["informes"], "readonly");
    const store = tx.objectStore("informes");
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result);
  });
}

// Borrar informe enviado
async function borrarInforme(id) {
  await abrirDB();
  const tx = db.transaction(["informes"], "readwrite");
  tx.objectStore("informes").delete(id);
  return tx.complete;
}

// ===============================
// CAPTURA DE FOTOS
// ===============================
function tomarFoto() {
  if (fotos.length >= 5) {
    alert("M√°ximo 5 fotos permitidas");
    return;
  }

  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.capture = "environment";

  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (ev) => {
      const compressed = await comprimirImagen(ev.target.result);
      fotos.push(compressed);
      mostrarFotos();
    };

    reader.readAsDataURL(file);
  };

  input.click();
}

function mostrarFotos() {
  const cont = document.getElementById("photoPreview");
  cont.innerHTML = "";
  fotos.forEach((f) => {
    const img = document.createElement("img");
    img.src = f;
    cont.appendChild(img);
  });
}

async function comprimirImagen(base64) {
  const img = new Image();
  img.src = base64;
  await img.decode();

  const canvas = document.createElement("canvas");
  const MAX_WIDTH = 1280;

  let width = img.width;
  let height = img.height;

  if (width > MAX_WIDTH) {
    height *= MAX_WIDTH / width;
    width = MAX_WIDTH;
  }

  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, width, height);

  return canvas.toDataURL("image/jpeg", 0.55);
}

// ===============================
// GENERAR INFORME PARA APP SCRIPT
// ===============================
function recolectarDatos() {
  return {
    fecha: new Date().toISOString(),
    cliente: document.getElementById("cliente")?.value || "",
    equipo: document.getElementById("modelo")?.value || "",
    observaciones: document.getElementById("observaciones")?.value || "",
    fotos: fotos,
    html: document.body.innerHTML
  };
}

// ===============================
// ENV√çO Y SINCRONIZACI√ìN
// ===============================
async function enviarInforme() {
  const data = recolectarDatos();
  const informe = { id: Date.now(), data };

  await guardarInformeOffline(informe);
  alert("Informe guardado offline. Se enviar√° cuando haya Internet.");

  syncInformesPendientes();
}

async function syncInformesPendientes() {
  const pendientes = await obtenerPendientes();
  if (pendientes.length === 0) return;

  for (const informe of pendientes) {
    try {
      const res = await fetch(APP_URL, {
        method: "POST",
        body: JSON.stringify({ action: "syncInforme", data: informe.data }),
        headers: { "Content-Type": "application/json" }
      });

      const json = await res.json();
      if (json.success) {
        await borrarInforme(informe.id);
        console.log("Informe enviado: ", informe.id);
      }
    } catch (e) {
      console.log("Sin Internet. Reintento despu√©s...");
      return;
    }
  }
}

window.addEventListener("online", syncInformesPendientes);

</script>
</body>
</html>
