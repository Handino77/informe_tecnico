<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Orden de Servicio Técnico - Realtech SpA</title>
<link rel="icon" href="logo_realtech.png" />
<style>
  /* --------- Diseño base responsive --------- */
  :root{
    --blue: #004a99;
    --blue-dark: #003370;
    --muted: #f8fafc;
    --accent: #38a169;
    --danger: #e53e3e;
    --card: #ffffff;
    --text: #1f2937;
    --sub: #64748b;
    --border: #e2e8f0;
    --radius: 10px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: #f1f5f9;
    color: var(--text);
    padding: 15px;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding-bottom: 100px; /* Espacio para controles móviles */
  }

  /* Contenedor Principal */
  .container {
    width: 100%;
    max-width: 980px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 25px;
    position: relative;
  }

  /* Header */
  header {
    display: flex;
    gap: 20px;
    align-items: center;
    border-bottom: 2px solid var(--muted);
    padding-bottom: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .logo img { width: 80px; height: auto; border-radius: 6px; object-fit: contain; }
  .brand { flex: 1; min-width: 200px; }
  .brand h1 { margin: 0; font-size: 20px; color: var(--blue); line-height: 1.2; }
  .brand p { margin: 4px 0 0; font-size: 13px; color: var(--sub); line-height: 1.4; }
  
  .meta { 
    text-align: right; 
    min-width: 140px; 
    background: var(--muted);
    padding: 10px;
    border-radius: 8px;
  }
  .meta .num { font-weight: 800; color: var(--blue); font-size: 18px; margin-bottom: 4px; }
  .meta .fecha { font-size: 13px; color: var(--sub); display: flex; flex-direction: column; align-items: flex-end; }
  .meta .fecha input { text-align: right; padding: 4px; border: none; background: transparent; font-weight: 600; color: var(--sub); }

  /* Grids Responsivos (La clave del arreglo) */
  .grid, .grid-eq {
    display: grid;
    /* Esto hace que las columnas se adapten automáticamente */
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
    align-items: end;
  }
  /* Excepciones para campos que deben ocupar todo el ancho si es necesario */
  .full-width { grid-column: 1 / -1; }

  label { display: block; font-size: 12px; color: var(--blue); font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  
  /* Inputs táctiles optimizados (Mobile-First) */
  input[type="text"], input[type="date"], input[type="number"], textarea, select {
    width: 100%;
    padding: 12px; /* Generoso */
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
    font-size: 16px; /* Evita zoom en iOS */
    color: var(--text);
    outline: none;
    transition: all 0.2s;
    height: 44px; /* Altura mínima táctil (44px min-height) */
  }
  input:focus, textarea:focus, select:focus {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
  }
  textarea { min-height: 80px; resize: vertical; height: auto; }

  /* Títulos de Sección */
  .section-title { margin: 25px 0 10px; }
  .section-title h2 {
    margin: 0; font-size: 14px;
    background: #f0f7ff;
    padding: 10px 15px;
    border-radius: 6px;
    border-left: 5px solid var(--blue);
    color: var(--blue);
    text-transform: uppercase;
  }

  /* Botón para añadir repuestos dentro de la sección (44px min-height) */
  .btn-section-add {
    background: #fff;
    border: 1px solid var(--border);
    color: var(--blue);
    padding: 12px 15px; /* Más padding para 44px min-height */
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    font-size: 14px;
    width: 100%; /* Ancho completo */
    margin-top: 15px;
    transition: background 0.2s;
    min-height: 44px; /* Asegurar área táctil */
  }
  .btn-section-add:hover { background: var(--muted); }

  /* Bloques expandibles y Repuestos */
  .exp { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; }
  .exp-hdr { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
  .exp-hdr strong { margin-right: auto; }
  
  /* Filas de repuestos responsive (CRÍTICO: Horizontal en Desktop) */
  .rep-row {
    display: grid;
    grid-template-columns: 1fr 140px 40px; /* Repuesto | Serie | Botón × */
    gap: 10px;
    align-items: center; /* Alinear verticalmente los inputs */
    margin-bottom: 12px;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  /* Ajustar inputs dentro de repuestos para que no tengan la altura táctil si es innecesario */
  .rep-row input { 
      height: 40px; 
      padding: 8px 10px; 
      font-size: 15px; /* Font size ligeramente menor en las filas de repuestos */
  }

  .rep-empty {
    font-size: 14px;
    color: var(--sub);
    font-style: italic;
    padding: 5px;
    text-align: center;
    display: none; /* Controlado por JS */
  }
  
  .btn-del {
    background: #fee2e2; color: var(--danger);
    border: none; border-radius: 6px;
    height: 40px; width: 100%;
    font-weight: bold; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; /* Símbolo × más grande */
  }

  /* Checkboxes */
  .chk-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 10px;
  }
  .chk-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px; background: #fff;
    border-radius: 8px; border: 1px solid var(--border);
    cursor: pointer;
  }
  .chk-item input { width: 18px; height: 18px; margin: 0; }
  .trab-desc { 
    margin-top: 10px; 
    padding: 12px; 
    background: #fff; 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    color: var(--sub); 
    font-size: 14px; 
    line-height: 1.5; 
  }

  /* Footer y Firmas */
  .footer { margin-top: 30px; border-top: 2px solid var(--muted); padding-top: 20px; }
  .firmas {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }
  /* Línea de firma solo para pantalla, se elimina en print */
  .firma-line { margin-top: 5px; border-top: 1px dashed var(--sub); padding-top: 5px; font-size: 11px; text-align: center; color: var(--sub); text-transform: uppercase; }

  /* Controles Flotantes (Botones) */
  .controls {
    position: fixed;
    bottom: 20px; right: 20px;
    display: flex; flex-direction: column; gap: 10px;
    z-index: 1000;
  }
  .controls button {
    padding: 12px 20px;
    border-radius: 50px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transition: transform 0.1s;
    min-width: 160px;
    text-align: center;
    min-height: 44px; /* Altura mínima táctil */
  }
  .controls button:active { transform: scale(0.96); }
  .btn-save { background: var(--accent); color: #fff; }
  .btn-blue { background: var(--blue); color: #fff; }

  /* Status Bar */
  .statusbar {
    position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
    padding: 8px 16px;
    border-radius: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    z-index: 1100;
    display: flex; gap: 10px; align-items: center; font-size: 13px;
    border: 1px solid var(--border);
    width: max-content;
    max-width: 90%;
  }

  /* ---------------- MEDIA QUERIES (Móvil) ---------------- */
  @media (max-width: 768px) {
    body { padding: 10px; padding-bottom: 140px; } /* Más espacio abajo para el menú flotante */
    .container { padding: 15px; border-radius: 0; box-shadow: none; max-width: 100%; }
    
    /* Header Stackeado */
    header { flex-direction: column; text-align: center; gap: 10px; }
    .brand { width: 100%; }
    .meta { width: 100%; display: flex; justify-content: space-between; align-items: center; text-align: left; }
    .meta .fecha { align-items: flex-start; }

    /* Inputs en una sola columna visualmente si es muy angosto */
    .grid, .grid-eq { grid-template-columns: 1fr; gap: 12px; }
    
    /* Repuestos Stackeado (CRÍTICO: Se stackea verticalmente en móvil) */
    .rep-row {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .rep-row div:last-child { margin-top: 5px; } /* Botón eliminar */

    /* Firmas Stackeadas */
    .firmas { grid-template-columns: 1fr; gap: 20px; }

    /* Controles: Barra inferior fija tipo App */
    .controls {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #fff;
      padding: 12px;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
      border-top: 1px solid var(--border);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
      border-radius: 0;
    }
    .controls button {
      flex: 1;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      min-width: auto;
      box-shadow: none;
    }
    .controls .btn-save { 
        flex: 2; 
        margin-left: 5px; 
        order: 2; 
        border: none; 
    }
    .controls .btn-blue { 
        flex: 1; 
        font-size: 13px;
        padding: 12px;
        order: 1;
        display: block; 
    }
  }

  /* ---------------- PRINT / PDF (CRÍTICO: Carta 8.5" x 11") ---------------- */
  @media print {
    /* Configuración de página: Carta con márgenes reducidos */
    @page {
      size: letter; /* 8.5in x 11in */
      margin: 12mm 15mm; /* Top/Bottom: 12mm, Left/Right: 15mm */
    }

    body, .container { 
        background: #fff; 
        margin: 0; 
        padding: 0; 
        box-shadow: none; 
        width: 100%; 
        max-width: 100%; 
        font-family: Arial, sans-serif;
        color: #000;
        font-size: 9px; /* Base font-size PDF */
        line-height: 1.15;
    }
    
    /* Ocultar elementos de UI */
    .controls, .statusbar, .btn-section-add, .btn-del, .exp-hdr { display: none !important; }
    
    /* Header (CRÍTICO: 3 columnas optimizado) */
    header { 
        display: grid; 
        grid-template-columns: 60px 1fr 120px; /* Logo | Info | N°/Fecha */
        gap: 15px;
        align-items: center;
        border-bottom: 1.5pt solid #000; /* Borde más grueso */
        padding-bottom: 8px;
        margin-bottom: 10px;
    }
    .logo img { width: 60px; height: auto; border-radius: 0; }
    .brand { flex: auto; text-align: left; }
    .brand h1 { 
        margin: 0 0 3px 0; 
        font-size: 12px; 
        font-weight: 700; 
        color: #000; 
        line-height: 1.1; 
    }
    .brand p { 
        margin: 0; 
        font-size: 8px; /* Pequeño para info extra */
        color: #555; 
        line-height: 1.1;
    }
    /* Separar RUT y Teléfono */
    .brand #contact-info { 
        font-size: 9px; 
        font-weight: 600; 
        color: #333; 
        margin-bottom: 2px;
    }
    .meta { 
        background: none; 
        padding: 0; 
        border-radius: 0;
        text-align: right; 
    }
    .meta .num { 
        font-weight: 800; 
        color: var(--blue); /* Mantiene el azul corporativo */
        font-size: 13px; 
        margin-bottom: 2px; 
    }
    .meta .fecha { 
        font-size: 9px; 
        color: #555; 
        align-items: flex-end; 
    }

    /* Layout General PDF */
    .section-title h2 { 
        font-size: 10px; 
        background: none; 
        padding: 0 0 5px 5px;
        border: none; 
        border-left: 3pt solid var(--blue); /* Azul corporativo */
        color: var(--blue); 
        border-bottom: none; 
        margin-bottom: 5px;
    }
    
    label { 
        font-size: 8px; /* Labels muy pequeños */
        color: #333; 
        margin-bottom: 3px; 
    }
    
    /* Grid 2 columnas para Cliente y Equipo */
    .grid, .grid-eq {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    /* Los inputs no tienen padding/border para el PDF, solo el valor */
    input, textarea, select { 
        border: none; 
        border-bottom: 0.5pt solid #ccc; /* Línea suave para ver dónde se llenó */
        padding: 0; 
        font-family: inherit; 
        font-size: 9px; 
        height: auto; 
        background: none;
        outline: none;
    }
    /* Contadores en línea */
    #contadores { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    #contadores label { margin-bottom: 3px; }
    
    /* Repuestos en PDF (CRÍTICO: Tabla compacta o mensaje) */
    .rep-row {
        display: grid;
        grid-template-columns: 2fr 1fr; /* Repuesto (60%) | Serie (40%) */
        gap: 0;
        margin-bottom: 2px;
        padding: 2px 4px;
        border: 0.5pt solid #ccc;
        border-radius: 0;
        background: none;
    }
    .rep-row label { display: none; } /* Ocultar labels de Repuesto/Serie en PDF */
    .rep-row input { 
        border: none; 
        padding: 0;
        font-size: 8px; /* Repuestos muy pequeños para ahorrar espacio */
    }
    .rep-row > div:first-child { border-right: 0.5pt solid #ccc; padding-right: 5px; }
    
    .rep-empty {
        display: block !important; /* Asegurar que se muestre si está vacío */
        font-size: 9px;
        color: #666;
        padding: 5px;
        border: 0.5pt solid #ccc;
        margin: 5px 0 10px 0;
        text-align: left;
    }

    /* Trabajo Realizado */
    .trab-desc {
        border: 0.5pt solid #ccc;
        padding: 5px;
        font-size: 9px;
        color: #000;
        line-height: 1.3;
        background: none;
    }
    .chk-grid { display: none; } /* Ocultar checkboxes en PDF */

    /* Observaciones */
    #obs {
        min-height: 30px; 
        max-height: 60px;
        border: 0.5pt solid #ccc; 
        padding: 4px; 
        font-size: 9px;
        overflow: hidden; /* Evitar que el textarea crezca demasiado */
    }

    /* Firmas (CRÍTICO: Sin línea decorativa y con línea de firma) */
    .footer { border-top: 1pt solid #ccc; }
    .firma-line { display: none; } /* Eliminar la línea decorativa de pantalla */
    .firmas { gap: 40px; }
    .firmas input {
        border: none;
        border-bottom: 1pt solid #000; /* Línea de firma real */
        margin-top: 15px; /* Espacio para la firma manuscrita */
        font-size: 9px;
    }
    .firmas label { margin-bottom: 0; }
  }
</style>
</head>
<body>

<div class="statusbar" id="statusbar" aria-live="polite">
  <strong id="statusTxt">Cargando...</strong>
  <span id="badge" class="badge" style="display:none;background:#f97316;color:#fff;padding:2px 6px;border-radius:10px;font-size:11px;">0</span>
  <button id="syncBtn" style="display:none;margin-left:6px;padding:4px 8px;border-radius:6px;border:none;background:#eef4ff;color:var(--blue);cursor:pointer;font-weight:bold;font-size:11px;">Sincronizar</button>
</div>

<div class="container" role="main">
  <header>
    <div class="logo"><img src="logo_realtech.png" alt="Realtech logo" onerror="this.style.display='none'"></div>
    <div class="brand">
      <h1>Realtech SpA — Orden de Servicio Técnico</h1>
      <p id="contact-info">RUT: 77.651.114-5 | Tel: <span id="tel-header">+56 9 1234 5678</span></p>
      <p>Arturo Prat 780 of 203A, Temuco</p>
      <p>realtech.spa@gmail.com</p>
    </div>
    <div class="meta">
      <div class="num" id="num">N° XXXX</div> 
      <div class="fecha">Emisión: <input type="date" id="fecha" /></div>
    </div>
  </header>

  <section>
    <div class="section-title"><h2>Información del Cliente</h2></div>
    <div class="grid" role="form" aria-label="Información del cliente">
      <div style="grid-column: 1/-1">
        <label for="cliNom">Cliente / Empresa</label>
        <input type="text" id="cliNom" list="cli-list" placeholder="Nombre del cliente..." autocomplete="off">
      </div>
      <div>
        <label for="cliRut">RUT</label>
        <input type="text" id="cliRut" placeholder="XX.XXX.XXX-X">
      </div>
      <div><label for="cliCiu">Ciudad</label><input type="text" id="cliCiu" placeholder="Ciudad"></div>

      <div style="grid-column: 1/-1"><label for="cliDir">Dirección</label><input type="text" id="cliDir" placeholder="Dirección"></div>
      
      <div><label for="cliCon">Contacto</label><input type="text" id="cliCon" placeholder="Atención a..."></div>
      <div><label for="cliTel">Teléfono</label><input type="text" id="cliTel" placeholder="+56 9 ..."></div>
      <div style="grid-column: 1/-1"><label for="cliMail">Email</label><input type="text" id="cliMail" placeholder="correo@ejemplo.com"></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Información del Equipo</h2></div>
    <div class="grid-eq">
      <div><label for="eqMarca">Marca Equipo</label><input type="text" id="eqMarca" list="marca-list" placeholder="Marca..." /></div>
      <div><label for="eqMod">Modelo</label><input type="text" id="eqMod" list="modelo-list" placeholder="Modelo" /></div>
      <div><label for="eqSer">Serie</label><input type="text" id="eqSer" placeholder="N° de serie" /></div>
      <div><label for="eqCond">Condición</label>
        <select id="eqCond">
          <option value="">Seleccionar...</option>
          <option value="Arriendo">Arriendo</option>
          <option value="Venta">Venta</option>
        </select>
      </div>
    </div>

    <div id="contadores" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div><label for="contBN">Contador B/N</label><input type="number" id="contBN" placeholder="0" min="0"></div>
      <div><label for="contColor">Contador Color</label><input type="number" id="contColor" placeholder="0" min="0"></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Repuestos Instalados</h2></div>
    <div class="exp">
      <div class="exp-hdr" onclick="toggle(this)">
        <strong>Repuestos instalados</strong>
        <span id="ri-count" style="color:var(--sub);margin-left:10px"></span>
      </div>
      <div class="exp-cnt" id="repInst" style="display:none">
        <div class="rep-empty" id="ri-empty">Sin repuestos instalados</div>
        <div class="rep-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="rep-nom" list="rep-list" 
                   placeholder="Nombre del repuesto" oninput="updateRepCount()">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="rep-ser" placeholder="N° Serie">
          </div>
          <div style="align-self:center">
            <button class="btn-del" onclick="delRep(this)">×</button>
          </div>
        </div>
      </div>
      <button type="button" class="btn-section-add" onclick="addRepInst()">
        + Agregar Repuesto Instalado
      </button>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Repuestos Retirados</h2></div>
    <div class="exp">
      <div class="exp-hdr" onclick="toggle(this)">
        <strong>Repuestos retirados</strong>
        <span id="rr-count" style="color:var(--sub);margin-left:10px"></span>
      </div>
      <div class="exp-cnt" id="repRet" style="display:none">
        <div class="rep-empty" id="rr-empty">Sin repuestos retirados</div>
        <div class="rep-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="rep-ret-nom" list="rep-list" 
                   placeholder="Nombre del repuesto" oninput="updateRepCount()">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="rep-ret-ser" placeholder="N° Serie">
          </div>
          <div style="align-self:center">
            <button class="btn-del" onclick="delRep(this)">×</button>
          </div>
        </div>
      </div>
      <button type="button" class="btn-section-add" onclick="addRepRet()">
        + Agregar Repuesto Retirado
      </button>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Trabajo Realizado</h2></div>
    <div class="exp">
      <div class="exp-cnt" style="display:block">
        <div class="chk-grid" id="trabChk" aria-live="polite"></div>
        <div class="trab-desc" id="trabDesc">No hay trabajos seleccionados</div>
      </div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Observaciones</h2></div>
    <textarea id="obs" placeholder="Detalles de la atención..."></textarea>
  </section>

  <div class="footer">
    <div class="firmas">
      <div>
        <label>Nombre Técnico</label>
        <input type="text" id="nomTec" list="tech-list" placeholder="Nombre completo">
        <div class="firma-line">Firma Técnico</div>
      </div>
      <div>
        <label>Nombre Cliente</label>
        <input type="text" id="nomCliFirma" placeholder="Nombre completo">
        <div class="firma-line">Firma Cliente</div>
      </div>
    </div>
  </div>
</div>

<datalist id="rep-list"></datalist>
<datalist id="cli-list"></datalist>
<datalist id="marca-list"></datalist>
<datalist id="modelo-list"></datalist>
<datalist id="tech-list"></datalist>

<div class="controls" role="region" aria-label="Controles">
  <button class="btn-blue" onclick="window.print()">Imprimir</button>
  <button class="btn-save" id="saveBtn" onclick="save()">GUARDAR</button>
</div>

<script>
/* ------------------ CONFIG ------------------ */
const URL = 'https://informes-realtech.realtech-spa.workers.dev/';
let isSyncing = false;
let isSaving = false; 

/* ------------------ IndexedDB Setup ------------------ */
let db = null;
let appState = {
  folio: 1, // Folio simple para el técnico actual (ej: 6)
  techId: null, // ID del técnico (ej: 1)
  techName: null // Nombre del técnico
};

const req = indexedDB.open('RealtechDB', 4);

req.onupgradeneeded = (e) => {
  const idb = e.target.result;
  if (!idb.objectStoreNames.contains('clientes')) idb.createObjectStore('clientes', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('marcas')) idb.createObjectStore('marcas', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('modelos')) idb.createObjectStore('modelos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('repuestos')) idb.createObjectStore('repuestos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('servicios')) idb.createObjectStore('servicios', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('ordenesPend')) idb.createObjectStore('ordenesPend', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('config')) idb.createObjectStore('config', { keyPath: 'key' });
  if (!idb.objectStoreNames.contains('tecnicos')) idb.createObjectStore('tecnicos', { keyPath: 'id' });
};

req.onsuccess = (e) => {
  db = e.target.result;
  initApp();
};

req.onerror = (e) => {
  console.error('Error inicializando IndexedDB', e);
  showStatus('Error DB', true);
};

/* --------- Helper DB functions (Promises) --------- */
function tx(store, mode = 'readonly'){
  return db.transaction(store, mode).objectStore(store);
}

function dbSet(store, value){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
function dbAdd(store, value){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').add(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
function dbGet(store, key){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').get(key);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => resolve(null);
  });
}
function dbGetAll(store){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').getAll();
    request.onsuccess = () => resolve(request.result || []);
    request.onerror = () => resolve([]);
  });
}
function dbDelete(store, key){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').delete(key);
      request.onsuccess = () => resolve(true);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
function dbDelAll(store){
  return new Promise((resolve) => {
    const request = tx(store, 'readwrite').clear();
    request.onsuccess = () => resolve(true);
    request.onerror = () => resolve(false);
  });
}

/* ------------------ UI helpers ------------------ */
function showStatus(text, isError=false){
  const el = document.getElementById('statusTxt');
  const badge = document.getElementById('badge');
  const syncBtn = document.getElementById('syncBtn');
  el.textContent = text;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
  if(isError){
    badge.style.display='none';
    syncBtn.style.display='none';
  }
}

function notif(msg, type='ok'){
  const el = document.getElementById('statusTxt');
  el.textContent = msg;
  el.style.color = type==='err' ? 'var(--danger)' : 'inherit';
  setTimeout(()=> updateStatus(), 3500);
}

// Muestra el número compuesto [ID_Técnico][Folio]
function renderNum(){
  const numPad = String(appState.folio).padStart(4,'0');
  const techPad = appState.techId ? String(appState.techId).padStart(2,'0') : 'XX';
  
  document.getElementById('num').textContent = `N° ${techPad}${numPad}`; 
}

/* ------------------ App init ------------------ */
async function initApp(){
  
  // set today's date if empty
  if(!document.getElementById('fecha').value) document.getElementById('fecha').value = new Date().toISOString().split('T')[0];

  // Evento de selección de Técnico
  document.getElementById('nomTec').addEventListener('change', onTechSelect);
  document.getElementById('cliNom').addEventListener('change', onClientSelect);
  document.getElementById('cliNom').addEventListener('input', ()=>{/* allow typing */});
  document.getElementById('syncBtn').addEventListener('click', sync);

  // Intentar cargar el último técnico y su folio si ya están guardados
  const lastTech = await dbGet('config', 'lastTech');
  if (lastTech && lastTech.id) {
    document.getElementById('nomTec').value = lastTech.name;
    await onTechSelect.call(document.getElementById('nomTec'));
  }
  
  // load data from local DB
  await loadLists();
  await loadServices();
  await renderPendingBadge();

  // try to sync from server to pull masters (incluye lista de técnicos y folios)
  syncServer();

  // connectivity events
  window.addEventListener('online', () => { updateStatus(); sync(); });
  window.addEventListener('offline', updateStatus);
  updateStatus();
  
  // Inicializa el número compuesto (puede ser N° XX0001 si no hay técnico)
  renderNum();

  // Inicializar contadores de repuestos
  updateRepCount();
}

// Manejador al seleccionar técnico
async function onTechSelect() {
  const name = this.value.trim();
  const techList = await dbGetAll('tecnicos');
  const selectedTech = techList.find(t => t.nombre === name);

  if (selectedTech) {
    appState.techId = selectedTech.id;
    appState.techName = selectedTech.nombre;
    
    await dbSet('config', { key: 'lastTech', id: appState.techId, name: appState.techName });
    await loadTechFolio(appState.techId);
  } else {
    appState.techId = null;
    appState.folio = 1;
    renderNum();
    if(name) notif('Técnico no reconocido. Sincronice la lista maestra.', 'err');
  }
}

// Carga el folio específico de un técnico
async function loadTechFolio(techId) {
    if (!techId) return;
    const key = `folio_${techId}`;
    const cfg = await dbGet('config', key);
    appState.folio = cfg ? (cfg.value || 1) : 1;
    renderNum();
}

/* ------------------ Load lists for datalist and services ------------------ */
async function loadLists(){
  const clientes = await dbGetAll('clientes');
  const marcas = await dbGetAll('marcas');
  const modelos = await dbGetAll('modelos');
  const reps = await dbGetAll('repuestos');
  const tecnicos = await dbGetAll('tecnicos');

  document.getElementById('cli-list').innerHTML = clientes.map(c => `<option value="${escapeHtml(c.nombre)}">`).join('');
  document.getElementById('marca-list').innerHTML = marcas.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('modelo-list').innerHTML = modelos.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('rep-list').innerHTML = reps.map(r => `<option value="${escapeHtml(r.nombre)}">`).join('');
  document.getElementById('tech-list').innerHTML = tecnicos.map(t => `<option value="${escapeHtml(t.nombre)}">`).join(''); 
}

async function loadServices(){
  const servicios = await dbGetAll('servicios');
  const container = document.getElementById('trabChk');
  container.innerHTML = '';
  servicios.forEach((s, i) => {
    const d = document.createElement('div');
    d.className = 'chk-item';
    const id = `srv-${s.id || i}`;
    const serviceValue = s.value || s; 
    d.innerHTML = `<input type="checkbox" id="${id}" value="${serviceValue}" onchange="updateTrab()">
                   <label for="${id}" style="margin:0;font-weight:500;width:100%">${escapeHtml(serviceValue)}</label>`;
    container.appendChild(d);
  });
  updateTrab();
}

/* ------------------ Autocomplete client selection ------------------ */
async function onClientSelect(){
  const nom = document.getElementById('cliNom').value.trim();
  if(!nom) return;
  const c = await dbGet('clientes', nom);
  if (c){
    document.getElementById('cliRut').value = c.rut || '';
    document.getElementById('cliDir').value = c.direccion || '';
    document.getElementById('cliCiu').value = c.ciudad || '';
    document.getElementById('cliCon').value = c.contacto || '';
    document.getElementById('cliMail').value = c.email || '';
    document.getElementById('cliTel').value = c.telefono || '';
    // Actualizar teléfono en el header de impresión si se carga del cliente (si es necesario)
    document.getElementById('tel-header').textContent = c.telefono || 'N/A';
  }
}

/* ------------------ Update trabajos resumen ------------------ */
function updateTrab(){
  const chk = document.querySelectorAll('#trabChk input:checked');
  const desc = document.getElementById('trabDesc');
  if(chk.length === 0){
    desc.textContent = 'No hay trabajos seleccionados';
    desc.style.color = 'var(--sub)';
  } else {
    desc.textContent = Array.from(chk).map(c => c.value).join(', ');
    desc.style.color = 'var(--text)';
  }
}

/* ------------------ Update Repuestos Count (NUEVO/MODIFICADO) ------------------ */
function updateRepCount() {
  // Contar repuestos instalados con datos
  const riRows = document.querySelectorAll('#repInst .rep-row');
  const riCount = Array.from(riRows).filter(r => 
    r.querySelector('.rep-nom')?.value.trim()
  ).length;
  
  // Contar repuestos retirados con datos
  const rrRows = document.querySelectorAll('#repRet .rep-row');
  const rrCount = Array.from(rrRows).filter(r => 
    r.querySelector('.rep-ret-nom')?.value.trim()
  ).length;
  
  // Actualizar contadores visibles
  document.getElementById('ri-count').textContent = riCount > 0 ? `(${riCount})` : '';
  document.getElementById('rr-count').textContent = rrCount > 0 ? `(${rrCount})` : '';
  
  // Mostrar/ocultar mensajes "Sin repuestos..."
  document.getElementById('ri-empty').style.display = riCount > 0 ? 'none' : 'block';
  document.getElementById('rr-empty').style.display = rrCount > 0 ? 'none' : 'block';
}

/* ------------------ Add / remove repuestos rows (MODIFICADO) ------------------ */
function delRep(button) {
  button.closest('.rep-row').remove();
  updateRepCount();
}

function addRepInst(){
  const container = document.getElementById('repInst');
  const rows = container.querySelectorAll('.rep-row').length;
  if (rows >= 20) { notif('Máximo 20 repuestos', 'err'); return; }
  
  const row = document.createElement('div');
  row.className = 'rep-row';
  row.innerHTML = `
    <div>
      <label>Repuesto</label>
      <input type="text" class="rep-nom" list="rep-list" 
             placeholder="Nombre repuesto" oninput="updateRepCount()">
    </div>
    <div>
      <label>Serie</label>
      <input type="text" class="rep-ser" placeholder="N° Serie">
    </div>
    <div style="align-self:center">
      <button class="btn-del" onclick="delRep(this)">×</button>
    </div>
  `;
  container.appendChild(row);
  updateRepCount();
}

function addRepRet(){
  const container = document.getElementById('repRet');
  const rows = container.querySelectorAll('.rep-row').length;
  if (rows >= 20) { notif('Máximo 20 repuestos', 'err'); return; }
  
  const row = document.createElement('div');
  row.className = 'rep-row';
  row.innerHTML = `
    <div>
      <label>Repuesto</label>
      <input type="text" class="rep-ret-nom" list="rep-list" 
             placeholder="Nombre repuesto" oninput="updateRepCount()">
    </div>
    <div>
      <label>Serie</label>
      <input type="text" class="rep-ret-ser" placeholder="N° Serie">
    </div>
    <div style="align-self:center">
      <button class="btn-del" onclick="delRep(this)">×</button>
    </div>
  `;
  container.appendChild(row);
  updateRepCount();
}

/* ------------------ Save / Persist functions (INTACTAS) ------------------ */
async function saveClienteIfNew(cliObj){
  if(!cliObj || !cliObj.nombre) return;
  const exists = await dbGet('clientes', cliObj.nombre);
  await dbSet('clientes', Object.assign({}, exists || {}, cliObj));
  await loadLists();
}
async function saveMarcaIfNew(marca){
  if(!marca) return;
  const exists = await dbGet('marcas', marca);
  if(!exists) await dbSet('marcas', { nombre: marca });
  await loadLists();
}
async function saveModeloIfNew(mod){
  if(!mod) return;
  const exists = await dbGet('modelos', mod);
  if(!exists) await dbSet('modelos', { nombre: mod });
  await loadLists();
}
async function saveRepIfNew(r){
  if(!r) return;
  const exists = await dbGet('repuestos', r);
  if(!exists) await dbSet('repuestos', { nombre: r });
  await loadLists();
}

/* ------------------ Save order (offline-first) ------------------ */
async function save(){
  const saveBtn = document.getElementById('saveBtn');
  
  if (isSaving || saveBtn.disabled) return;

  isSaving = true;
  saveBtn.disabled = true;

  try {
    if (!appState.techId) {
      notif('Debe seleccionar su Nombre Técnico para generar el folio.', 'err');
      return;
    }
    
    const cliNom = document.getElementById('cliNom').value.trim();
    if(!cliNom){ notif('Ingrese el nombre del cliente', 'err'); return; }

    const folioActual = String(appState.folio).padStart(4,'0');
    const techPrefijo = String(appState.techId).padStart(2,'0');
    const correlativoCompleto = techPrefijo + folioActual;

    const cliData = {
      nombre: cliNom,
      rut: document.getElementById('cliRut').value.trim(),
      direccion: document.getElementById('cliDir').value.trim(),
      ciudad: document.getElementById('cliCiu').value.trim(),
      contacto: document.getElementById('cliCon').value.trim(),
      email: document.getElementById('cliMail').value.trim(),
      telefono: document.getElementById('cliTel').value.trim()
    };
    await saveClienteIfNew(cliData);

    const repInst = Array.from(document.querySelectorAll('#repInst .rep-row')).map(r => {
      return {
        nombre: (r.querySelector('.rep-nom')?.value || '').trim(),
        serie: (r.querySelector('.rep-ser')?.value || '').trim()
      };
    }).filter(x => x.nombre);
    const repRet = Array.from(document.querySelectorAll('#repRet .rep-row')).map(r => {
      return {
        nombre: (r.querySelector('.rep-ret-nom')?.value || '').trim(),
        serie: (r.querySelector('.rep-ret-ser')?.value || '').trim()
      };
    }).filter(x => x.nombre);

    const trab = Array.from(document.querySelectorAll('#trabChk input:checked')).map(cb => cb.value);

    const orden = {
      numero: correlativoCompleto, 
      fecha: document.getElementById('fecha').value || new Date().toISOString().split('T')[0],
      cliente: cliData,
      equipo: {
        marca: document.getElementById('eqMarca').value.trim(),
        modelo: document.getElementById('eqMod').value.trim(),
        serie: document.getElementById('eqSer').value.trim(),
        condicion: document.getElementById('eqCond').value
      },
      contadores: {
        bn: document.getElementById('contBN').value || '0',
        color: document.getElementById('contColor').value || '0'
      },
      repInst, repRet, trab,
      obs: document.getElementById('obs').value.trim(),
      extra: { 
        tecnico: appState.techName, 
        clienteFirma: document.getElementById('nomCliFirma').value.trim(),
        idTecnico: appState.techId,
        folioTecnico: appState.folio
      }
    };

    if(orden.equipo.marca) await saveMarcaIfNew(orden.equipo.marca);
    if(orden.equipo.modelo) await saveModeloIfNew(orden.equipo.modelo);
    repInst.forEach(r => { if(r.nombre) saveRepIfNew(r.nombre); });
    repRet.forEach(r => { if(r.nombre) saveRepIfNew(r.nombre); });

    await dbAdd('ordenesPend', orden);

    appState.folio++;
    const newFolioKey = `folio_${appState.techId}`;
    await dbSet('config', { key: newFolioKey, value: appState.folio });
    
    renderNum();

    notif(`Orden N°${correlativoCompleto} guardada`, 'ok');
    renderPendingBadge();
    
    // Limpiar campos
    document.querySelectorAll('input:not(#fecha):not(#nomTec):not(#num), textarea, select').forEach(i => {
      if(i.type === 'select-one') i.value = ''; else i.value = '';
    });
    // Limpiar repuestos, dejando solo una fila por sección
    document.querySelectorAll('#repInst .rep-row, #repRet .rep-row').forEach((r, i) => { 
        if (i > 0) r.remove(); 
        r.querySelectorAll('input').forEach(i => i.value = '');
    });
    document.querySelectorAll('#trabChk input').forEach(c => c.checked = false);
    updateTrab();
    updateRepCount(); // Actualizar el estado de "Sin repuestos"

    if(navigator.onLine) await sync();
  
  } catch (e) {
    console.error("Error al guardar la orden:", e);
    notif('Error crítico al guardar. Consulte la consola.', 'err');
  } finally {
    isSaving = false;
    saveBtn.disabled = false;
  }
}

/* ------------------ Sync logic (INTACTA) ------------------ */
async function renderPendingBadge(){
  const pend = await dbGetAll('ordenesPend');
  const badge = document.getElementById('badge');
  const syncBtn = document.getElementById('syncBtn');
  if(pend.length > 0){
    badge.textContent = pend.length;
    badge.style.display = 'inline-block';
    syncBtn.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
    syncBtn.style.display = 'none';
  }
}

async function sync(){
  if(isSyncing) return;
  if(!navigator.onLine) { notif('Sin conexión — pendiente', 'err'); return; }
  const pend = await dbGetAll('ordenesPend');
  if(pend.length === 0){ notif('No hay órdenes pendientes', 'ok'); return; }

  isSyncing = true;
  showStatus('Sincronizando...');
  let successes = 0, failures = 0;
  
  try {
    for(const o of pend){
      try {
        const res = await fetch(URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'saveOrden', data: o })
        });
        const json = await res.json();
        if(json && json.success){
          await dbDelete('ordenesPend', o.id);
          successes++;
        } else {
          failures++;
          console.warn('Fallo server', o, json);
        }
      } catch (e){
        failures++;
        console.warn('Error enviando', e);
      }
    }
  } finally {
    isSyncing = false;
  }

  await renderPendingBadge();
  showStatus('Conectado');
  if(successes > 0) notif(`Enviadas ${successes} órdenes`, 'ok');
  if(failures > 0) notif(`${failures} fallidas`, 'err');
}

/* Pull masters from Google Sheet (loadData) */
async function syncServer(){
  if(!navigator.onLine) { showStatus('Offline'); return; }
  try {
    showStatus('Actualizando...');
    const r = await fetch(`${URL}?action=loadData&techId=${appState.techId || ''}`);
    const data = await r.json();
    if(!data.success){ showStatus('Sin datos server'); return; }

    if(Array.isArray(data.tecnicos)) { 
      await dbDelAll('tecnicos');
      for(const t of data.tecnicos) await dbSet('tecnicos', t); 
    }
    
    if(Array.isArray(data.cli)) {
      for(const c of data.cli){
        if(!c || !c.nombre) continue;
        await dbSet('clientes', c);
      }
    }
    if(Array.isArray(data.marcas)) for(const m of data.marcas) await dbSet('marcas',{nombre:m});
    if(Array.isArray(data.modelos)) for(const m of data.modelos) await dbSet('modelos',{nombre:m});
    if(Array.isArray(data.reps)) for(const r of data.reps) await dbSet('repuestos',{nombre:r});
    if(Array.isArray(data.servs)){
      await dbDelAll('servicios');
      for(const s of data.servs) await dbAdd('servicios', { value: s });
    }
    
    if(appState.techId && data.lastNumTech){
        const serverNum = parseInt(data.lastNumTech, 10);
        const folioKey = `folio_${appState.techId}`;
        
        if(!isNaN(serverNum) && serverNum >= appState.folio){
           appState.folio = serverNum + 1;
           await dbSet('config', { key: folioKey, value: appState.folio });
           renderNum();
           notif(`Folio de ${appState.techName} actualizado.`, 'ok');
        }
    }

    await loadLists();
    await loadServices();
    showStatus('Actualizado');
  } catch (e){
    console.warn('syncServer error', e);
    showStatus('Error de conexión', true);
  }
}

/* ------------------ Utilities (MODIFICADO TOGGLE) ------------------ */
function toggle(hdr){ 
    const cnt = hdr.nextElementSibling; 
    if(!cnt) return; 
    // Usar el estilo inline para forzar el cambio
    cnt.style.display = (cnt.style.display === 'none' || cnt.style.display === '') ? 'block' : 'none'; 
}
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* ------------------ Status & connectivity ------------------ */
function updateStatus(){
  if(navigator.onLine){ showStatus('Conectado'); } else { showStatus('Offline', true); }
}

/* ------------------ Small UX: autosave marca/modelo/repuesto on leave ------------------ */
document.addEventListener('focusout', async (e) => {
  const t = e.target;
  if(t.id === 'eqMarca' && t.value.trim()) await saveMarcaIfNew(t.value.trim());
  if(t.id === 'eqMod' && t.value.trim()) await saveModeloIfNew(t.value.trim());
  // Repuestos: oninput también llama a updateRepCount, focusout solo guarda la lista maestra.
  if((t.classList.contains('rep-nom') || t.classList.contains('rep-ret-nom')) && t.value.trim()) await saveRepIfNew(t.value.trim());
});

window.addEventListener('DOMContentLoaded', () => {
  // CRÍTICO: "Trabajo Realizado" (exp-cnt anterior) debe estar en display:block (ya lo está)
  // CRÍTICO: Repuestos deben empezar colapsados (display:none en el HTML) y se expandirán con toggle si se hace click.
  document.querySelectorAll('.exp-cnt').forEach(c => {
      // Dejar 'Trabajo Realizado' expandido (trabDesc)
      if(c.id !== 'repInst' && c.id !== 'repRet') c.style.display = 'block'; 
  });
});
</script>

</body>
</html>
