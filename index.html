<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Orden de Servicio Técnico - Realtech SpA</title>
<link rel="icon" href="logo_realtech.png" />
<style>
  /* --------- Diseño base mejorado (opción B) --------- */
  :root{
    --blue:#004a99;
    --muted:#f5f7fb;
    --accent:#38a169;
    --danger:#c53030;
    --card:#ffffff;
    --text:#222;
    --sub:#666;
    --radius:10px;
    --gap:10px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
    background:linear-gradient(180deg,#f2f6fb 0%, #eef4fb 100%);
    color:var(--text);
    padding:20px;
    display:flex;
    justify-content:center;
  }
  .container{
    width:100%;
    max-width:980px;
    background:var(--card);
    border-radius:12px;
    box-shadow:0 8px 30px rgba(30,50,90,0.08);
    padding:18px;
    overflow:hidden;
  }

  header{display:flex;gap:16px;align-items:center;margin-bottom:12px}
  .logo img{width:84px;height:auto;border-radius:6px}
  .brand{flex:1}
  .brand h1{margin:0;font-size:18px;color:var(--blue)}
  .brand p{margin:2px 0 0;font-size:12px;color:var(--sub)}
  .meta{text-align:right;min-width:150px}
  .meta .num{font-weight:800;color:var(--blue);font-size:14px}
  .meta .fecha{font-size:12px;color:var(--sub);margin-top:6px}

  .grid{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    gap:12px;
    margin-bottom:12px;
  }
  .grid-eq{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  label{display:block;font-size:11px;color:var(--blue);font-weight:700;margin-bottom:6px}
  input[type="text"],input[type="date"],input[type="number"],textarea,select{
    width:100%;
    padding:9px 10px;
    border:1px solid #e6eef9;
    border-radius:8px;
    background:#fff;
    font-size:13px;
    color:var(--text);
    outline:none;
    transition:box-shadow .12s, border-color .12s;
  }
  input:focus,textarea:focus,select:focus{box-shadow:0 6px 18px rgba(0,74,153,0.06);border-color:var(--blue)}
  textarea{min-height:72px;resize:vertical;padding-top:10px}
  .section-title{display:flex;align-items:center;gap:8px;margin:18px 0 6px}
  .section-title h2{margin:0;font-size:13px;background:linear-gradient(90deg,#f6f9ff,#fff);padding:8px 12px;border-radius:8px;border-left:4px solid var(--blue);font-weight:800;color:var(--blue)}

  .exp{background:var(--muted);padding:10px;border-radius:8px;border:1px solid rgba(0,74,153,0.04);margin-bottom:12px}
  .exp .exp-hdr{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:6px 8px;border-radius:6px}
  .exp-cnt{margin-top:8px}
  .rep-row{display:grid;grid-template-columns:1fr 160px 40px;gap:8px;align-items:end;margin-bottom:8px}
  .rep-row label{margin-bottom:4px}
  .rep-row .btn-del{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px;border-radius:6px;cursor:pointer}

  .chk-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .chk-item{display:flex;align-items:center;gap:8px;padding:6px;background:#fff;border-radius:8px;border:1px solid rgba(0,0,0,0.03)}
  .trab-desc{margin-top:8px;padding:10px;border-radius:8px;background:#fff;border:1px solid rgba(0,0,0,0.03);min-height:48px;color:var(--sub)}

  .footer{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:12px}
  .firmas{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%}
  .firma-line{margin-top:14px;border-top:1px solid #dfe8f8;padding-top:8px;font-size:12px;color:var(--sub);text-align:center;font-weight:700}

  .controls{position:fixed;right:22px;bottom:22px;display:flex;flex-direction:column;gap:10px;z-index:999}
  .controls button{min-width:150px;padding:12px 14px;border-radius:12px;border:none;font-weight:800;cursor:pointer;box-shadow:0 12px 30px rgba(4,20,60,0.08)}
  .btn-save{background:var(--accent);color:#fff}
  .btn-blue{background:var(--blue);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}

  .statusbar{position:fixed;left:20px;top:18px;background:var(--card);padding:8px 12px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);box-shadow:0 8px 20px rgba(17,24,39,0.05);display:flex;gap:10px;align-items:center}
  .badge{background:#f97316;color:#fff;padding:4px 8px;border-radius:999px;font-weight:800;display:inline-block}

  @media (max-width:880px){
    .grid{grid-template-columns:1fr;gap:10px}
    .grid-eq{grid-template-columns:1fr 1fr;gap:10px}
    .rep-row{grid-template-columns:1fr 1fr 40px}
    .controls{position:static;flex-direction:row;justify-content:center;padding:12px 0;gap:8px;margin-top:12px}
    .container{padding:14px}
  }
  @media print{
    body{background:#fff}
    .controls,.statusbar{display:none}
    .container{box-shadow:none;border-radius:0}
  }
</style>
</head>
<body>

<div class="statusbar" id="statusbar" aria-live="polite">
  <strong id="statusTxt">Cargando...</strong>
  <span id="badge" class="badge" style="display:none">0</span>
  <button id="syncBtn" style="display:none;margin-left:6px;padding:6px 10px;border-radius:8px;border:none;background:#eef4ff;color:var(--blue);cursor:pointer">Sincronizar</button>
</div>

<div class="container" role="main">
  <header>
    <div class="logo"><img src="logo_realtech.png" alt="Realtech logo" onerror="this.style.display='none'"></div>
    <div class="brand">
      <h1>Realtech SpA — Orden de Servicio Técnico</h1>
      <p>RUT: 77.651.114-5 — Arturo Prat 780 of 203A, Temuco — realtech.spa@gmail.com</p>
    </div>
    <div class="meta">
      <div class="num" id="num">N° 0001</div>
      <div class="fecha">Emisión: <input type="date" id="fecha" /></div>
    </div>
  </header>

  <section>
    <div class="section-title"><h2>Información del Cliente</h2></div>
    <div class="grid" role="form" aria-label="Información del cliente">
      <div style="grid-column:span 2">
        <label for="cliNom">Cliente / Empresa</label>
        <input type="text" id="cliNom" list="cli-list" placeholder="Nombre del cliente..." autocomplete="off">
      </div>
      <div>
        <label for="cliRut">RUT</label>
        <input type="text" id="cliRut" placeholder="XX.XXX.XXX-X">
      </div>

      <div><label for="cliDir">Dirección</label><input type="text" id="cliDir" placeholder="Dirección"></div>
      <div><label for="cliCiu">Ciudad</label><input type="text" id="cliCiu" placeholder="Ciudad"></div>
      <div><label for="cliCon">Contacto</label><input type="text" id="cliCon" placeholder="Atención a..."></div>
      <div><label for="cliMail">Email</label><input type="text" id="cliMail" placeholder="correo@ejemplo.com"></div>
      <div><label for="cliTel">Teléfono</label><input type="text" id="cliTel" placeholder="+56 9 ..."></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Información del Equipo</h2></div>
    <div class="grid-eq">
      <div><label for="eqMarca">Marca Equipo</label><input type="text" id="eqMarca" list="marca-list" placeholder="Marca..." /></div>
      <div><label for="eqMod">Modelo</label><input type="text" id="eqMod" list="modelo-list" placeholder="Modelo" /></div>
      <div><label for="eqSer">Serie</label><input type="text" id="eqSer" placeholder="N° de serie" /></div>
      <div><label for="eqCond">Condición</label>
        <select id="eqCond">
          <option value="">Seleccionar...</option>
          <option value="Arriendo">Arriendo</option>
          <option value="Venta">Venta</option>
        </select>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div><label for="contBN">Contador B/N</label><input type="number" id="contBN" placeholder="0" min="0"></div>
      <div><label for="contColor">Contador Color</label><input type="number" id="contColor" placeholder="0" min="0"></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Repuestos Instalados</h2></div>
    <div class="exp">
      <div class="exp-hdr" onclick="toggle(this)"><strong>Repuestos instalados</strong><span id="ri-count" style="color:var(--sub)"></span></div>
      <div class="exp-cnt" id="repInst">
        <div class="rep-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="rep-nom" list="rep-list" placeholder="Nombre del repuesto">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="rep-ser" placeholder="N° Serie">
          </div>
          <div style="align-self:center">
            <button class="btn-ghost btn-del" onclick="this.parentElement.parentElement.remove()">X</button>
          </div>
        </div>
      </div>
      <div style="margin-top:8px"><button class="btn-ghost" onclick="addRepInst()">+ Agregar repuesto</button></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Repuestos Retirados</h2></div>
    <div class="exp">
      <div class="exp-hdr" onclick="toggle(this)"><strong>Repuestos retirados</strong></div>
      <div class="exp-cnt" id="repRet">
        <div class="rep-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="rep-ret-nom" list="rep-list" placeholder="Nombre del repuesto">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="rep-ret-ser" placeholder="N° Serie">
          </div>
          <div style="align-self:center">
            <button class="btn-ghost btn-del" onclick="this.parentElement.parentElement.remove()">X</button>
          </div>
        </div>
      </div>
      <div style="margin-top:8px"><button class="btn-ghost" onclick="addRepRet()">+ Agregar repuesto</button></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Trabajo Realizado</h2></div>
    <div class="exp">
      <div class="exp-cnt">
        <div class="chk-grid" id="trabChk" aria-live="polite"></div>
        <div class="trab-desc" id="trabDesc">No hay trabajos seleccionados</div>
      </div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Observaciones</h2></div>
    <textarea id="obs" placeholder="Detalles de la atención..."></textarea>
  </section>

  <div class="footer">
    <div class="firmas">
      <div>
        <label>Nombre Técnico</label>
        <input type="text" id="nomTec" placeholder="Nombre completo del técnico">
        <div class="firma-line">Firma Técnico</div>
      </div>
      <div>
        <label>Nombre Cliente</label>
        <input type="text" id="nomCliFirma" placeholder="Nombre completo del cliente">
        <div class="firma-line">Firma Cliente</div>
      </div>
    </div>
  </div>
</div>

<!-- Datalists -->
<datalist id="rep-list"></datalist>
<datalist id="cli-list"></datalist>
<datalist id="marca-list"></datalist>
<datalist id="modelo-list"></datalist>

<!-- Controles flotantes -->
<div class="controls" role="region" aria-label="Controles">
  <button class="btn-ghost" onclick="addRepInst()">+ Rep. Instalado</button>
  <button class="btn-ghost" onclick="addRepRet()">+ Rep. Retirado</button>
  <button class="btn-save" onclick="save()">Guardar</button>
  <button class="btn-blue" onclick="window.print()">Imprimir</button>
</div>

<script>
/* ------------------ CONFIG ------------------ */
/* Reemplaza la URL si cambias tu Apps Script */
const URL = 'https://script.google.com/macros/s/AKfycbz1ThVoL2EOjk7jYiZeoQd8eNY6w8sAFeeMxTVNwL6b7uLrSgk93vQnEps5v6ucAXdU/exec';
/* ------------------ IndexedDB Setup ------------------ */
let db = null;
let appState = {
  num: 1
};

const req = indexedDB.open('RealtechDB', 2);

req.onupgradeneeded = (e) => {
  const idb = e.target.result;
  if (!idb.objectStoreNames.contains('clientes')) idb.createObjectStore('clientes', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('marcas')) idb.createObjectStore('marcas', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('modelos')) idb.createObjectStore('modelos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('repuestos')) idb.createObjectStore('repuestos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('servicios')) idb.createObjectStore('servicios', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('ordenesPend')) idb.createObjectStore('ordenesPend', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('config')) idb.createObjectStore('config', { keyPath: 'key' });
};

req.onsuccess = (e) => {
  db = e.target.result;
  initApp();
};

req.onerror = (e) => {
  console.error('Error inicializando IndexedDB', e);
  showStatus('Error DB', true);
};

/* --------- Helper DB functions (Promises) --------- */
function tx(store, mode = 'readonly'){
  return db.transaction(store, mode).objectStore(store);
}

function dbSet(store, value){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
function dbAdd(store, value){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').add(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
function dbGet(store, key){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').get(key);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => resolve(null);
  });
}
function dbGetAll(store){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').getAll();
    request.onsuccess = () => resolve(request.result || []);
    request.onerror = () => resolve([]);
  });
}
function dbDelete(store, key){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').delete(key);
      request.onsuccess = () => resolve(true);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}

/* ------------------ UI helpers ------------------ */
function showStatus(text, isError=false){
  const el = document.getElementById('statusTxt');
  const badge = document.getElementById('badge');
  const syncBtn = document.getElementById('syncBtn');
  el.textContent = text;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
  if(isError){
    badge.style.display='none';
    syncBtn.style.display='none';
  }
}

function notif(msg, type='ok'){
  // simple accessible notification via statusbar temporarily
  const el = document.getElementById('statusTxt');
  el.textContent = msg;
  el.style.color = type==='err' ? 'var(--danger)' : 'inherit';
  setTimeout(()=> updateStatus(), 3500);
}

/* ------------------ App init ------------------ */
async function initApp(){
  // load config
  const cfg = await dbGet('config', 'num');
  appState.num = cfg ? (cfg.value || 1) : 1;
  document.getElementById('num').textContent = `N° ${String(appState.num).padStart(4,'0')}`;
  // set today's date if empty
  if(!document.getElementById('fecha').value) document.getElementById('fecha').value = new Date().toISOString().split('T')[0];

  // wire events
  document.getElementById('cliNom').addEventListener('change', onClientSelect);
  document.getElementById('cliNom').addEventListener('input', ()=>{/* allow typing */});
  document.getElementById('syncBtn').addEventListener('click', sync);

  // load data from local DB
  await loadLists();
  await loadServices();
  await renderPendingBadge();

  // try to sync from server to pull masters
  syncServer();

  // connectivity events
  window.addEventListener('online', () => { updateStatus(); sync(); });
  window.addEventListener('offline', updateStatus);
  updateStatus();
}

/* ------------------ Load lists for datalist and services ------------------ */
async function loadLists(){
  const clientes = await dbGetAll('clientes');
  const marcas = await dbGetAll('marcas');
  const modelos = await dbGetAll('modelos');
  const reps = await dbGetAll('repuestos');

  document.getElementById('cli-list').innerHTML = clientes.map(c => `<option value="${escapeHtml(c.nombre)}">`).join('');
  document.getElementById('marca-list').innerHTML = marcas.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('modelo-list').innerHTML = modelos.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('rep-list').innerHTML = reps.map(r => `<option value="${escapeHtml(r.nombre)}">`).join('');
}

async function loadServices(){
  const servicios = await dbGetAll('servicios');
  const container = document.getElementById('trabChk');
  container.innerHTML = '';
  servicios.forEach((s, i) => {
    const d = document.createElement('div');
    d.className = 'chk-item';
    const id = `srv-${s.id || i}`;
    d.innerHTML = `<input type="checkbox" id="${id}" value="${s.value || s}" onchange="updateTrab()">
                   <label for="${id}" style="margin:0;font-weight:500">${escapeHtml(s.value || s)}</label>`;
    container.appendChild(d);
  });
  updateTrab();
}

/* ------------------ Autocomplete client selection ------------------ */
async function onClientSelect(){
  const nom = document.getElementById('cliNom').value.trim();
  if(!nom) return;
  const c = await dbGet('clientes', nom);
  if (c){
    document.getElementById('cliRut').value = c.rut || '';
    document.getElementById('cliDir').value = c.direccion || '';
    document.getElementById('cliCiu').value = c.ciudad || '';
    document.getElementById('cliCon').value = c.contacto || '';
    document.getElementById('cliMail').value = c.email || '';
    document.getElementById('cliTel').value = c.telefono || '';
  }
}

/* ------------------ Update trabajos resumen ------------------ */
function updateTrab(){
  const chk = document.querySelectorAll('#trabChk input:checked');
  const desc = document.getElementById('trabDesc');
  if(chk.length === 0){
    desc.textContent = 'No hay trabajos seleccionados';
    desc.style.color = 'var(--sub)';
  } else {
    desc.textContent = Array.from(chk).map(c => c.value).join(', ');
    desc.style.color = 'var(--text)';
  }
}

/* ------------------ Add / remove repuestos rows ------------------ */
function addRepInst(){
  const c = document.getElementById('repInst');
  const rows = c.querySelectorAll('.rep-row').length;
  if(rows >= 20){ notif('Máximo 20 repuestos', 'err'); return; }
  const d = document.createElement('div');
  d.className = 'rep-row';
  d.innerHTML = `<div><label>Repuesto</label><input type="text" class="rep-nom" list="rep-list" placeholder="Nombre del repuesto"></div>
                 <div><label>Serie</label><input type="text" class="rep-ser" placeholder="N° Serie"></div>
                 <div style="align-self:center"><button class="btn-ghost btn-del" onclick="this.closest('.rep-row').remove()">X</button></div>`;
  c.appendChild(d);
}
function addRepRet(){
  const c = document.getElementById('repRet');
  const rows = c.querySelectorAll('.rep-row').length;
  if(rows >= 20){ notif('Máximo 20 repuestos', 'err'); return; }
  const d = document.createElement('div');
  d.className = 'rep-row';
  d.innerHTML = `<div><label>Repuesto</label><input type="text" class="rep-ret-nom" list="rep-list" placeholder="Nombre del repuesto"></div>
                 <div><label>Serie</label><input type="text" class="rep-ret-ser" placeholder="N° Serie"></div>
                 <div style="align-self:center"><button class="btn-ghost btn-del" onclick="this.closest('.rep-row').remove()">X</button></div>`;
  c.appendChild(d);
}

/* ------------------ Save / Persist functions ------------------ */
function fmtRutInput(input){
  let v = input.replace(/[^0-9kK]/g,'');
  if(v.length === 0) return '';
  let c = v.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  let dv = v.slice(-1).toUpperCase();
  return c ? `${c}-${dv}` : '';
}

async function saveClienteIfNew(cliObj){
  if(!cliObj || !cliObj.nombre) return;
  const exists = await dbGet('clientes', cliObj.nombre);
  await dbSet('clientes', Object.assign({}, exists || {}, cliObj));
  await loadLists();
}

async function saveMarcaIfNew(marca){
  if(!marca) return;
  const exists = await dbGet('marcas', marca);
  if(!exists) await dbSet('marcas', { nombre: marca });
  await loadLists();
}
async function saveModeloIfNew(mod){
  if(!mod) return;
  const exists = await dbGet('modelos', mod);
  if(!exists) await dbSet('modelos', { nombre: mod });
  await loadLists();
}
async function saveRepIfNew(r){
  if(!r) return;
  const exists = await dbGet('repuestos', r);
  if(!exists) await dbSet('repuestos', { nombre: r });
  await loadLists();
}

/* ------------------ Save order (offline-first) ------------------ */
async function save(){
  const cliNom = document.getElementById('cliNom').value.trim();
  if(!cliNom){ notif('Ingrese el nombre del cliente', 'err'); return; }

  // Prepare client object & persist if new
  const cliData = {
    nombre: cliNom,
    rut: document.getElementById('cliRut').value.trim(),
    direccion: document.getElementById('cliDir').value.trim(),
    ciudad: document.getElementById('cliCiu').value.trim(),
    contacto: document.getElementById('cliCon').value.trim(),
    email: document.getElementById('cliMail').value.trim(),
    telefono: document.getElementById('cliTel').value.trim()
  };
  await saveClienteIfNew(cliData);

  // Collect repuestos instalados
  const repInst = Array.from(document.querySelectorAll('#repInst .rep-row')).map(r => {
    return {
      nombre: (r.querySelector('.rep-nom')?.value || '').trim(),
      serie: (r.querySelector('.rep-ser')?.value || '').trim()
    };
  }).filter(x => x.nombre);

  // Repuestos retirados
  const repRet = Array.from(document.querySelectorAll('#repRet .rep-row')).map(r => {
    return {
      nombre: (r.querySelector('.rep-ret-nom')?.value || '').trim(),
      serie: (r.querySelector('.rep-ret-ser')?.value || '').trim()
    };
  }).filter(x => x.nombre);

  // Trabajos
  const trab = Array.from(document.querySelectorAll('#trabChk input:checked')).map(cb => cb.value);

  // Equipo
  const orden = {
    numero: appState.num,
    fecha: document.getElementById('fecha').value || new Date().toISOString().split('T')[0],
    cliente: cliData,
    equipo: {
      marca: document.getElementById('eqMarca').value.trim(),
      modelo: document.getElementById('eqMod').value.trim(),
      serie: document.getElementById('eqSer').value.trim(),
      condicion: document.getElementById('eqCond').value
    },
    contadores: {
      bn: document.getElementById('contBN').value || '0',
      color: document.getElementById('contColor').value || '0'
    },
    repInst, repRet, trab,
    obs: document.getElementById('obs').value.trim(),
    extra: { tecnico: document.getElementById('nomTec').value.trim(), clienteFirma: document.getElementById('nomCliFirma').value.trim() }
  };

  // Save reuso: add marca/modelo/repuestos to master lists
  if(orden.equipo.marca) await saveMarcaIfNew(orden.equipo.marca);
  if(orden.equipo.modelo) await saveModeloIfNew(orden.equipo.modelo);
  repInst.forEach(r => { if(r.nombre) saveRepIfNew(r.nombre); });
  repRet.forEach(r => { if(r.nombre) saveRepIfNew(r.nombre); });

  // Save order to ordenesPend (offline queue)
  await dbAdd('ordenesPend', orden);

  // increment and persist number
  appState.num++;
  await dbSet('config', { key: 'num', value: appState.num });
  document.getElementById('num').textContent = `N° ${String(appState.num).padStart(4,'0')}`;

  notif(`Orden N°${String(orden.numero).padStart(4,'0')} guardada (offline)`, 'ok');
  renderPendingBadge();

  // Try sync immediately if online
  if(navigator.onLine) await sync();
}

/* ------------------ Sync logic ------------------ */
async function renderPendingBadge(){
  const pend = await dbGetAll('ordenesPend');
  const badge = document.getElementById('badge');
  const syncBtn = document.getElementById('syncBtn');
  if(pend.length > 0){
    badge.textContent = pend.length;
    badge.style.display = 'inline-block';
    syncBtn.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
    syncBtn.style.display = 'none';
  }
}

async function sync(){
  if(!navigator.onLine) { notif('Sin conexión — sincronización pendiente', 'err'); return; }
  const pend = await dbGetAll('ordenesPend');
  if(pend.length === 0){ notif('No hay órdenes pendientes', 'ok'); return; }

  showStatus('Sincronizando...');
  let successes = 0, failures = 0;

  for(const o of pend){
    try {
      const res = await fetch(URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ action: 'saveOrden', data: o })
      });
      const json = await res.json();
      if(json && json.success){
        await dbDelete('ordenesPend', o.id);
        successes++;
      } else {
        failures++;
        console.warn('Fallo server para orden', o, json);
      }
    } catch (e){
      failures++;
      console.warn('Error enviando orden', e);
    }
  }

  await renderPendingBadge();
  showStatus('Conectado');
  if(successes > 0) notif(`Enviadas ${successes} órdenes`, 'ok');
  if(failures > 0) notif(`${failures} fallidas`, 'err');
}

/* Pull masters from Google Sheet (loadData) */
async function syncServer(){
  if(!navigator.onLine) { showStatus('Sin conexión - trabajando offline'); return; }
  try {
    showStatus('Actualizando datos desde servidor...');
    const r = await fetch(`${URL}?action=loadData`);
    const data = await r.json();
    if(!data.success){ showStatus('No hay datos del servidor'); return; }

    // merge clients
    if(Array.isArray(data.cli)) {
      for(const c of data.cli){
        if(!c || !c.nombre) continue;
        await dbSet('clientes', c);
      }
    }

    // marcas, modelos, reps, servs
    if(Array.isArray(data.marcas)) for(const m of data.marcas) await dbSet('marcas',{nombre:m});
    if(Array.isArray(data.modelos)) for(const m of data.modelos) await dbSet('modelos',{nombre:m});
    if(Array.isArray(data.reps)) for(const r of data.reps) await dbSet('repuestos',{nombre:r});
    if(Array.isArray(data.servs)){
      // override services: clear existing services and set new ones
      // simple approach: delete and re-add
      const old = await dbGetAll('servicios');
      for(const o of old) { if(o.id) await dbDelete('servicios', o.id); }
      for(const s of data.servs) await dbAdd('servicios', { value: s });
    }

    await loadLists();
    await loadServices();
    showStatus('Datos actualizados');
  } catch (e){
    console.warn('syncServer error', e);
    showStatus('No se pudo conectar al servidor', true);
  }
}

/* ------------------ Utilities ------------------ */
function toggle(hdr){ const cnt = hdr.nextElementSibling; if(!cnt) return; cnt.style.display = (cnt.style.display === 'none' || cnt.style.display === '') ? 'block' : 'none'; }
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* ------------------ Status & connectivity ------------------ */
function updateStatus(){
  if(navigator.onLine){ showStatus('Conectado'); sync(); } else { showStatus('Sin conexión - Modo offline', true); }
}

/* ------------------ Small UX: autosave marca/modelo/repuesto on leave ------------------ */
document.addEventListener('focusout', async (e) => {
  const t = e.target;
  if(t.id === 'eqMarca' && t.value.trim()) await saveMarcaIfNew(t.value.trim());
  if(t.id === 'eqMod' && t.value.trim()) await saveModeloIfNew(t.value.trim());
  if(t.classList.contains('rep-nom') && t.value.trim()) await saveRepIfNew(t.value.trim());
  if(t.classList.contains('rep-ret-nom') && t.value.trim()) await saveRepIfNew(t.value.trim());
});

/* ------------------ small helpers: update local lists when DOM loaded ------------------ */
window.addEventListener('DOMContentLoaded', () => {
  // ensure initial collapse state
  document.querySelectorAll('.exp .exp-cnt').forEach(c => c.style.display = 'block');
});

/* ------------------ End of script ------------------ */
</script>

</body>
</html>
