<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Orden de Servicio T√©cnico - Realtech SpA</title>
<link rel="icon" type="image/png" href="logo_realtech.png">

<style>
  /* --- ESTILOS BASE --- */
  body {
    font-family: Arial, sans-serif;
    background-color: #f0f0f0; 
    margin: 0;
    padding: 20px 0;
    display: flex;
    justify-content: center;
  }

  .documento {
    background-color: white;
    width: 95%;
    max-width: 21.59cm;
    min-height: 27.94cm;
    padding: 0.8cm 1cm;
    box-sizing: border-box;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: flex-start; 
    overflow: visible;
  }

  /* Header */
  .header {
    border-bottom: 2px solid #004a99;
    padding-bottom: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .logo-area { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-grow: 1; }
  .logo img { width: 75px; display: block; } 
  
  .empresa-info { font-size: 9px; color: #000; line-height: 1.2; }
  .empresa-nombre { font-size: 13px; font-weight: bold; color: #004a99; display: block; }
  .titulo-doc { text-align: right; }
  .titulo-doc h1 { font-size: 16px; margin: 0; color: #004a99; }
  .numero-cotizacion { font-size: 12px; font-weight: bold; color: #004a99; margin-bottom: 2px; }
  .fecha-box { font-size: 9px; margin-top: 3px; font-weight: bold; color: #333; }
  .fecha-box input {
    border: none; background: transparent; font-size: 9px; font-weight: bold; 
    color: #333; padding: 0; width: 90px; outline: none;
  }

  /* T√≠tulos de Secci√≥n */
  h2 {
    font-size: 9px; background: #f0f0f0; padding: 3px 6px;
    border-left: 3px solid #004a99; text-transform: uppercase;
    color: #222; margin-bottom: 5px; margin-top: 8px;
  }

  /* Grid Cliente */
  .grid-cliente {
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 4px 8px; 
    margin-bottom: 8px;
  }
  .full-width { grid-column: 1 / -1; }
  .two-col { grid-column: span 2; }

  label {
    display: block; font-size: 7px; font-weight: bold;
    color: #004a99; margin-bottom: 1px; text-transform: uppercase;
  }
  input, textarea, select {
    width: 100%; border: none; border-bottom: 1px solid #ccc;
    padding: 2px 0; font-size: 10px; outline: none; background: transparent;
  }

  /* Secciones Expandibles */
  .expandible-section {
    margin-bottom: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
  }
  .expandible-header {
    background: #f5f5f5;
    padding: 5px 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 9px;
    font-weight: bold;
    color: #004a99;
  }
  .expandible-header:hover { background: #e8e8e8; }
  .expandible-content {
    padding: 8px;
    display: none;
    background: #fafafa;
  }
  .expandible-content.active { display: block; }
  
  .repuesto-row {
    display: grid;
    grid-template-columns: 2fr 1fr 30px;
    gap: 5px;
    margin-bottom: 5px;
    align-items: end;
  }
  
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
  }
  .checkbox-item input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  
  .trabajo-descripcion {
    grid-column: 1 / -1;
    background: white;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 3px;
    min-height: 40px;
    font-size: 9px;
    margin-top: 5px;
    color: #999;
  }

  /* Foto section */
  .photo-section {
    background: #eef6ff;
    padding: 8px;
    border-radius: 6px;
    margin-top: 6px;
    border: 1px solid #dbeefc;
  }
  .photo-controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .photo-preview { display:flex; gap:8px; flex-wrap:wrap; }
  .photo-preview img { width:120px; height:90px; object-fit:cover; border-radius:6px; border:1px solid #ccc; }

  .photo-meta { font-size: 10px; color:#333; }

  /* Footer */
  .footer-section { flex-shrink: 0; margin-top: 15px; }
  .obs-section { margin-bottom: 15px; }
  .obs-section textarea { min-height: 60px; font-size: 9px; resize: none; overflow: hidden; }
  
  .grid-firmas {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 10px;
  }
  
  .firma-box {
    display: flex;
    flex-direction: column;
  }

  /* Botones */
  .botonera { position: fixed; bottom: 15px; right: 15px; display: flex; gap: 8px; z-index: 100; }
  button { 
    padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; 
    font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
    font-size: 11px;
  }
  .btn-azul { background: #004a99; color: white; }
  .btn-gris { background: white; color: #333; }
  .btn-guardar { background: #38a169; color: white; }
  .btn-borrar { 
    background: #cc0000; color: white; width: 20px; height: 20px; 
    padding: 0; border-radius: 3px; font-size: 10px; 
  }

  /* Notificaci√≥n */
  .notificacion {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-weight: bold;
    z-index: 1000;
    display: none;
    animation: slideIn 0.3s ease-out;
  }
  .notificacion.exito { background: #38a169; color: white; }
  .notificacion.error { background: #cc0000; color: white; }
  
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Responsive */
  @media (min-width: 769px) {
    .documento {
      padding: 0.8cm 1.2cm; 
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .logo img { width: 85px; }
    .empresa-info { font-size: 10px; }
  }

  /* Impresi√≥n */
  @media print {
    @page { margin: 0.5cm !important; size: letter; }
    body { margin: 0; padding: 0; background: white; }
    
    .documento {
      width: 100%; 
      box-shadow: none;
      padding: 0.5cm 0.8cm !important; 
      margin: 0;
    }

    .botonera, .btn-borrar, .notificacion { display: none !important; } 
    
    input, textarea, td input, select, .fecha-box input {
      background: transparent !important; border: none !important; 
      padding: 0 !important;
    }
    input::placeholder { color: transparent; }
    h2, th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .expandible-content { display: block !important; }
    .toggle-icon { display: none; }
  }
</style>
</head>
<body>

<div class="notificacion" id="notificacion"></div>

<div class="botonera">
  <button class="btn-gris" onclick="agregarRepuestoInstalado()">+ Rep. Instalado</button>
  <button class="btn-gris" onclick="agregarRepuestoRetirado()">+ Rep. Retirado</button>
  <button class="btn-guardar" onclick="guardarOrden()">üíæ Guardar</button>
  <button class="btn-azul" onclick="window.print()">üñ®Ô∏è Imprimir</button>
</div>

<div class="documento">
  
  <div class="header">
    <div class="logo-area">
      <div class="logo">
        <img src="logo_realtech.png" alt="Logo" onerror="this.style.display='none'">
      </div>
      <div class="empresa-info">
        <span class="empresa-nombre">Realtech SpA</span>
        <strong>RUT: 77.651.114-5</strong><br>
        Arturo Prat 780 of 203A, Temuco<br>
        realtech.spa@gmail.com | +56 9 3957 3029
      </div>
    </div>
    <div class="titulo-doc">
      <div class="numero-cotizacion" id="numeroCotizacion">N¬∞ ---</div>
      <h1>Orden de Servicio T√©cnico</h1>
      <div class="fecha-box">
        Emisi√≥n: <input type="date" id="fechaInput">
      </div>
    </div>
  </div>

  <h2>Informaci√≥n del Cliente y Equipo</h2>
  <div class="grid-cliente">
    <div class="campo two-col">
      <label>Cliente / Empresa</label>
      <input type="text" id="clienteNombre" list="clientes-list" placeholder="Nombre del cliente..." onchange="autocompletarCliente()">
    </div>
    <div class="campo">
      <label>RUT</label>
      <input type="text" id="clienteRut" placeholder="XX.XXX.XXX-X" oninput="formatearRut(this)">
    </div>
    <div class="campo">
      <label>Direcci√≥n</label>
      <input type="text" id="clienteDireccion" placeholder="Direcci√≥n">
    </div>
    <div class="campo">
      <label>Ciudad</label>
      <input type="text" id="clienteCiudad" placeholder="Ciudad">
    </div>
    <div class="campo">
      <label>Contacto</label>
      <input type="text" id="clienteContacto" placeholder="Atenci√≥n a...">
    </div>
    <div class="campo">
      <label>Email</label>
      <input type="text" id="clienteEmail" placeholder="correo@ejemplo.com">
    </div>
    <div class="campo">
      <label>Tel√©fono</label>
      <input type="text" id="clienteTelefono" placeholder="+56 9...">
    </div>
    <div class="campo">
      <label>Marca Equipo</label>
      <input type="text" id="equipoMarca" list="marcas-list" placeholder="Seleccionar marca..." onchange="guardarNuevaMarca(this.value)">
    </div>
    <div class="campo">
      <label>Modelo</label>
      <input type="text" id="equipoModelo" list="modelos-list" placeholder="Modelo" onchange="guardarNuevoModelo(this.value)">
    </div>
    <div class="campo">
      <label>Serie</label>
      <input type="text" id="equipoSerie" placeholder="N¬∞ de serie">
    </div>
    <div class="campo">
      <label>Condici√≥n</label>
      <select id="equipoCondicion">
        <option value="">Seleccionar...</option>
        <option value="Venta">Venta</option>
        <option value="Arriendo">Arriendo</option>
      </select>
    </div>
  </div>

  <h2>Contadores de Impresora</h2>
  <div class="grid-cliente">
    <div class="campo">
      <label>Contador B/N</label>
      <input type="number" id="contadorBN" placeholder="0">
    </div>
    <div class="campo">
      <label>Contador Color</label>
      <input type="number" id="contadorColor" placeholder="0">
    </div>
  </div>

  <!-- Repuestos Instalados -->
  <div class="expandible-section">
    <div class="expandible-header" onclick="toggleExpandible(this)">
      <span>üì¶ Repuestos Instalados</span>
      <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="expandible-content">
      <div id="repuestosInstaladosContainer">
        <div class="repuesto-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="repuesto-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="repuesto-serie" placeholder="N¬∞ Serie">
          </div>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Repuestos Retirados -->
  <div class="expandible-section">
    <div class="expandible-header" onclick="toggleExpandible(this)">
      <span>üîß Repuestos Retirados</span>
      <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="expandible-content">
      <div id="repuestosRetiradosContainer">
        <div class="repuesto-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="repuesto-retirado-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="repuesto-retirado-serie" placeholder="N¬∞ Serie">
          </div>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trabajo Realizado -->
  <div class="expandible-section">
    <div class="expandible-header" onclick="toggleExpandible(this)">
      <span>üõ†Ô∏è Trabajo Realizado</span>
      <span class="toggle-icon">‚ñº</span>
    </div>
    <div class="expandible-content">
      <div class="checkbox-grid" id="trabajosCheckboxContainer">
        <!-- Se cargar√°n din√°micamente desde Google Sheets -->
      </div>
      <div class="trabajo-descripcion" id="trabajoDescripcion">
        No hay trabajos seleccionados
      </div>
    </div>
  </div>

  <!-- FOTO: ubicada antes de Firmas (elecci√≥n B) -->
  <h2>üì∑ Fotograf√≠as del Servicio</h2>
  <div class="photo-section">
    <div class="photo-controls">
      <div class="photo-meta">Adjunta hasta 5 fotos (tama√±o optimizado).</div>
      <div style="flex:1"></div>
      <button type="button" class="btn-gris" onclick="tomarFoto()" id="btnAgregarFoto">‚ûï Agregar Foto</button>
      <button type="button" class="btn-gris" onclick="limpiarFotos()" id="btnLimpiarFotos">üóëÔ∏è Limpiar</button>
    </div>
    <div class="photo-preview" id="photoPreview"></div>
  </div>

  <h2>Observaciones Adicionales</h2>
  <div class="obs-section">
    <textarea id="obs" placeholder="Detalles de la atenci√≥n que no est√°n registrados en los men√∫s desplegables..."></textarea>
  </div>

  <div class="footer-section">
    <h2>Firmas y Conformidad</h2>
    <div class="grid-firmas">
      <div class="firma-box">
        <label>Nombre T√©cnico</label>
        <select id="nombreTecnico">
          <option value="">Seleccionar t√©cnico...</option>
        </select>
      </div>
      <div class="firma-box">
        <label>Nombre Cliente</label>
        <input type="text" id="nombreClienteFirma" placeholder="Nombre completo del cliente">
      </div>
    </div>
  </div>

</div>

<datalist id="repuestos-list"></datalist>
<datalist id="clientes-list"></datalist>
<datalist id="marcas-list"></datalist>
<datalist id="modelos-list"></datalist>

<script>
  // =========================
  // CONFIG / ENDPOINT
  // =========================
  const APPS_SCRIPT_URL = 'https://informes-realtech.realtech-spa.workers.dev/';
  // Si usas otro URL para fotos/sync, actualiza aqu√≠.

  let cachedClients = [];
  let cachedMarcas = [];
  let cachedModelos = [];
  let cachedRepuestos = [];
  let cachedServicios = [];
  let cachedTecnicos = [];
  let numeroActual = 0;

  // Fotos
  let fotos = []; // array base64
  const MAX_FOTOS = 5;

  // IndexedDB
  let db;

  // Fecha por defecto
  const hoy = new Date();
  const fechaDefault = hoy.toISOString().split('T')[0];
  document.getElementById('fechaInput').value = fechaDefault;

  // Iniciar
  window.addEventListener('DOMContentLoaded', async () => {
    await cargarDatosIniciales();
    await abrirDB();
    syncOrdenesPendientes(); // intentar sincronizar si hay internet
  });

  // =========================
  // CARGA INICIAL (Google Apps Script)
  // =========================
  async function cargarDatosIniciales() {
    try {
      const response = await fetch(`${APPS_SCRIPT_URL}?action=loadData`);
      const data = await response.json();
      
      if (data.success) {
        cachedClients = data.clientes || [];
        cachedMarcas = data.marcas || [];
        cachedModelos = data.modelos || [];
        cachedRepuestos = data.repuestos || [];
        cachedServicios = data.servicios || [];
        cachedTecnicos = data.tecnicos || [];
        numeroActual = data.correlativo || 1;
        
        actualizarDataLists();
        cargarServiciosCheckboxes();
        cargarTecnicos();
        document.getElementById('numeroCotizacion').textContent = `N¬∞ ${String(numeroActual).padStart(4, '0')}`;
      } else {
        console.warn('Respuesta loadData no exitosa', data);
      }
    } catch (error) {
      console.error('Error cargando datos:', error);
      mostrarNotificacion('‚ö†Ô∏è Error al cargar datos del servidor', 'error');
    }
  }

  function actualizarDataLists() {
    // Clientes
    const clientesList = document.getElementById('clientes-list');
    clientesList.innerHTML = cachedClients.map(c => `<option value="${escapeHtml(c.nombre)}">`).join('');
    
    // Marcas
    const marcasList = document.getElementById('marcas-list');
    marcasList.innerHTML = cachedMarcas.map(m => `<option value="${escapeHtml(m)}">`).join('');
    
    // Modelos
    const modelosList = document.getElementById('modelos-list');
    modelosList.innerHTML = cachedModelos.map(m => `<option value="${escapeHtml(m)}">`).join('');
    
    // Repuestos
    const repuestosList = document.getElementById('repuestos-list');
    repuestosList.innerHTML = cachedRepuestos.map(r => `<option value="${escapeHtml(r)}">`).join('');
  }

  function cargarServiciosCheckboxes() {
    const container = document.getElementById('trabajosCheckboxContainer');
    container.innerHTML = '';
    
    cachedServicios.forEach((servicio, index) => {
      const div = document.createElement('div');
      div.className = 'checkbox-item';
      div.innerHTML = `
        <input type="checkbox" id="trabajo${index}" value="${escapeHtml(servicio)}" onchange="actualizarTrabajoRealizado()">
        <label for="trabajo${index}" style="text-transform: none; font-weight: normal;">${escapeHtml(servicio)}</label>
      `;
      container.appendChild(div);
    });
  }

  function cargarTecnicos() {
    const select = document.getElementById('nombreTecnico');
    select.innerHTML = '<option value="">Seleccionar t√©cnico...</option>';
    cachedTecnicos.forEach(tecnico => {
      const option = document.createElement('option');
      option.value = tecnico;
      option.textContent = tecnico;
      select.appendChild(option);
    });
  }

  function autocompletarCliente() {
    const nombreInput = document.getElementById('clienteNombre').value;
    const cliente = cachedClients.find(c => c.nombre === nombreInput);
    
    if (cliente) {
      document.getElementById('clienteRut').value = cliente.rut || '';
      document.getElementById('clienteDireccion').value = cliente.direccion || '';
      document.getElementById('clienteCiudad').value = cliente.ciudad || '';
      document.getElementById('clienteContacto').value = cliente.contacto || '';
      document.getElementById('clienteEmail').value = cliente.email || '';
      document.getElementById('clienteTelefono').value = cliente.telefono || '';
    }
  }

  async function guardarNuevoCliente(clienteData) {
    try {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'addCliente',
          data: clienteData
        }),
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await response.json();
      if (result.success) {
        cachedClients.push(clienteData);
        actualizarDataLists();
      }
    } catch (error) {
      console.error('Error guardando cliente:', error);
    }
  }

  async function guardarNuevaMarca(marca) {
    if (!marca || cachedMarcas.includes(marca)) return;
    try {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'addMarca',
          data: marca
        }),
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await response.json();
      if (result.success) {
        cachedMarcas.push(marca);
        actualizarDataLists();
      }
    } catch (error) {
      console.error('Error guardando marca:', error);
    }
  }

  async function guardarNuevoModelo(modelo) {
    if (!modelo || cachedModelos.includes(modelo)) return;
    try {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'addModelo',
          data: modelo
        }),
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await response.json();
      if (result.success) {
        cachedModelos.push(modelo);
        actualizarDataLists();
      }
    } catch (error) {
      console.error('Error guardando modelo:', error);
    }
  }

  async function guardarNuevoRepuesto(repuesto) {
    if (!repuesto || cachedRepuestos.includes(repuesto)) return;
    try {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'addRepuesto',
          data: repuesto
        }),
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await response.json();
      if (result.success) {
        cachedRepuestos.push(repuesto);
        actualizarDataLists();
      }
    } catch (error) {
      console.error('Error guardando repuesto:', error);
    }
  }

  function mostrarNotificacion(mensaje, tipo = 'exito') {
    const notif = document.getElementById('notificacion');
    notif.textContent = mensaje;
    notif.className = `notificacion ${tipo}`;
    notif.style.display = 'block';
    setTimeout(() => notif.style.display = 'none', 4000);
  }

  function formatearRut(input) {
    let valor = input.value.replace(/[^0-9kK]/g, '');
    if (valor.length === 0) return;
    let cuerpo = valor.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    let dv = valor.slice(-1).toUpperCase();
    input.value = cuerpo ? `${cuerpo}-${dv}` : '';
  }

  function agregarRepuestoInstalado() {
    const container = document.getElementById('repuestosInstaladosContainer');
    if (container.querySelectorAll('.repuesto-row').length >= 10) {
      mostrarNotificacion('‚ö†Ô∏è M√°ximo 10 repuestos', 'error');
      return;
    }
    const div = document.createElement('div');
    div.className = 'repuesto-row';
    div.innerHTML = `
      <div>
        <label>Repuesto</label>
        <input type="text" class="repuesto-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)">
      </div>
      <div>
        <label>Serie (opcional)</label>
        <input type="text" class="repuesto-serie" placeholder="N¬∞ Serie">
      </div>
      <button class="btn-borrar" onclick="this.parentElement.remove()">‚úï</button>
    `;
    container.appendChild(div);
  }

  function agregarRepuestoRetirado() {
    const container = document.getElementById('repuestosRetiradosContainer');
    if (container.querySelectorAll('.repuesto-row').length >= 10) {
      mostrarNotificacion('‚ö†Ô∏è M√°ximo 10 repuestos', 'error');
      return;
    }
    const div = document.createElement('div');
    div.className = 'repuesto-row';
    div.innerHTML = `
      <div>
        <label>Repuesto</label>
        <input type="text" class="repuesto-retirado-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)">
      </div>
      <div>
        <label>Serie (opcional)</label>
        <input type="text" class="repuesto-retirado-serie" placeholder="N¬∞ Serie">
      </div>
      <button class="btn-borrar" onclick="this.parentElement.remove()">‚úï</button>
    `;
    container.appendChild(div);
  }

  function actualizarTrabajoRealizado() {
    const checkboxes = document.querySelectorAll('#trabajosCheckboxContainer input[type="checkbox"]:checked');
    const descripcion = document.getElementById('trabajoDescripcion');
    
    if (checkboxes.length === 0) {
      descripcion.textContent = 'No hay trabajos seleccionados';
      descripcion.style.color = '#999';
    } else {
      const trabajos = Array.from(checkboxes).map(cb => cb.value);
      descripcion.textContent = trabajos.join(', ');
      descripcion.style.color = '#333';
    }
  }

  function toggleExpandible(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    content.classList.toggle('active');
    icon.textContent = content.classList.contains('active') ? '‚ñ≤' : '‚ñº';
  }

  // =========================
  // FUNCIONES DE FOTOS (compresi√≥n + preview)
  // =========================
  function tomarFoto() {
    if (fotos.length >= MAX_FOTOS) {
      mostrarNotificacion(`‚ö†Ô∏è M√°ximo ${MAX_FOTOS} fotos`, 'error');
      return;
    }

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const compressed = await comprimirImagen(ev.target.result);
          fotos.push(compressed);
          mostrarFotos();
        } catch (err) {
          console.error('Error comprimiendo imagen', err);
          mostrarNotificacion('‚ùå Error al procesar la foto', 'error');
        }
      };

      reader.readAsDataURL(file);
    };

    input.click();
  }

  function mostrarFotos() {
    const cont = document.getElementById("photoPreview");
    cont.innerHTML = "";
    fotos.forEach((f, idx) => {
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      const img = document.createElement("img");
      img.src = f;
      img.alt = `Foto ${idx+1}`;
      wrapper.appendChild(img);

      const btn = document.createElement('button');
      btn.className = 'btn-borrar';
      btn.style.position = 'absolute';
      btn.style.top = '4px';
      btn.style.right = '4px';
      btn.style.width = '26px';
      btn.style.height = '26px';
      btn.style.padding = '0';
      btn.textContent = '‚úï';
      btn.onclick = () => { fotos.splice(idx,1); mostrarFotos(); };
      wrapper.appendChild(btn);

      cont.appendChild(wrapper);
    });

    // deshabilitar agregar si llega al max
    document.getElementById('btnAgregarFoto').disabled = fotos.length >= MAX_FOTOS;
  }

  function limpiarFotos() {
    fotos = [];
    mostrarFotos();
    document.getElementById('btnAgregarFoto').disabled = false;
  }

  async function comprimirImagen(base64) {
    const img = new Image();
    img.src = base64;
    await img.decode();

    const canvas = document.createElement("canvas");
    const MAX_WIDTH = 1280;

    let width = img.width;
    let height = img.height;

    if (width > MAX_WIDTH) {
      height = Math.round(height * (MAX_WIDTH / width));
      width = MAX_WIDTH;
    }

    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);

    // Calidad 0.6 para equilibrar peso/calidad
    return canvas.toDataURL("image/jpeg", 0.6);
  }

  // =========================
  // GUARDAR ORDEN (incluye fotos). Si falla -> guardar offline
  // =========================
  async function guardarOrden() {
    // Validaciones b√°sicas
    const clienteNombre = document.getElementById('clienteNombre').value.trim();
    if (!clienteNombre) {
      mostrarNotificacion('‚ö†Ô∏è Ingrese el nombre del cliente', 'error');
      return;
    }

    // Recopilar datos del cliente
    const clienteData = {
      nombre: clienteNombre,
      rut: document.getElementById('clienteRut').value,
      direccion: document.getElementById('clienteDireccion').value,
      ciudad: document.getElementById('clienteCiudad').value,
      contacto: document.getElementById('clienteContacto').value,
      email: document.getElementById('clienteEmail').value,
      telefono: document.getElementById('clienteTelefono').value
    };

    // Si es cliente nuevo, guardarlo (intento)
    const clienteExiste = cachedClients.some(c => c.nombre === clienteNombre);
    if (!clienteExiste) {
      await guardarNuevoCliente(clienteData);
    }

    // Recopilar repuestos instalados
    const repuestosInstalados = [];
    document.querySelectorAll('#repuestosInstaladosContainer .repuesto-row').forEach(row => {
      const nombre = row.querySelector('.repuesto-nombre')?.value.trim() || '';
      const serie = row.querySelector('.repuesto-serie')?.value.trim() || '';
      if (nombre) {
        repuestosInstalados.push({ nombre, serie });
      }
    });

    // Recopilar repuestos retirados
    const repuestosRetirados = [];
    document.querySelectorAll('#repuestosRetiradosContainer .repuesto-row').forEach(row => {
      const nombre = row.querySelector('.repuesto-retirado-nombre')?.value.trim() || '';
      const serie = row.querySelector('.repuesto-retirado-serie')?.value.trim() || '';
      if (nombre) {
        repuestosRetirados.push({ nombre, serie });
      }
    });

    // Recopilar trabajos realizados
    const trabajosRealizados = Array.from(
      document.querySelectorAll('#trabajosCheckboxContainer input[type="checkbox"]:checked')
    ).map(cb => cb.value);

    // Datos de la orden
    const ordenData = {
      numero: numeroActual,
      fecha: document.getElementById('fechaInput').value,
      cliente: clienteData,
      equipo: {
        marca: document.getElementById('equipoMarca').value,
        modelo: document.getElementById('equipoModelo').value,
        serie: document.getElementById('equipoSerie').value,
        condicion: document.getElementById('equipoCondicion').value
      },
      contadores: {
        bn: document.getElementById('contadorBN').value,
        color: document.getElementById('contadorColor').value
      },
      repuestosInstalados,
      repuestosRetirados,
      trabajosRealizados,
      observaciones: document.getElementById('obs').value,
      tecnico: document.getElementById('nombreTecnico').value,
      clienteFirma: document.getElementById('nombreClienteFirma').value,
      fotos: fotos, // <-- aqu√≠ incluimos las fotos (base64)
      meta: {
        creadoEn: new Date().toISOString(),
        htmlSnapshot: '' // evitando guardar body grande, se puede agregar si se requiere
      }
    };

    try {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'saveOrden',
          data: ordenData
        }),
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (result.success) {
        mostrarNotificacion('‚úÖ Orden guardada exitosamente', 'exito');
        numeroActual++;
        document.getElementById('numeroCotizacion').textContent = `N¬∞ ${String(numeroActual).padStart(4, '0')}`;
        // limpiar formulario parcial opcional: comentar si no quieres limpiar
        // limpiarFormularioBasico();
      } else {
        mostrarNotificacion('‚ùå Error al guardar: ' + (result.error || 'Desconocido') + '. Se guarda localmente.', 'error');
        // Guardar offline para sincronizar luego
        await guardarOrdenOffline(ordenData);
      }
    } catch (error) {
      console.error('Error:', error);
      mostrarNotificacion('‚ùå Error de conexi√≥n. Orden guardada localmente.', 'error');
      await guardarOrdenOffline(ordenData);
    }
  }

  // =========================
  // INDEXEDDB: Guardado offline de √≥rdenes pendientes
  // =========================
  function abrirDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("realtechDB_v2", 1);

      request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("ordenesPendientes")) {
          db.createObjectStore("ordenesPendientes", { keyPath: "id" });
        }
      };

      request.onsuccess = (e) => {
        db = e.target.result;
        resolve();
      };

      request.onerror = (e) => {
        console.error('IndexedDB error', e);
        reject(e);
      };
    });
  }

  async function guardarOrdenOffline(ordenData) {
    await abrirDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(["ordenesPendientes"], "readwrite");
      const store = tx.objectStore("ordenesPendientes");
      const item = { id: Date.now(), orden: ordenData };
      const req = store.put(item);
      req.onsuccess = () => { resolve(true); };
      req.onerror = (e) => { console.error('Error guardando orden offline', e); reject(e); };
    });
  }

  async function obtenerOrdenesPendientes() {
    await abrirDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(["ordenesPendientes"], "readonly");
      const store = tx.objectStore("ordenesPendientes");
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = (e) => reject(e);
    });
  }

  async function borrarOrdenPendiente(id) {
    await abrirDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(["ordenesPendientes"], "readwrite");
      const store = tx.objectStore("ordenesPendientes");
      const req = store.delete(id);
      req.onsuccess = () => resolve(true);
      req.onerror = (e) => reject(e);
    });
  }

  async function syncOrdenesPendientes() {
    if (!navigator.onLine) return;
    const pendientes = await obtenerOrdenesPendientes();
    if (!pendientes.length) return;

    for (const item of pendientes) {
      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "saveOrden", data: item.orden }),
          headers: { "Content-Type": "application/json" }
        });
        const json = await res.json();
        if (json && json.success) {
          await borrarOrdenPendiente(item.id);
          console.log("Orden sincronizada:", item.id);
          mostrarNotificacion('üì∂ Orden(es) pendientes sincronizadas', 'exito');
        } else {
          console.warn('No se pudo sincronizar orden', item.id, json);
        }
      } catch (e) {
        console.log("Sin Internet o error al sincronizar. Reintentar luego...");
        return;
      }
    }
  }

  window.addEventListener("online", () => {
    syncOrdenesPendientes();
  });

  // =========================
  // UTILIDADES
  // =========================
  function escapeHtml(str) {
    if (typeof str !== 'string') return str;
    return str.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  // =========================
  // Limpieza de formulario (opcional)
  // =========================
  function limpiarFormularioBasico() {
    // No borra todo para evitar p√©rdida accidental; ajusta si quieres limpiar
    document.getElementById('clienteNombre').value = '';
    document.getElementById('clienteRut').value = '';
    document.getElementById('clienteDireccion').value = '';
    document.getElementById('clienteCiudad').value = '';
    document.getElementById('clienteContacto').value = '';
    document.getElementById('clienteEmail').value = '';
    document.getElementById('clienteTelefono').value = '';
    document.getElementById('equipoMarca').value = '';
    document.getElementById('equipoModelo').value = '';
    document.getElementById('equipoSerie').value = '';
    document.getElementById('equipoCondicion').value = '';
    document.getElementById('contadorBN').value = '';
    document.getElementById('contadorColor').value = '';
    document.getElementById('obs').value = '';
    document.getElementById('nombreClienteFirma').value = '';
    fotos = [];
    mostrarFotos();
  }

</script>
</body>
</html>
