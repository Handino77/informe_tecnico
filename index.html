<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Orden de Servicio Técnico - Realtech SpA</title>
<link rel="icon" href="logo_realtech.png" />
<style>
  /* --------- Diseño base responsive con sistema de espaciado 8px --------- */
  :root {
    /* Paleta corporativa */
    --realtech-blue: #004a99;
    --realtech-blue-dark: #002b5c;
    --realtech-green: #00a86b;
    --realtech-gray: #4a5568;
    --realtech-bg: #f7fafc;

    /* Colores heredados y ajustados */
    --muted: #f8fafc;
    --accent: var(--realtech-green);
    --danger: #e53e3e;
    --card: #ffffff;
    --text: var(--realtech-gray);
    --sub: #64748b;
    --border: #e2e8f0;

    /* Espaciado (sistema 8px) */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;

    /* Bordes */
    --radius-sm: 8px;
    --radius-md: 10px;
    --radius-pill: 50px;
    --border-width: 1px;
    --border-focus: 2px;

    /* Sombras */
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);

    /* Transiciones */
    --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--realtech-bg);
    color: var(--text);
    padding: var(--space-sm);
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding-bottom: var(--space-2xl); /* Espacio para controles móviles */
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }

  /* Contenedor Principal */
  .container {
    width: 100%;
    max-width: 980px;
    background: var(--card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    padding: var(--space-md);
    position: relative;
  }

  /* Header optimizado */
  .header-optimized {
    background: linear-gradient(135deg, #ffffff 0%, var(--realtech-bg) 100%);
    border-bottom: 3px solid var(--realtech-blue);
    padding: var(--space-md);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    margin-bottom: var(--space-md);
  }
  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
  }
  .logo-container {
    flex-shrink: 0;
  }
  .logo-img {
    width: 80px;
    height: auto;
    border-radius: var(--radius-sm);
    object-fit: contain;
    box-shadow: var(--shadow-sm);
  }
  .order-badge {
    background: var(--realtech-blue);
    color: white;
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-pill);
    font-weight: 800;
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 18px;
  }
  .badge-label {
    font-size: 14px;
  }
  .badge-number {
    font-size: 18px;
  }
  .company-info {
    text-align: center;
    margin-bottom: var(--space-sm);
  }
  .company-title {
    margin: 0;
    font-size: 20px;
    color: var(--realtech-blue);
    line-height: 1.2;
    letter-spacing: 0.5px;
    font-weight: 700;
  }
  .company-name {
    display: block;
    font-weight: 800;
  }
  .document-type {
    display: block;
    font-size: 16px;
  }
  .company-details {
    font-size: 13px;
    color: var(--sub);
    line-height: 1.4;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-xs);
  }
  .detail-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  .icon {
    width: 16px;
    height: 16px;
    fill: var(--sub);
  }
  .header-meta {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: var(--space-sm);
  }
  .meta-label {
    font-size: 12px;
    color: var(--realtech-blue);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .date-input {
    padding: var(--space-sm) var(--space-md);
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius-md);
    background: #fff;
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: var(--transition-normal);
    height: 44px; /* Altura táctil mínima */
    text-align: right;
  }

  /* Grids Responsivos */
  .grid, .grid-eq {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-md);
    align-items: end;
  }
  .full-width { grid-column: 1 / -1; }

  label { 
    display: block; 
    font-size: 12px; 
    color: var(--realtech-blue); 
    font-weight: 700; 
    margin-bottom: var(--space-xs); 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
  }

  /* Inputs optimizados para táctil */
  input[type="text"], input[type="date"], input[type="number"], textarea, select {
    width: 100%;
    padding: 12px 14px; /* Generoso para táctil */
    border: var(--border-width) solid var(--border);
    border-radius: var(--radius-md);
    background: #fff;
    font-size: 16px !important; /* Evita zoom en iOS */
    color: var(--text);
    outline: none;
    transition: var(--transition-normal);
    height: 44px; /* Altura mínima táctil */
  }
  input:focus, textarea:focus, select:focus {
    border-color: var(--realtech-blue);
    box-shadow: 0 0 0 var(--border-focus) rgba(0, 74, 153, 0.1);
  }
  textarea { min-height: 100px; resize: vertical; height: auto; }

  /* Títulos de Sección */
  .section-title { margin: var(--space-lg) 0 var(--space-sm); }
  .section-title h2 {
    margin: 0; 
    font-size: 14px;
    background: #f0f7ff;
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    border-left: 5px solid var(--realtech-blue);
    color: var(--realtech-blue);
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  /* Botón para añadir repuestos */
  .btn-section-add {
    background: #fff;
    border: var(--border-width) solid var(--border);
    color: var(--realtech-blue);
    padding: 12px 14px; /* Táctil */
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    width: 100%;
    margin-top: var(--space-md);
    transition: var(--transition-fast);
    height: 44px; /* Táctil */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
  }
  .btn-section-add:hover { background: var(--muted); }
  .btn-section-add:active { transform: scale(0.98); }

  /* Bloques expandibles y Repuestos */
  .exp { 
    background: var(--muted); 
    padding: var(--space-md); 
    border-radius: var(--radius-md); 
    border: var(--border-width) solid var(--border); 
    margin-bottom: var(--space-md); 
    transition: var(--transition-normal);
  }
  .exp-hdr { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    cursor: pointer; 
    user-select: none; 
    font-weight: 600;
    color: var(--realtech-blue);
    transition: var(--transition-fast);
  }
  .exp-hdr::after {
    content: '▼';
    font-size: 14px;
    transition: var(--transition-normal);
  }
  .exp-hdr.collapsed::after {
    content: '▲';
  }
  .exp-cnt {
    display: block;
    overflow: hidden;
    transition: var(--transition-normal);
    max-height: 1000px; /* Para animación */
  }
  .exp-cnt.collapsed {
    max-height: 0;
    padding: 0;
  }

  /* Filas de repuestos responsive */
  .rep-row {
    display: grid;
    grid-template-columns: 1fr 140px 40px;
    gap: var(--space-sm);
    align-items: end;
    margin-bottom: var(--space-sm);
    background: #fff;
    padding: var(--space-sm);
    border-radius: var(--radius-md);
    border: var(--border-width) solid var(--border);
    box-shadow: var(--shadow-sm);
  }
  .btn-del {
    background: #fee2e2; 
    color: var(--danger);
    border: none; 
    border-radius: var(--radius-sm);
    height: 44px; /* Táctil */
    width: 100%;
    font-weight: bold; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: var(--transition-fast);
  }
  .btn-del:hover { background: var(--danger); color: white; }
  .btn-del:active { transform: scale(0.98); }

  /* Checkboxes */
  .chk-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: var(--space-sm);
  }
  .chk-item {
    display: flex; 
    align-items: center; 
    gap: var(--space-sm);
    padding: var(--space-sm); 
    background: #fff;
    border-radius: var(--radius-md); 
    border: var(--border-width) solid var(--border);
    cursor: pointer;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
  }
  .chk-item:hover { box-shadow: var(--shadow-md); }
  .chk-item input { 
    width: 24px; /* Más grande para táctil */
    height: 24px; 
    margin: 0; 
    accent-color: var(--realtech-blue);
  }
  .trab-desc { 
    margin-top: var(--space-sm); 
    padding: var(--space-md); 
    background: #fff; 
    border: var(--border-width) solid var(--border); 
    border-radius: var(--radius-md); 
    color: var(--sub); 
    font-size: 14px; 
    line-height: 1.5; 
    box-shadow: var(--shadow-sm);
  }

  /* Footer y Firmas */
  .footer { 
    margin-top: var(--space-xl); 
    border-top: 2px solid var(--muted); 
    padding-top: var(--space-lg); 
  }
  .firmas {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
  }
  .firma-line { 
    margin-top: var(--space-xs); 
    border-top: 1px dashed var(--sub); 
    padding-top: var(--space-xs); 
    font-size: 11px; 
    text-align: center; 
    color: var(--sub); 
    text-transform: uppercase; 
  }

  /* Controles Flotantes (Botones) */
  .controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    gap: var(--space-sm);
    z-index: 9999; /* Alto para evitar superposiciones */
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    padding: var(--space-sm);
    border-top: var(--border-width) solid var(--border);
    box-shadow: var(--shadow-lg);
  }
  .controls button {
    padding: 12px 20px;
    border-radius: var(--radius-md);
    border: none;
    font-weight: 700;
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition-fast);
    min-width: 160px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
    height: 44px; /* Táctil */
  }
  .controls button:active { transform: scale(0.98); }
  .btn-save { 
    background: var(--realtech-green); 
    color: #fff; 
    flex: 2; 
  }
  .btn-blue { 
    background: var(--realtech-blue); 
    color: #fff; 
    flex: 1; 
  }

  /* Status Bar */
  .statusbar {
    position: fixed; 
    top: var(--space-md); 
    left: 50%; 
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-pill);
    box-shadow: var(--shadow-md);
    z-index: 1100;
    display: flex; 
    gap: var(--space-sm); 
    align-items: center; 
    font-size: 13px;
    border: var(--border-width) solid var(--border);
    width: max-content;
    max-width: 90%;
  }

  /* ---------------- MEDIA QUERIES (Móvil) ---------------- */
  @media (max-width: 768px) {
    body { padding: var(--space-xs); padding-bottom: calc(var(--space-xl) + env(safe-area-inset-bottom)); } /* Safe areas */
    .container { padding: var(--space-sm); border-radius: 0; box-shadow: none; max-width: 100%; }

    /* Header Stackeado */
    .header-optimized { 
      padding: var(--space-sm); 
      border-radius: 0;
    }
    .header-top {
      margin-bottom: var(--space-md);
    }
    .logo-img {
      width: 60px;
      height: auto;
    }
    .company-title {
      font-size: 18px;
    }
    .company-details {
      font-size: 12px;
      text-align: center;
    }
    .header-meta {
      justify-content: center;
    }
    .date-input {
      text-align: center;
    }

    /* Grids en una sola columna */
    .grid, .grid-eq { grid-template-columns: 1fr; gap: var(--space-sm); }

    /* Repuestos Stackeado */
    .rep-row {
      grid-template-columns: 1fr;
      gap: var(--space-sm);
    }
    .rep-row div:last-child { margin-top: var(--space-xs); }

    /* Checkboxes en 1 columna */
    .chk-grid {
      grid-template-columns: 1fr;
    }

    /* Firmas Stackeadas */
    .firmas { grid-template-columns: 1fr; gap: var(--space-md); }
  }

  /* ---------------- PRINT STYLES ---------------- */
  @page {
    size: letter portrait;
    margin: 0.5in;
  }
  @media print {
    body, .container { 
      background: #fff; 
      margin: 0; 
      padding: 0; 
      box-shadow: none; 
      width: 100%; 
      max-width: 100%; 
      font-size: 10pt; 
    }
    .controls, .statusbar, .btn-section-add, .btn-del { display: none !important; }
    .section-title h2 { 
      background: none; 
      border: none; 
      padding-left: 0; 
      color: #000; 
      border-bottom: 2pt solid #000; 
      font-size: 11pt; 
      font-weight: bold; 
      text-transform: uppercase;
    }
    input, textarea, select { 
      border: none; 
      padding: 0; 
      font-family: inherit; 
      font-size: 10pt; 
      height: auto; 
      color: #000; 
    }
    label { 
      font-size: 8pt; 
      color: #333; 
      font-weight: semibold; 
    }
    .rep-row { 
      border: none; 
      padding: 0; 
      margin-bottom: 5pt; 
      grid-template-columns: 2fr 1fr; 
      border-bottom: 0.5pt solid #ccc;
    }
    header, .header-optimized { 
      border-bottom: 1pt solid #000; 
      padding: 10pt;
      page-break-after: avoid;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo-img {
      width: 1in;
      height: auto;
    }
    .order-badge {
      background: transparent;
      color: #000;
      border: 0.5pt solid #000;
      padding: 5pt 10pt;
      font-size: 14pt;
      font-weight: bold;
    }
    .company-title {
      font-size: 16pt;
      font-weight: bold;
      text-align: center;
    }
    .company-details {
      font-size: 9pt;
      color: #333;
      text-align: center;
    }
    .header-meta {
      text-align: right;
    }
    .date-input {
      font-size: 10pt;
      color: #000;
    }
    .exp { 
      border: 0.5pt solid #ccc; 
      padding: 10pt; 
      background: none;
    }
    .exp-hdr { 
      font-weight: bold; 
      color: #000;
    }
    .exp-hdr::after { display: none; }
    .exp-cnt { max-height: none; }
    .trab-desc {
      font-size: 9pt;
      line-height: 1.4;
      color: #000;
    }
    #obs {
      font-size: 9pt;
      line-height: 1.4;
    }
    .footer {
      position: running(footer);
      bottom: 0;
      width: 100%;
      font-size: 7pt;
      color: #666;
      text-align: center;
      page-break-before: auto;
    }
    .firmas {
      border-top: 0.5pt solid #ccc;
      padding-top: 10pt;
    }
    .firma-line {
      border-top: 1pt dotted #000;
      font-size: 8pt;
      color: #000;
    }
    /* Control de saltos de página */
    .section-title, .exp, .footer {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    header {
      page-break-after: avoid;
    }
  }
</style>
</head>
<body>

<div class="statusbar" id="statusbar" aria-live="polite">
  <strong id="statusTxt">Cargando...</strong>
  <span id="badge" class="badge" style="display:none;background:#f97316;color:#fff;padding:2px 6px;border-radius:10px;font-size:11px;">0</span>
  <button id="syncBtn" style="display:none;margin-left:6px;padding:4px 8px;border-radius:6px;border:none;background:#eef4ff;color:var(--blue);cursor:pointer;font-weight:bold;font-size:11px;">Sincronizar</button>
</div>

<div class="container" role="main">
  <!-- Header optimizado con wrappers para mejor layout sin romper IDs -->
  <header class="header-optimized" role="banner">
    <div class="header-top">
      <div class="logo-container">
        <img src="logo_realtech.png" alt="Realtech SpA Logo" class="logo-img" onerror="this.style.display='none'">
      </div>
      <div class="order-badge" aria-label="Número de orden">
        <span class="badge-label">N°</span>
        <span class="badge-number" id="num">XXXX</span>
      </div>
    </div>

    <div class="company-info">
      <h1 class="company-title">
        <span class="company-name">Realtech SpA</span>
        <span class="document-type">Orden de Servicio Técnico</span>
      </h1>
      <div class="company-details">
        <span class="detail-item">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>
          RUT: 77.651.114-5
        </span>
        <span class="detail-item">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
          Arturo Prat 780 of 203A, Temuco
        </span>
        <span class="detail-item">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          realtech.spa@gmail.com
        </span>
      </div>
    </div>

    <div class="header-meta">
      <label for="fecha" class="meta-label">Emisión</label>
      <input type="date" id="fecha" class="date-input" aria-label="Fecha de emisión" />
    </div>
  </header>

  <section>
    <div class="section-title"><h2>Información del Cliente</h2></div>
    <div class="grid" role="form" aria-label="Información del cliente">
      <div class="full-width">
        <label for="cliNom">Cliente / Empresa</label>
        <input type="text" id="cliNom" list="cli-list" placeholder="Nombre del cliente..." autocomplete="off">
      </div>
      <div>
        <label for="cliRut">RUT</label>
        <input type="text" id="cliRut" placeholder="XX.XXX.XXX-X">
      </div>
      <div class="full-width"><label for="cliDir">Dirección</label><input type="text" id="cliDir" placeholder="Dirección"></div>
      <div><label for="cliCiu">Ciudad</label><input type="text" id="cliCiu" placeholder="Ciudad"></div>
      <div><label for="cliCon">Contacto</label><input type="text" id="cliCon" placeholder="Atención a..."></div>
      <div class="full-width"><label for="cliMail">Email</label><input type="text" id="cliMail" placeholder="correo@ejemplo.com"></div>
      <div><label for="cliTel">Teléfono</label><input type="text" id="cliTel" placeholder="+56 9 ..."></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Información del Equipo</h2></div>
    <div class="grid-eq">
      <div><label for="eqMarca">Marca Equipo</label><input type="text" id="eqMarca" list="marca-list" placeholder="Marca..." /></div>
      <div><label for="eqMod">Modelo</label><input type="text" id="eqMod" list="modelo-list" placeholder="Modelo" /></div>
      <div><label for="eqSer">Serie</label><input type="text" id="eqSer" placeholder="N° de serie" /></div>
      <div><label for="eqCond">Condición</label>
        <select id="eqCond">
          <option value="">Seleccionar...</option>
          <option value="Arriendo">Arriendo</option>
          <option value="Venta">Venta</option>
        </select>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-sm);margin-bottom:var(--space-sm)">
      <div><label for="contBN">Contador B/N</label><input type="number" id="contBN" placeholder="0" min="0"></div>
      <div><label for="contColor">Contador Color</label><input type="number" id="contColor" placeholder="0" min="0"></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Repuestos Instalados</h2></div>
    <div class="exp">
      <div class="exp-hdr" onclick="toggle(this)"><strong>Repuestos instalados</strong><span id="ri-count" style="color:var(--sub)"></span></div>
      <div class="exp-cnt" id="repInst">
        <div class="rep-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="rep-nom" list="rep-list" placeholder="Nombre del repuesto">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="rep-ser" placeholder="N° Serie">
          </div>
          <div style="align-self:center">
            <button class="btn-del" onclick="this.closest('.rep-row').remove()">Eliminar</button>
          </div>
        </div>
      </div>
      <button type="button" class="btn-section-add" onclick="addRepInst()">+ Agregar Repuesto Instalado</button>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Repuestos Retirados</h2></div>
    <div class="exp">
      <div class="exp-hdr" onclick="toggle(this)"><strong>Repuestos retirados</strong></div>
      <div class="exp-cnt" id="repRet">
        <div class="rep-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="rep-ret-nom" list="rep-list" placeholder="Nombre del repuesto">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="rep-ret-ser" placeholder="N° Serie">
          </div>
          <div style="align-self:center">
            <button class="btn-del" onclick="this.closest('.rep-row').remove()">Eliminar</button>
          </div>
        </div>
      </div>
      <button type="button" class="btn-section-add" onclick="addRepRet()">+ Agregar Repuesto Retirado</button>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Trabajo Realizado</h2></div>
    <div class="exp">
      <div class="exp-cnt">
        <div class="chk-grid" id="trabChk" aria-live="polite"></div>
        <div class="trab-desc" id="trabDesc">No hay trabajos seleccionados</div>
      </div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Observaciones</h2></div>
    <textarea id="obs" placeholder="Detalles de la atención..."></textarea>
  </section>

  <div class="footer">
    <div class="firmas">
      <div>
        <label>Nombre Técnico</label>
        <input type="text" id="nomTec" list="tech-list" placeholder="Nombre completo">
        <div class="firma-line">Firma Técnico</div>
      </div>
      <div>
        <label>Nombre Cliente</label>
        <input type="text" id="nomCliFirma" placeholder="Nombre completo">
        <div class="firma-line">Firma Cliente</div>
      </div>
    </div>
  </div>
</div>

<datalist id="rep-list"></datalist>
<datalist id="cli-list"></datalist>
<datalist id="marca-list"></datalist>
<datalist id="modelo-list"></datalist>
<datalist id="tech-list"></datalist>

<div class="controls" role="region" aria-label="Controles">
  <button class="btn-blue" onclick="window.print()">
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H7V4h10v3z"/></svg>
    Imprimir
  </button>
  <button class="btn-save" id="saveBtn" onclick="save()">
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    GUARDAR
  </button>
</div>

<script>
/* ------------------ CONFIG ------------------ */
const URL = 'https://informes-realtech.realtech-spa.workers.dev/';
let isSyncing = false;
let isSaving = false; 

/* ------------------ IndexedDB Setup ------------------ */
let db = null;
let appState = {
  folio: 1, // Folio simple para el técnico actual (ej: 6)
  techId: null, // ID del técnico (ej: 1)
  techName: null // Nombre del técnico
};

// CLAVE: Se incrementa la versión a 4 para forzar la creación del store 'tecnicos'
const req = indexedDB.open('RealtechDB', 4);

req.onupgradeneeded = (e) => {
  const idb = e.target.result;
  if (!idb.objectStoreNames.contains('clientes')) idb.createObjectStore('clientes', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('marcas')) idb.createObjectStore('marcas', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('modelos')) idb.createObjectStore('modelos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('repuestos')) idb.createObjectStore('repuestos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('servicios')) idb.createObjectStore('servicios', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('ordenesPend')) idb.createObjectStore('ordenesPend', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('config')) idb.createObjectStore('config', { keyPath: 'key' });
  // Nuevo store para técnicos
  if (!idb.objectStoreNames.contains('tecnicos')) idb.createObjectStore('tecnicos', { keyPath: 'id' });
};

req.onsuccess = (e) => {
  db = e.target.result;
  initApp();
};

req.onerror = (e) => {
  console.error('Error inicializando IndexedDB', e);
  showStatus('Error DB', true);
};

/* --------- Helper DB functions (Promises) --------- */
function tx(store, mode = 'readonly'){
  return db.transaction(store, mode).objectStore(store);
}

function dbSet(store, value){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
function dbAdd(store, value){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').add(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
function dbGet(store, key){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').get(key);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => resolve(null);
  });
}
function dbGetAll(store){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').getAll();
    request.onsuccess = () => resolve(request.result || []);
    request.onerror = () => resolve([]);
  });
}
function dbDelete(store, key){
  return new Promise((resolve, reject) => {
    try {
      const request = tx(store, 'readwrite').delete(key);
      request.onsuccess = () => resolve(true);
      request.onerror = (e) => reject(e);
    } catch (e) { reject(e); }
  });
}
// NUEVO: Función para eliminar todos los registros de una tienda (útil para actualizar listas maestras)
function dbDelAll(store){
  return new Promise((resolve) => {
    const request = tx(store, 'readwrite').clear();
    request.onsuccess = () => resolve(true);
    request.onerror = () => resolve(false);
  });
}

/* ------------------ UI helpers ------------------ */
function showStatus(text, isError=false){
  const el = document.getElementById('statusTxt');
  const badge = document.getElementById('badge');
  const syncBtn = document.getElementById('syncBtn');
  el.textContent = text;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
  if(isError){
    // Si hay error, solo mostrar texto y ocultar badge/sync
    badge.style.display='none';
    syncBtn.style.display='none';
  }
}

function notif(msg, type='ok'){
  // simple accessible notification via statusbar temporarily
  const el = document.getElementById('statusTxt');
  el.textContent = msg;
  el.style.color = type==='err' ? 'var(--danger)' : 'inherit';
  setTimeout(()=> updateStatus(), 3500);
}

// Muestra el número compuesto [ID_Técnico][Folio]
function renderNum(){
  const numPad = String(appState.folio).padStart(4,'0');
  const techPad = appState.techId ? String(appState.techId).padStart(2,'0') : 'XX';
  
  document.getElementById('num').textContent = `N° ${techPad}${numPad}`; 
}

/* ------------------ App init ------------------ */
async function initApp(){
  
  // set today's date if empty
  if(!document.getElementById('fecha').value) document.getElementById('fecha').value = new Date().toISOString().split('T')[0];

  // Evento de selección de Técnico
  document.getElementById('nomTec').addEventListener('change', onTechSelect);
  document.getElementById('cliNom').addEventListener('change', onClientSelect);
  document.getElementById('cliNom').addEventListener('input', ()=>{/* allow typing */});
  document.getElementById('syncBtn').addEventListener('click', sync);

  // Intentar cargar el último técnico y su folio si ya están guardados
  const lastTech = await dbGet('config', 'lastTech');
  if (lastTech && lastTech.id) {
    document.getElementById('nomTec').value = lastTech.name;
    // Forzamos la ejecución de onTechSelect si ya hay un técnico guardado
    // Nota: onTechSelect actualizará appState.techId y llamará a loadTechFolio
    await onTechSelect.call(document.getElementById('nomTec'));
  }
  
  // load data from local DB
  await loadLists();
  await loadServices();
  await renderPendingBadge();

  // try to sync from server to pull masters (incluye lista de técnicos y folios)
  syncServer();

  // connectivity events
  // Cuando se vuelve a conectar, llama a updateStatus (que solo actualiza el texto) y luego a sync()
  window.addEventListener('online', () => { updateStatus(); sync(); });
  window.addEventListener('offline', updateStatus);
  updateStatus();
  
  // Inicializa el número compuesto (puede ser N° XX0001 si no hay técnico)
  renderNum();
}

// Manejador al seleccionar técnico
async function onTechSelect() {
  const name = this.value.trim();
  const techList = await dbGetAll('tecnicos');
  // Buscar el técnico por nombre para obtener su ID
  const selectedTech = techList.find(t => t.nombre === name);

  if (selectedTech) {
    appState.techId = selectedTech.id;
    appState.techName = selectedTech.nombre;
    
    // Guardar el último técnico usado en la configuración
    await dbSet('config', { key: 'lastTech', id: appState.techId, name: appState.techName });
    await loadTechFolio(appState.techId);
  } else {
    // Si el nombre no coincide, resetear el folio al genérico
    appState.techId = null;
    appState.folio = 1;
    renderNum();
    if(name) notif('Técnico no reconocido. Sincronice la lista maestra.', 'err');
  }
}

// Carga el folio específico de un técnico
async function loadTechFolio(techId) {
    if (!techId) return;
    const key = `folio_${techId}`;
    const cfg = await dbGet('config', key);
    // Si no hay configuración para este técnico, empezar en 1 (o el valor guardado)
    appState.folio = cfg ? (cfg.value || 1) : 1;
    renderNum();
}

/* ------------------ Load lists for datalist and services ------------------ */
async function loadLists(){
  const clientes = await dbGetAll('clientes');
  const marcas = await dbGetAll('marcas');
  const modelos = await dbGetAll('modelos');
  const reps = await dbGetAll('repuestos');
  const tecnicos = await dbGetAll('tecnicos'); // NUEVO

  document.getElementById('cli-list').innerHTML = clientes.map(c => `<option value="${escapeHtml(c.nombre)}">`).join('');
  document.getElementById('marca-list').innerHTML = marcas.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('modelo-list').innerHTML = modelos.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('rep-list').innerHTML = reps.map(r => `<option value="${escapeHtml(r.nombre)}">`).join('');
  // Llenar datalist de técnicos
  document.getElementById('tech-list').innerHTML = tecnicos.map(t => `<option value="${escapeHtml(t.nombre)}">`).join(''); 
}

async function loadServices(){
  const servicios = await dbGetAll('servicios');
  const container = document.getElementById('trabChk');
  container.innerHTML = '';
  servicios.forEach((s, i) => {
    const d = document.createElement('div');
    d.className = 'chk-item';
    const id = `srv-${s.id || i}`;
    // Si 's' es un objeto {value: 'Servicio'}, usa s.value. Si es solo un string 'Servicio', usa s.
    const serviceValue = s.value || s; 
    d.innerHTML = `<input type="checkbox" id="${id}" value="${serviceValue}" onchange="updateTrab()">
                   <label for="${id}" style="margin:0;font-weight:500;width:100%">${escapeHtml(serviceValue)}</label>`;
    container.appendChild(d);
  });
  updateTrab();
}

/* ------------------ Autocomplete client selection ------------------ */
async function onClientSelect(){
  const nom = document.getElementById('cliNom').value.trim();
  if(!nom) return;
  const c = await dbGet('clientes', nom);
  if (c){
    document.getElementById('cliRut').value = c.rut || '';
    document.getElementById('cliDir').value = c.direccion || '';
    document.getElementById('cliCiu').value = c.ciudad || '';
    document.getElementById('cliCon').value = c.contacto || '';
    document.getElementById('cliMail').value = c.email || '';
    document.getElementById('cliTel').value = c.telefono || '';
  }
}

/* ------------------ Update trabajos resumen ------------------ */
function updateTrab(){
  const chk = document.querySelectorAll('#trabChk input:checked');
  const desc = document.getElementById('trabDesc');
  if(chk.length === 0){
    desc.textContent = 'No hay trabajos seleccionados';
    desc.style.color = 'var(--sub)';
  } else {
    desc.textContent = Array.from(chk).map(c => c.value).join(', ');
    desc.style.color = 'var(--text)';
  }
}

/* ------------------ Add / remove repuestos rows ------------------ */
function addRepInst(){
  const c = document.getElementById('repInst');
  const rows = c.querySelectorAll('.rep-row').length;
  if(rows >= 20){ notif('Máximo 20 repuestos', 'err'); return; }
  const d = document.createElement('div');
  d.className = 'rep-row';
  d.innerHTML = `<div><label>Repuesto</label><input type="text" class="rep-nom" list="rep-list" placeholder="Nombre repuesto"></div>
                 <div><label>Serie</label><input type="text" class="rep-ser" placeholder="N° Serie"></div>
                 <div style="align-self:center"><button class="btn-del" onclick="this.closest('.rep-row').remove()">Eliminar</button></div>`;
  c.appendChild(d);
}
function addRepRet(){
  const c = document.getElementById('repRet');
  const rows = c.querySelectorAll('.rep-row').length;
  if(rows >= 20){ notif('Máximo 20 repuestos', 'err'); return; }
  const d = document.createElement('div');
  d.className = 'rep-row';
  d.innerHTML = `<div><label>Repuesto</label><input type="text" class="rep-ret-nom" list="rep-list" placeholder="Nombre repuesto"></div>
                 <div><label>Serie</label><input type="text" class="rep-ret-ser" placeholder="N° Serie"></div>
                 <div style="align-self:center"><button class="btn-del" onclick="this.closest('.rep-row').remove()">Eliminar</button></div>`;
  c.appendChild(d);
}

/* ------------------ Save / Persist functions ------------------ */
async function saveClienteIfNew(cliObj){
  if(!cliObj || !cliObj.nombre) return;
  const exists = await dbGet('clientes', cliObj.nombre);
  await dbSet('clientes', Object.assign({}, exists || {}, cliObj));
  await loadLists();
}
async function saveMarcaIfNew(marca){
  if(!marca) return;
  const exists = await dbGet('marcas', marca);
  if(!exists) await dbSet('marcas', { nombre: marca });
  await loadLists();
}
async function saveModeloIfNew(mod){
  if(!mod) return;
  const exists = await dbGet('modelos', mod);
  if(!exists) await dbSet('modelos', { nombre: mod });
  await loadLists();
}
async function saveRepIfNew(r){
  if(!r) return;
  const exists = await dbGet('repuestos', r);
  if(!exists) await dbSet('repuestos', { nombre: r });
  await loadLists();
}

/* ------------------ Save order (offline-first) ------------------ */
async function save(){
  const saveBtn = document.getElementById('saveBtn');
  
  if (isSaving || saveBtn.disabled) return; // Control de concurrencia y visual

  isSaving = true;
  saveBtn.disabled = true; // Deshabilitar inmediatamente

  try {
    if (!appState.techId) {
      notif('Debe seleccionar su Nombre Técnico para generar el folio.', 'err');
      return;
    }
    
    const cliNom = document.getElementById('cliNom').value.trim();
    if(!cliNom){ notif('Ingrese el nombre del cliente', 'err'); return; }

    // 1. Construir el folio compuesto
    const folioActual = String(appState.folio).padStart(4,'0');
    const techPrefijo = String(appState.techId).padStart(2,'0');
    const correlativoCompleto = techPrefijo + folioActual; // Ej: 010006

    // Prepare client object & persist if new
    const cliData = {
      nombre: cliNom,
      rut: document.getElementById('cliRut').value.trim(),
      direccion: document.getElementById('cliDir').value.trim(),
      ciudad: document.getElementById('cliCiu').value.trim(),
      contacto: document.getElementById('cliCon').value.trim(),
      email: document.getElementById('cliMail').value.trim(),
      telefono: document.getElementById('cliTel').value.trim()
    };
    await saveClienteIfNew(cliData);

    // Collect repuestos
    const repInst = Array.from(document.querySelectorAll('#repInst .rep-row')).map(r => {
      return {
        nombre: (r.querySelector('.rep-nom')?.value || '').trim(),
        serie: (r.querySelector('.rep-ser')?.value || '').trim()
      };
    }).filter(x => x.nombre);
    const repRet = Array.from(document.querySelectorAll('#repRet .rep-row')).map(r => {
      return {
        nombre: (r.querySelector('.rep-ret-nom')?.value || '').trim(),
        serie: (r.querySelector('.rep-ret-ser')?.value || '').trim()
      };
    }).filter(x => x.nombre);

    // Trabajos
    const trab = Array.from(document.querySelectorAll('#trabChk input:checked')).map(cb => cb.value);

    // Equipo
    const orden = {
      // Usamos el folio compuesto
      numero: correlativoCompleto, 
      fecha: document.getElementById('fecha').value || new Date().toISOString().split('T')[0],
      cliente: cliData,
      equipo: {
        marca: document.getElementById('eqMarca').value.trim(),
        modelo: document.getElementById('eqMod').value.trim(),
        serie: document.getElementById('eqSer').value.trim(),
        condicion: document.getElementById('eqCond').value
      },
      contadores: {
        bn: document.getElementById('contBN').value || '0',
        color: document.getElementById('contColor').value || '0'
      },
      repInst, repRet, trab,
      obs: document.getElementById('obs').value.trim(),
      extra: { 
        tecnico: appState.techName, 
        clienteFirma: document.getElementById('nomCliFirma').value.trim(),
        idTecnico: appState.techId, // Guardamos el ID por si se necesita en el backend
        folioTecnico: appState.folio // Guardamos el folio simple (ej: 6)
      }
    };

    // Save reuso: add marca/modelo/repuestos to master lists
    if(orden.equipo.marca) await saveMarcaIfNew(orden.equipo.marca);
    if(orden.equipo.modelo) await saveModeloIfNew(orden.equipo.modelo);
    repInst.forEach(r => { if(r.nombre) saveRepIfNew(r.nombre); });
    repRet.forEach(r => { if(r.nombre) saveRepIfNew(r.nombre); });

    // Save order to ordenesPend (offline queue)
    await dbAdd('ordenesPend', orden);

    // Incremento y persistencia del número ESPECÍFICO DEL TÉCNICO
    appState.folio++;
    const newFolioKey = `folio_${appState.techId}`;
    await dbSet('config', { key: newFolioKey, value: appState.folio });
    
    // Update UI
    renderNum();

    notif(`Orden N°${correlativoCompleto} guardada`, 'ok');
    renderPendingBadge();
    
    // Limpiar campos (excepto fecha y técnico)
    document.querySelectorAll('input:not(#fecha):not(#nomTec):not(#num), textarea, select').forEach(i => {
      if(i.type === 'select-one') i.value = ''; else i.value = '';
    });
    document.querySelectorAll('#repInst .rep-row, #repRet .rep-row').forEach((r, i) => { 
      if (i > 0) r.remove(); // Deja solo la primera fila vacía
      r.querySelectorAll('input').forEach(i => i.value = '');
    });
    document.querySelectorAll('#trabChk input').forEach(c => c.checked = false);
    updateTrab();

    // Try sync immediately if online
    if(navigator.onLine) await sync();
  
  } catch (e) {
    console.error("Error al guardar la orden:", e);
    notif('Error crítico al guardar. Consulte la consola.', 'err');
  } finally {
    isSaving = false;
    saveBtn.disabled = false; // Re-habilitar el botón
  }
}

/* ------------------ Sync logic ------------------ */
async function renderPendingBadge(){
  const pend = await dbGetAll('ordenesPend');
  const badge = document.getElementById('badge');
  const syncBtn = document.getElementById('syncBtn');
  if(pend.length > 0){
    badge.textContent = pend.length;
    badge.style.display = 'inline-block';
    syncBtn.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
    syncBtn.style.display = 'none';
  }
}

async function sync(){
  if(isSyncing) return; // Salir si ya hay una sincronización en curso
  if(!navigator.onLine) { notif('Sin conexión — pendiente', 'err'); return; }
  const pend = await dbGetAll('ordenesPend');
  if(pend.length === 0){ notif('No hay órdenes pendientes', 'ok'); return; }

  isSyncing = true; // Establecer bandera
  showStatus('Sincronizando...');
  let successes = 0, failures = 0;
  
  try { // Usar try/finally para garantizar que la bandera se restablezca
    for(const o of pend){
      try {
        const res = await fetch(URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'saveOrden', data: o })
        });
        const json = await res.json();
        if(json && json.success){
          await dbDelete('ordenesPend', o.id);
          successes++;
        } else {
          failures++;
          console.warn('Fallo server', o, json);
        }
      } catch (e){
        failures++;
        console.warn('Error enviando', e);
      }
    }
  } finally {
    isSyncing = false; // Restablecer bandera
  }

  await renderPendingBadge();
  showStatus('Conectado');
  if(successes > 0) notif(`Enviadas ${successes} órdenes`, 'ok');
  if(failures > 0) notif(`${failures} fallidas`, 'err');
}

/* Pull masters from Google Sheet (loadData) */
async function syncServer(){
  if(!navigator.onLine) { showStatus('Offline'); return; }
  try {
    showStatus('Actualizando...');
    // Enviamos el ID del técnico actual al servidor
    const r = await fetch(`${URL}?action=loadData&techId=${appState.techId || ''}`);
    const data = await r.json();
    if(!data.success){ showStatus('Sin datos server'); return; }

    // 1. Cargar y actualizar técnicos
    if(Array.isArray(data.tecnicos)) { 
      await dbDelAll('tecnicos'); // Limpiar para evitar duplicados si se actualizan IDs
      for(const t of data.tecnicos) await dbSet('tecnicos', t); 
    }
    
    // 2. Cargar otras listas
    if(Array.isArray(data.cli)) {
      for(const c of data.cli){
        if(!c || !c.nombre) continue;
        await dbSet('clientes', c);
      }
    }
    if(Array.isArray(data.marcas)) for(const m of data.marcas) await dbSet('marcas',{nombre:m});
    if(Array.isArray(data.modelos)) for(const m of data.modelos) await dbSet('modelos',{nombre:m});
    if(Array.isArray(data.reps)) for(const r of data.reps) await dbSet('repuestos',{nombre:r});
    if(Array.isArray(data.servs)){
      await dbDelAll('servicios'); // Limpiar la lista de servicios antes de volver a agregar
      for(const s of data.servs) await dbAdd('servicios', { value: s });
    }
    
    // 3. Corregir el correlativo específico del técnico actual
    if(appState.techId && data.lastNumTech){
        const serverNum = parseInt(data.lastNumTech, 10);
        const folioKey = `folio_${appState.techId}`;
        
        // Si el número del servidor es válido y es mayor o igual al que tengo localmente
        if(!isNaN(serverNum) && serverNum >= appState.folio){
           appState.folio = serverNum + 1;
           await dbSet('config', { key: folioKey, value: appState.folio });
           renderNum();
           notif(`Folio de ${appState.techName} actualizado.`, 'ok');
        }
    }

    await loadLists();
    await loadServices();
    showStatus('Actualizado');
  } catch (e){
    console.warn('syncServer error', e);
    showStatus('Error de conexión', true);
  }
}

/* ------------------ Utilities ------------------ */
function toggle(hdr){ const cnt = hdr.nextElementSibling; if(!cnt) return; cnt.style.display = (cnt.style.display === 'none' || cnt.style.display === '') ? 'block' : 'none'; }
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* ------------------ Status & connectivity ------------------ */
function updateStatus(){
  // Solo actualiza el estado. La sincronización se maneja por eventos o por 'save()'
  if(navigator.onLine){ showStatus('Conectado'); } else { showStatus('Offline', true); }
}

/* ------------------ Small UX: autosave marca/modelo/repuesto on leave ------------------ */
document.addEventListener('focusout', async (e) => {
  const t = e.target;
  if(t.id === 'eqMarca' && t.value.trim()) await saveMarcaIfNew(t.value.trim());
  if(t.id === 'eqMod' && t.value.trim()) await saveModeloIfNew(t.value.trim());
  if(t.classList.contains('rep-nom') && t.value.trim()) await saveRepIfNew(t.value.trim());
  if(t.classList.contains('rep-ret-nom') && t.value.trim()) await saveRepIfNew(t.value.trim());
});

window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.exp .exp-cnt').forEach(c => c.style.display = 'block');
});
</script>

<!--
TESTING CHECKLIST:
☐ Smartphone 375px (iPhone SE)
☐ Smartphone 428px (iPhone 14 Pro Max)
☐ Tablet 768px (iPad)
☐ Desktop 1024px+
☐ Print preview Chrome/Firefox
☐ PDF generado en formato carta
☐ Funciones JS: save(), sync(), addRepInst(), addRepRet()
☐ IndexedDB: guardado offline
☐ Sincronización online
☐ Accesibilidad: navegación teclado
-->

</body>
</html>
