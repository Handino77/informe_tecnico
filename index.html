<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Orden de Servicio Técnico - Realtech SpA</title>
<link rel="icon" type="image/png" href="logo_realtech.png">

<style>
  /* --- ESTILOS BASE --- */
  body {
    font-family: Arial, sans-serif;
    background-color: #f0f0f0; 
    margin: 0;
    padding: 20px 0;
    display: flex;
    justify-content: center;
  }

  .documento {
    background-color: white;
    width: 95%;
    max-width: 21.59cm;
    min-height: 27.94cm;
    padding: 0.8cm 1cm;
    box-sizing: border-box;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: flex-start; 
    overflow: visible;
  }

  /* Barra de estado conexión */
  .status-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #004a99;
    color: white;
    font-size: 12px;
    padding: 6px 12px;
    text-align: center;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .status-bar.offline { background: #cc0000; }
  .sync-btn {
    background: rgba(255,255,255,0.3);
    border: none;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
  }
  .pendientes-count {
    background: #ff9800;
    color: white;
    border-radius: 12px;
    padding: 2px 8px;
    font-weight: bold;
    margin-left: 8px;
  }

  /* Header */
  .header {
    border-bottom: 2px solid #004a99;
    padding-bottom: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .logo-area { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-grow: 1; }
  .logo img { width: 75px; display: block; } 
  
  .empresa-info { font-size: 9px; color: #000; line-height: 1.2; }
  .empresa-nombre { font-size: 13px; font-weight: bold; color: #004a99; display: block; }
  .titulo-doc { text-align: right; }
  .titulo-doc h1 { font-size: 16px; margin: 0; color: #004a99; }
  .numero-cotizacion { font-size: 12px; font-weight: bold; color: #004a99; margin-bottom: 2px; }
  .fecha-box { font-size: 9px; margin-top: 3px; font-weight: bold; color: #333; }
  .fecha-box input {
    border: none; background: transparent; font-size: 9px; font-weight: bold; 
    color: #333; padding: 0; width: 90px; outline: none;
  }

  /* Títulos de Sección */
  h2 {
    font-size: 9px; background: #f0f0f0; padding: 3px 6px;
    border-left: 3px solid #004a99; text-transform: uppercase;
    color: #222; margin-bottom: 5px; margin-top: 8px;
  }

  /* Grid Cliente */
  .grid-cliente {
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 4px 8px; 
    margin-bottom: 8px;
  }
  .full-width { grid-column: 1 / -1; }
  .two-col { grid-column: span 2; }

  label {
    display: block; font-size: 7px; font-weight: bold;
    color: #004a99; margin-bottom: 1px; text-transform: uppercase;
  }
  input, textarea, select {
    width: 100%; border: none; border-bottom: 1px solid #ccc;
    padding: 2px 0; font-size: 10px; outline: none; background: transparent;
  }

  /* Secciones Expandibles */
  .expandible-section {
    margin-bottom: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
  }
  .expandible-header {
    background: #f5f5f5;
    padding: 5px 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 9px;
    font-weight: bold;
    color: #004a99;
  }
  .expandible-header:hover { background: #e8e8e8; }
  .expandible-content {
    padding: 8px;
    display: none;
    background: #fafafa;
  }
  .expandible-content.active { display: block; }
  
  .repuesto-row {
    display: grid;
    grid-template-columns: 2fr 1fr 30px;
    gap: 5px;
    margin-bottom: 5px;
    align-items: end;
  }
  
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
  }
  .checkbox-item input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  
  .trabajo-descripcion {
    grid-column: 1 / -1;
    background: white;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 3px;
    min-height: 40px;
    font-size: 9px;
    margin-top: 5px;
    color: #999;
  }

  /* Footer */
  .footer-section { flex-shrink: 0; margin-top: 15px; }
  .obs-section { margin-bottom: 15px; }
  .obs-section textarea { min-height: 60px; font-size: 9px; resize: none; overflow: hidden; }
  
  .grid-firmas {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 10px;
  }
  
  .firma-box {
    display: flex;
    flex-direction: column;
  }
  
  .firma-box input {
    margin-bottom: 40px;
  }
  
  .firma-linea {
    border-top: 1px solid #333;
    padding-top: 5px;
    text-align: center;
    font-size: 8px;
    color: #666;
    font-weight: bold;
  }

  /* Botones */
  .botonera { 
    position: fixed; 
    bottom: 15px; 
    right: 15px; 
    display: flex; 
    gap: 8px; 
    z-index: 100; 
  }
  button { 
    padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; 
    font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
    font-size: 11px;
  }
  .btn-azul { background: #004a99; color: white; }
  .btn-gris { background: white; color: #333; }
  .btn-guardar { background: #38a169; color: white; }
  .btn-borrar { 
    background: #cc0000; color: white; width: 20px; height: 20px; 
    padding: 0; border-radius: 3px; font-size: 10px; 
  }

  /* Notificación */
  .notificacion {
    position: fixed;
    top: 60px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    font-weight: bold;
    z-index: 1000;
    display: none;
    animation: slideIn 0.3s ease-out;
  }
  .notificacion.exito { background: #38a169; color: white; }
  .notificacion.error { background: #cc0000; color: white; }
  
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Responsive */
  @media (min-width: 769px) {
    .documento {
      padding: 0.8cm 1.2cm; 
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .logo img { width: 85px; }
    .empresa-info { font-size: 10px; }
  }

  /* Impresión */
  @media print {
    @page { margin: 0.5cm !important; size: letter; }
    body { margin: 0; padding: 0; background: white; }
    .documento {
      width: 100%; 
      box-shadow: none;
      padding: 0.5cm 0.8cm !important; 
      margin: 0;
    }
    .botonera, .btn-borrar, .notificacion, .status-bar { display: none !important; } 
    input, textarea, select, .fecha-box input {
      background: transparent !important; border: none !important; 
      padding: 0 !important;
    }
    input::placeholder { color: transparent; }
    h2, th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .expandible-content { display: block !important; }
    .toggle-icon { display: none; }
  }
</style>
</head>
<body>

<!-- Barra de estado conexión -->
<div class="status-bar" id="statusBar">
  <span id="statusText">Cargando estado de conexión...</span>
  <div>
    <span id="pendientesBadge" class="pendientes-count" style="display:none">0</span>
    <button class="sync-btn" id="btnSync" onclick="sincronizarPendientes()" style="display:none">
      Sincronizar
    </button>
  </div>
</div>

<div class="notificacion" id="notificacion"></div>

<div class="botonera">
  <button class="btn-gris" onclick="agregarRepuestoInstalado()">+ Rep. Instalado</button>
  <button class="btn-gris" onclick="agregarRepuestoRetirado()">+ Rep. Retirado</button>
  <button class="btn-guardar" onclick="guardarOrden()">Guardar</button>
  <button class="btn-azul" onclick="window.print()">Imprimir</button>
</div>

<div class="documento">
  
  <div class="header">
    <div class="logo-area">
      <div class="logo">
        <img src="logo_realtech.png" alt="Logo" onerror="this.style.display='none'">
      </div>
      <div class="empresa-info">
        <span class="empresa-nombre">Realtech SpA</span>
        <strong>RUT: 77.651.114-5</strong><br>
        Arturo Prat 780 of 203A, Temuco<br>
        realtech.spa@gmail.com | +56 9 3957 3029
      </div>
    </div>
    <div class="titulo-doc">
      <div class="numero-cotizacion" id="numeroCotizacion">N° 0001</div>
      <h1>Orden de Servicio Técnico</h1>
      <div class="fecha-box">
        Emisión: <input type="date" id="fechaInput">
      </div>
    </div>
  </div>

  <h2>Información del Cliente y Equipo</h2>
  <div class="grid-cliente">
    <div class="campo two-col">
      <label>Cliente / Empresa</label>
      <input type="text" id="clienteNombre" list="clientes-list" placeholder="Nombre del cliente..." onchange="autocompletarCliente()">
    </div>
    <div class="campo">
      <label>RUT</label>
      <input type="text" id="clienteRut" placeholder="XX.XXX.XXX-X" oninput="formatearRut(this)">
    </div>
    <div class="campo">
      <label>Dirección</label>
      <input type="text" id="clienteDireccion" placeholder="Dirección">
    </div>
    <div class="campo">
      <label>Ciudad</label>
      <input type="text" id="clienteCiudad" placeholder="Ciudad">
    </div>
    <div class="campo">
      <label>Contacto</label>
      <input type="text" id="clienteContacto" placeholder="Atención a...">
    </div>
    <div class="campo">
      <label>Email</label>
      <input type="text" id="clienteEmail" placeholder="correo@ejemplo.com">
    </div>
    <div class="campo">
      <label>Teléfono</label>
      <input type="text" id="clienteTelefono" placeholder="+56 9...">
    </div>
    <div class="campo">
      <label>Marca Equipo</label>
      <input type="text" id="equipoMarca" list="marcas-list" placeholder="Seleccionar marca..." onchange="guardarNuevaMarca(this.value)">
    </div>
    <div class="campo">
      <label>Modelo</label>
      <input type="text" id="equipoModelo" list="modelos-list" placeholder="Modelo" onchange="guardarNuevoModelo(this.value)">
    </div>
    <div class="campo">
      <label>Serie</label>
      <input type="text" id="equipoSerie" placeholder="N° de serie">
    </div>
  </div>

  <!-- Repuestos Instalados -->
  <div class="expandible-section">
    <div class="expandible-header" onclick="toggleExpandible(this)">
      <span>Repuestos Instalados</span>
      <span class="toggle-icon">▼</span>
    </div>
    <div class="expandible-content">
      <div id="repuestosInstaladosContainer">
        <div class="repuesto-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="repuesto-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="repuesto-serie" placeholder="N° Serie">
          </div>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Repuestos Retirados -->
  <div class="expandible-section">
    <div class="expandible-header" onclick="toggleExpandible(this)">
      <span>Repuestos Retirados</span>
      <span class="toggle-icon">▼</span>
    </div>
    <div class="expandible-content">
      <div id="repuestosRetiradosContainer">
        <div class="repuesto-row">
          <div>
            <label>Repuesto</label>
            <input type="text" class="repuesto-retirado-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)">
          </div>
          <div>
            <label>Serie (opcional)</label>
            <input type="text" class="repuesto-retirado-serie" placeholder="N° Serie">
          </div>
          <div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trabajo Realizado -->
  <div class="expandible-section">
    <div class="expandible-header" onclick="toggleExpandible(this)">
      <span>Trabajo Realizado</span>
      <span class="toggle-icon">▼</span>
    </div>
    <div class="expandible-content">
      <div class="checkbox-grid" id="trabajosCheckboxContainer">
        <!-- Cargado dinámicamente -->
      </div>
      <div class="trabajo-descripcion" id="trabajoDescripcion">
        No hay trabajos seleccionados
      </div>
    </div>
  </div>

  <h2>Observaciones Adicionales</h2>
  <div class="obs-section">
    <textarea id="obs" placeholder="Detalles de la atención que no están registrados en los menús desplegables..."></textarea>
  </div>

  <div class="footer-section">
    <h2>Firmas y Conformidad</h2>
    <div class="grid-firmas">
      <div class="firma-box">
        <label>Nombre Técnico</label>
        <input type="text" id="nombreTecnico" placeholder="Nombre completo del técnico">
        <div class="firma-linea">
          <span>Firma Técnico</span>
        </div>
      </div>
      <div class="firma-box">
        <label>Nombre Cliente</label>
        <input type="text" id="nombreClienteFirma" placeholder="Nombre completo del cliente">
        <div class="firma-linea">
          <span>Firma Cliente</span>
        </div>
      </div>
    </div>
  </div>

</div>

<datalist id="repuestos-list"></datalist>
<datalist id="clientes-list"></datalist>
<datalist id="marcas-list"></datalist>
<datalist id="modelos-list"></datalist>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwyqXa2XfVGD4-hMFaTrPirp-m3C8DECp3OLsxAYKhTXSoUh-6C9bM7x3_RIcfCNMFidQ/exec';
  
  let cachedClients = [];
  let cachedMarcas = [];
  let cachedModelos = [];
  let cachedRepuestos = [];
  let cachedServicios = [];
  let numeroActual = 1;
  let ordenesPendientes = [];

  // ========================
  //  INICIO
  // ========================
  window.addEventListener('DOMContentLoaded', () => {
    cargarDatosLocal();
    actualizarIndicadorConexion();
    cargarOrdenesPendientes();
    setInterval(actualizarIndicadorConexion, 5000);
    window.addEventListener('online', actualizarIndicadorConexion);
    window.addEventListener('offline', actualizarIndicadorConexion);
  });

  function cargarDatosLocal() {
    const saved = localStorage.getItem('realtechDB');
    if (saved) {
      const data = JSON.parse(saved);
      cachedClients = data.clientes || [];
      cachedMarcas = data.marcas || [];
      cachedModelos = data.modelos || [];
      cachedRepuestos = data.repuestos || [];
      cachedServicios = data.servicios || [];
      numeroActual = data.correlativo || 1;
    }

    document.getElementById('fechaInput').value = new Date().toISOString().split('T')[0];
    document.getElementById('numeroCotizacion').textContent = `N° ${String(numeroActual).padStart(4, '0')}`;

    actualizarDataLists();
    cargarServiciosCheckboxes();
  }

  function guardarTodoLocalmente() {
    const db = {
      clientes: cachedClients,
      marcas: cachedMarcas,
      modelos: cachedModelos,
      repuestos: cachedRepuestos,
      servicios: cachedServicios,
      correlativo: numeroActual
    };
    localStorage.setItem('realtechDB', JSON.stringify(db));
  }

  // ========================
  //  ÓRDENES PENDIENTES
  // ========================
  function cargarOrdenesPendientes() {
    const saved = localStorage.getItem('ordenesPendientes');
    ordenesPendientes = saved ? JSON.parse(saved) : [];
    actualizarBadgePendientes();
  }

  function guardarOrdenPendiente(orden) {
    ordenesPendientes.push(orden);
    localStorage.setItem('ordenesPendientes', JSON.stringify(ordenesPendientes));
    actualizarBadgePendientes();
  }

  function eliminarOrdenPendiente(index) {
    ordenesPendientes.splice(index, 1);
    localStorage.setItem('ordenesPendientes', JSON.stringify(ordenesPendientes));
    actualizarBadgePendientes();
  }

  function actualizarBadgePendientes() {
    const badge = document.getElementById('pendientesBadge');
    const btn = document.getElementById('btnSync');
    if (ordenesPendientes.length > 0) {
      badge.textContent = ordenesPendientes.length;
      badge.style.display = 'inline';
      btn.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
      btn.style.display = 'none';
    }
  }

  // ========================
  //  SINCRONIZACIÓN
  // ========================
  async function sincronizarDatosServidor() {
    if (!navigator.onLine) return false;
    try {
      const response = await fetch(`${APPS_SCRIPT_URL}?action=loadData`);
      const remoto = await response.json();
      if (remoto.success) {
        cachedClients = unirSinDuplicados(cachedClients, remoto.clientes || [], 'nombre');
        cachedMarcas   = unirSinDuplicados(cachedMarcas,   remoto.marcas || []);
        cachedModelos  = unirSinDuplicados(cachedModelos,  remoto.modelos || []);
        cachedRepuestos= unirSinDuplicados(cachedRepuestos,remoto.repuestos || []);
        cachedServicios= remoto.servicios || cachedServicios;
        numeroActual = Math.max(numeroActual, (remoto.correlativo || 0) + 1);
        guardarTodoLocalmente();
        actualizarDataLists();
        cargarServiciosCheckboxes();
        return true;
      }
    } catch (e) { console.warn('Error sincronizando datos base', e); }
    return false;
  }

  function unirSinDuplicados(localArray, remotoArray, key = null) {
    const set = new Set(localArray.map(i => key ? i[key] || i : i));
    remotoArray.forEach(item => {
      const valor = key ? item[key] || item : item;
      if (!set.has(valor)) {
        set.add(valor);
        localArray.push(item);
      }
    });
    return localArray;
  }

  async function sincronizarPendientes() {
    if (!navigator.onLine || ordenesPendientes.length === 0) return;
    document.getElementById('btnSync').disabled = true;
    document.getElementById('btnSync').textContent = 'Enviando...';

    let enviadas = 0;
    let errores = 0;

    for (let i = 0; i < ordenesPendientes.length; i++) {
      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveOrden', data: ordenesPendientes[i] })
        });
        const result = await response.json();
        if (result.success) {
          enviadas++;
          eliminarOrdenPendiente(i);
          i--;
        } else errores++;
      } catch (e) { errores++; }
    }

    await sincronizarDatosServidor();

    document.getElementById('btnSync').disabled = false;
    document.getElementById('btnSync').textContent = 'Sincronizar';

    if (enviadas > 0) mostrarNotificacion(`Enviadas ${enviadas} órdenes`, 'exito');
    if (errores > 0) mostrarNotificacion(`${errores} órdenes fallidas`, 'error');
  }

  function actualizarIndicadorConexion() {
    const bar = document.getElementById('statusBar');
    const text = document.getElementById('statusText');
    if (navigator.onLine) {
      bar.classList.remove('offline');
      text.textContent = 'Conectado';
      sincronizarPendientes();
    } else {
      bar.classList.add('offline');
      text.textContent = 'Sin conexión - Modo offline';
    }
  }

  // ========================
  //  GUARDAR ORDEN (offline-first)
  // ========================
  async function guardarOrden() {
    const clienteNombre = document.getElementById('clienteNombre').value.trim();
    if (!clienteNombre) {
      mostrarNotificacion('Ingrese el nombre del cliente', 'error');
      return;
    }

    const clienteData = {
      nombre: clienteNombre,
      rut: document.getElementById('clienteRut').value.trim(),
      direccion: document.getElementById('clienteDireccion').value.trim(),
      ciudad: document.getElementById('clienteCiudad').value.trim(),
      contacto: document.getElementById('clienteContacto').value.trim(),
      email: document.getElementById('clienteEmail').value.trim(),
      telefono: document.getElementById('clienteTelefono').value.trim()
    };

    if (!cachedClients.some(c => c.nombre === clienteNombre)) {
      cachedClients.push(clienteData);
      guardarTodoLocalmente();
      actualizarDataLists();
    }

    const repuestosInstalados = [];
    document.querySelectorAll('#repuestosInstaladosContainer .repuesto-row').forEach(row => {
      const nombre = row.querySelector('.repuesto-nombre').value.trim();
      const serie = row.querySelector('.repuesto-serie')?.value.trim() || '';
      if (nombre) repuestosInstalados.push({nombre, serie});
    });

    const repuestosRetirados = [];
    document.querySelectorAll('#repuestosRetiradosContainer .repuesto-row').forEach(row => {
      const nombre = row.querySelector('.repuesto-retirado-nombre').value.trim();
      const serie = row.querySelector('.repuesto-retirado-serie')?.value.trim() || '';
      if (nombre) repuestosRetirados.push({nombre, serie});
    });

    const trabajosRealizados = Array.from(
      document.querySelectorAll('#trabajosCheckboxContainer input[type="checkbox"]:checked')
    ).map(cb => cb.value);

    const ordenData = {
      numero: numeroActual,
      fecha: document.getElementById('fechaInput').value || new Date().toISOString().split('T')[0],
      cliente: clienteData,
      equipo: {
        marca: document.getElementById('equipoMarca').value.trim(),
        modelo: document.getElementById('equipoModelo').value.trim(),
        serie: document.getElementById('equipoSerie').value.trim()
      },
      repuestosInstalados,
      repuestosRetirados,
      trabajosRealizados,
      observaciones: document.getElementById('obs').value.trim()
    };

    guardarOrdenPendiente(ordenData);
    numeroActual++;
    document.getElementById('numeroCotizacion').textContent = `N° ${String(numeroActual).padStart(4, '0')}`;
    guardarTodoLocalmente();

    mostrarNotificacion(`Orden N°${String(numeroActual-1).padStart(4,'0')} guardada localmente`, 'exito');

    if (navigator.onLine) await sincronizarPendientes();
  }

  // ========================
  //  FUNCIONES AUXILIARES (igual que antes)
  // ========================
  function mostrarNotificacion(mensaje, tipo = 'exito') {
    const notif = document.getElementById('notificacion');
    notif.textContent = mensaje;
    notif.className = `notificacion ${tipo}`;
    notif.style.display = 'block';
    setTimeout(() => notif.style.display = 'none', 4000);
  }

  function formatearRut(input) {
    let valor = input.value.replace(/[^0-9kK]/g, '');
    if (valor.length === 0) return;
    let cuerpo = valor.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    let dv = valor.slice(-1).toUpperCase();
    input.value = cuerpo ? `${cuerpo}-${dv}` : '';
  }

  function autocompletarCliente() {
    const nombreInput = document.getElementById('clienteNombre').value;
    const cliente = cachedClients.find(c => c.nombre === nombreInput);
    if (cliente) {
      document.getElementById('clienteRut').value = cliente.rut || '';
      document.getElementById('clienteDireccion').value = cliente.direccion || '';
      document.getElementById('clienteCiudad').value = cliente.ciudad || '';
      document.getElementById('clienteContacto').value = cliente.contacto || '';
      document.getElementById('clienteEmail').value = cliente.email || '';
      document.getElementById('clienteTelefono').value = cliente.telefono || '';
    }
  }

  function guardarNuevaMarca(marca) { if (marca && !cachedMarcas.includes(marca)) { cachedMarcas.push(marca); guardarTodoLocalmente(); actualizarDataLists(); } }
  function guardarNuevoModelo(modelo) { if (modelo && !cachedModelos.includes(modelo)) { cachedModelos.push(modelo); guardarTodoLocalmente(); actualizarDataLists(); } }
  function guardarNuevoRepuesto(repuesto) { if (repuesto && !cachedRepuestos.includes(repuesto)) { cachedRepuestos.push(repuesto); guardarTodoLocalmente(); actualizarDataLists(); } }

  function actualizarDataLists() {
    document.getElementById('clientes-list').innerHTML = cachedClients.map(c => `<option value="${c.nombre}">`).join('');
    document.getElementById('marcas-list').innerHTML = cachedMarcas.map(m => `<option value="${m}">`).join('');
    document.getElementById('modelos-list').innerHTML = cachedModelos.map(m => `<option value="${m}">`).join('');
    document.getElementById('repuestos-list').innerHTML = cachedRepuestos.map(r => `<option value="${r}">`).join('');
  }

  function cargarServiciosCheckboxes() {
    const container = document.getElementById('trabajosCheckboxContainer');
    container.innerHTML = '';
    cachedServicios.forEach((servicio, index) => {
      const div = document.createElement('div');
      div.className = 'checkbox-item';
      div.innerHTML = `<input type="checkbox" id="trabajo${index}" value="${servicio}" onchange="actualizarTrabajoRealizado()">
                       <label for="trabajo${index}" style="text-transform:none;font-weight:normal;">${servicio}</label>`;
      container.appendChild(div);
    });
  }

  function actualizarTrabajoRealizado() {
    const checked = document.querySelectorAll('#trabajosCheckboxContainer input[type="checkbox"]:checked');
    const desc = document.getElementById('trabajoDescripcion');
    if (checked.length === 0) {
      desc.textContent = 'No hay trabajos seleccionados';
      desc.style.color = '#999';
    } else {
      desc.textContent = Array.from(checked).map(c => c.value).join(', ');
      desc.style.color = '#333';
    }
  }

  function toggleExpandible(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    content.classList.toggle('active');
    icon.textContent = content.classList.contains('active') ? '▲' : '▼';
  }

  function agregarRepuestoInstalado() {
    const container = document.getElementById('repuestosInstaladosContainer');
    if (container.querySelectorAll('.repuesto-row').length >= 10) { mostrarNotificacion('Máximo 10 repuestos', 'error'); return; }
    const div = document.createElement('div');
    div.className = 'repuesto-row';
    div.innerHTML = `
      <div><label>Repuesto</label><input type="text" class="repuesto-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)"></div>
      <div><label>Serie</label><input type="text" class="repuesto-serie" placeholder="N° Serie"></div>
      <button class="btn-borrar" onclick="this.parentElement.remove()">X</button>
    `;
    container.appendChild(div);
  }

  function agregarRepuestoRetirado() {
    const container = document.getElementById('repuestosRetiradosContainer');
    if (container.querySelectorAll('.repuesto-row').length >= 10) { mostrarNotificacion('Máximo 10 repuestos', 'error'); return; }
    const div = document.createElement('div');
    div.className = 'repuesto-row';
    div.innerHTML = `
      <div><label>Repuesto</label><input type="text" class="repuesto-retirado-nombre" list="repuestos-list" placeholder="Nombre del repuesto" onchange="guardarNuevoRepuesto(this.value)"></div>
      <div><label>Serie</label><input type="text" class="repuesto-retirado-serie" placeholder="N° Serie"></div>
      <button class="btn-borrar" onclick="this.parentElement.remove()">X</button>
    `;
    container.appendChild(div);
  }
</script>
</body>
</html>
