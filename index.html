<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Orden de Servicio Técnico - Realtech SpA</title>
<link rel="icon" href="logo_realtech.png" />
<style>
  /* --------- Diseño base responsive --------- */
  :root{
    --blue: #004a99;
    --blue-dark: #003370;
    --muted: #f8fafc;
    --accent: #38a169;
    --danger: #e53e3e;
    --card: #ffffff;
    --text: #1f2937;
    --sub: #64748b;
    --border: #e2e8f0;
    --radius: 10px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: #f1f5f9;
    color: var(--text);
    padding: 15px;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding-bottom: 100px;
  }

  .container {
    width: 100%;
    max-width: 980px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 25px;
    position: relative;
  }

  header {
    display: flex;
    gap: 20px;
    align-items: center;
    border-bottom: 2px solid var(--muted);
    padding-bottom: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .logo img { width: 80px; height: auto; border-radius: 6px; object-fit: contain; }
  .brand { flex: 1; min-width: 200px; }
  .brand h1 { margin: 0; font-size: 20px; color: var(--blue); line-height: 1.2; }
  .brand p { margin: 4px 0 0; font-size: 13px; color: var(--sub); line-height: 1.4; }
  
  .meta { 
    text-align: right; 
    min-width: 140px; 
    background: var(--muted);
    padding: 10px;
    border-radius: 8px;
  }
  .meta .num { font-weight: 800; color: var(--blue); font-size: 18px; margin-bottom: 4px; }
  .meta .fecha { font-size: 13px; color: var(--sub); display: flex; flex-direction: column; align-items: flex-end; }
  .meta .fecha input { text-align: right; padding: 4px; border: none; background: transparent; font-weight: 600; color: var(--sub); }

  .grid, .grid-eq {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
    align-items: end;
  }

  label { display: block; font-size: 12px; color: var(--blue); font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  
  input[type="text"], input[type="date"], input[type="number"], textarea, select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: all 0.2s;
    height: 42px;
  }
  input:focus, textarea:focus, select:focus {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
  }
  textarea { min-height: 80px; resize: vertical; height: auto; }

  .section-title { margin: 25px 0 10px; }
  .section-title h2 {
    margin: 0; font-size: 14px;
    background: #f0f7ff;
    padding: 10px 15px;
    border-radius: 6px;
    border-left: 5px solid var(--blue);
    color: var(--blue);
    text-transform: uppercase;
  }

  .btn-section-add {
    background: #fff;
    border: 1px solid var(--border);
    color: var(--blue);
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    width: 100%;
    margin-top: 15px;
    transition: background 0.2s;
  }
  .btn-section-add:hover { background: var(--muted); }

  .exp { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; }
  
  .rep-row {
    display: grid;
    grid-template-columns: 1fr 140px 40px;
    gap: 10px;
    align-items: end;
    margin-bottom: 12px;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  .btn-del {
    background: #fee2e2; color: var(--danger);
    border: none; border-radius: 6px;
    height: 42px; width: 100%;
    font-weight: bold; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  /* Estilo para el área de Trabajo Realizado */
  .trab-desc { 
    margin-top: 10px; 
    padding: 12px; 
    background: #fff; 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    color: var(--text); 
    font-size: 15px; 
    line-height: 1.5;
    width: 100%;
    min-height: 100px;
  }

  .footer { margin-top: 30px; border-top: 2px solid var(--muted); padding-top: 20px; }
  .firmas {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }
  .firma-line { margin-top: 5px; border-top: 1px dashed var(--sub); padding-top: 5px; font-size: 11px; text-align: center; color: var(--sub); text-transform: uppercase; }

  .controls {
    position: fixed;
    bottom: 20px; right: 20px;
    display: flex; flex-direction: column; gap: 10px;
    z-index: 1000;
  }
  .controls button {
    padding: 12px 20px;
    border-radius: 50px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transition: transform 0.1s;
    min-width: 160px;
    text-align: center;
  }
  .btn-save { background: var(--accent); color: #fff; }
  .btn-blue { background: var(--blue); color: #fff; }

  .statusbar {
    position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
    padding: 8px 16px;
    border-radius: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    z-index: 1100;
    display: flex; gap: 10px; align-items: center; font-size: 13px;
    border: 1px solid var(--border);
    width: max-content;
    max-width: 90%;
  }

  /* NUEVO: Ocultar elementos en impresión */
  @media print {
    .no-print { display: none !important; }
    body, .container { background: #fff; margin: 0; padding: 0; box-shadow: none; width: 100%; max-width: 100%; }
    .controls, .statusbar, .btn-section-add { display: none !important; }
    .section-title h2 { background: none; border: none; padding-left: 0; color: #000; border-bottom: 2px solid #000; }
    input, textarea, select { border: none; padding: 0; font-family: inherit; font-size: 12px; height: auto; }
    .rep-row { border: none; padding: 0; margin-bottom: 5px; grid-template-columns: 2fr 1fr 0px; }
    .btn-del { display: none; }
    header { border-bottom: 1px solid #000; }
    textarea.trab-desc { border: 1px solid #eee; padding: 5px; }
  }

  @media (max-width: 768px) {
    body { padding-bottom: 140px; }
    .container { padding: 15px; }
    header { flex-direction: column; text-align: center; }
    .meta { width: 100%; display: flex; justify-content: space-between; }
    .grid, .grid-eq { grid-template-columns: 1fr; }
    .rep-row { grid-template-columns: 1fr; }
    .firmas { grid-template-columns: 1fr; }
    .controls {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #fff; padding: 12px; flex-direction: row;
      border-top: 1px solid var(--border); border-radius: 0;
    }
    .controls button { flex: 1; min-width: auto; }
  }
</style>
</head>
<body>

<div class="statusbar" id="statusbar">
  <strong id="statusTxt">Cargando...</strong>
  <span id="badge" style="display:none;background:#f97316;color:#fff;padding:2px 6px;border-radius:10px;font-size:11px;">0</span>
  <button id="syncBtn" style="display:none;margin-left:6px;padding:4px 8px;border-radius:6px;border:none;background:#eef4ff;color:var(--blue);cursor:pointer;font-weight:bold;font-size:11px;">Sincronizar</button>
</div>

<div class="container">
  <header>
    <div class="logo"><img src="logo_realtech.png" alt="Realtech logo" onerror="this.style.display='none'"></div>
    <div class="brand">
      <h1>Realtech SpA — Orden de Servicio Técnico</h1>
      <p>RUT: 77.651.114-5 — Arturo Prat 780 of 203A, Temuco<br>realtech.spa@gmail.com</p>
    </div>
    <div class="meta">
      <div class="num" id="num">N° XXXX</div> 
      <div class="fecha">Emisión: <input type="date" id="fecha" /></div>
    </div>
  </header>

  <section>
    <div class="section-title"><h2>Información del Cliente</h2></div>
    <div class="grid">
      <div style="grid-column: 1/-1">
        <label for="cliNom">Cliente / Empresa</label>
        <input type="text" id="cliNom" list="cli-list" placeholder="Nombre del cliente..." autocomplete="off">
      </div>
      <div><label for="cliRut">RUT</label><input type="text" id="cliRut" placeholder="XX.XXX.XXX-X"></div>
      <div style="grid-column: 1/-1"><label for="cliDir">Dirección</label><input type="text" id="cliDir" placeholder="Dirección"></div>
      <div><label for="cliCiu">Ciudad</label><input type="text" id="cliCiu" placeholder="Ciudad"></div>
      <div><label for="cliCon">Contacto</label><input type="text" id="cliCon" placeholder="Atención a..."></div>
      <div style="grid-column: 1/-1"><label for="cliMail">Email</label><input type="text" id="cliMail" placeholder="correo@ejemplo.com"></div>
      <div><label for="cliTel">Teléfono</label><input type="text" id="cliTel" placeholder="+56 9 ..."></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Información del Equipo</h2></div>
    <div class="grid-eq">
      <div><label for="eqMarca">Marca Equipo</label><input type="text" id="eqMarca" list="marca-list" placeholder="Marca..." /></div>
      <div><label for="eqMod">Modelo</label><input type="text" id="eqMod" list="modelo-list" placeholder="Modelo" /></div>
      <div><label for="eqSer">Serie</label><input type="text" id="eqSer" placeholder="N° de serie" /></div>
      <div><label for="eqCond">Condición</label>
        <select id="eqCond">
          <option value="">Seleccionar...</option>
          <option value="Arriendo">Arriendo</option>
          <option value="Venta">Venta</option>
        </select>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div><label for="contBN">Contador B/N</label><input type="number" id="contBN" placeholder="0"></div>
      <div><label for="contColor">Contador Color</label><input type="number" id="contColor" placeholder="0"></div>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Repuestos Instalados</h2></div>
    <div class="exp">
      <div id="repInst">
        <div class="rep-row">
          <div><label>Repuesto</label><input type="text" class="rep-nom" list="rep-list" placeholder="Nombre del repuesto"></div>
          <div><label>Serie (opcional)</label><input type="text" class="rep-ser" placeholder="N° Serie"></div>
          <div style="align-self:center"><button class="btn-del" onclick="this.closest('.rep-row').remove()">X</button></div>
        </div>
      </div>
      <button type="button" class="btn-section-add" onclick="addRepInst()">+ Agregar Repuesto Instalado</button>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Trabajo Realizado</h2></div>
    <div class="exp">
        <div class="no-print" style="margin-bottom: 10px;">
            <label>Seleccionar Trabajo</label>
            <select id="trabSelect" onchange="addTrabFromSelect()">
                <option value="">-- Seleccione para agregar --</option>
            </select>
        </div>
        <label>Detalle de trabajos (puedes escribir directamente):</label>
        <textarea class="trab-desc" id="trabDesc" placeholder="Seleccione del menú o escriba aquí..."></textarea>
    </div>
  </section>

  <section>
    <div class="section-title"><h2>Observaciones</h2></div>
    <textarea id="obs" placeholder="Detalles de la atención..."></textarea>
  </section>

  <div class="footer">
    <div class="firmas">
      <div><label>Nombre Técnico</label><input type="text" id="nomTec" list="tech-list"><div class="firma-line">Firma Técnico</div></div>
      <div><label>Nombre Cliente</label><input type="text" id="nomCliFirma"><div class="firma-line">Firma Cliente</div></div>
    </div>
  </div>
</div>

<datalist id="rep-list"></datalist>
<datalist id="cli-list"></datalist>
<datalist id="marca-list"></datalist>
<datalist id="modelo-list"></datalist>
<datalist id="tech-list"></datalist>

<div class="controls">
  <button class="btn-blue" onclick="window.print()">Imprimir</button>
  <button class="btn-save" id="saveBtn" onclick="save()">GUARDAR</button>
</div>

<script>
/* ------------------ CONFIG ------------------ */
const URL = 'https://informes-realtech.realtech-spa.workers.dev/';
let isSyncing = false;
let isSaving = false; 
let db = null;
let appState = { folio: 1, techId: null, techName: null };

const req = indexedDB.open('RealtechDB', 4);
req.onupgradeneeded = (e) => {
  const idb = e.target.result;
  if (!idb.objectStoreNames.contains('clientes')) idb.createObjectStore('clientes', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('marcas')) idb.createObjectStore('marcas', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('modelos')) idb.createObjectStore('modelos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('repuestos')) idb.createObjectStore('repuestos', { keyPath: 'nombre' });
  if (!idb.objectStoreNames.contains('servicios')) idb.createObjectStore('servicios', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('ordenesPend')) idb.createObjectStore('ordenesPend', { keyPath: 'id', autoIncrement: true });
  if (!idb.objectStoreNames.contains('config')) idb.createObjectStore('config', { keyPath: 'key' });
  if (!idb.objectStoreNames.contains('tecnicos')) idb.createObjectStore('tecnicos', { keyPath: 'id' });
};

req.onsuccess = (e) => { db = e.target.result; initApp(); };

function tx(store, mode = 'readonly'){ return db.transaction(store, mode).objectStore(store); }
function dbSet(store, value){
  return new Promise((resolve) => {
    const request = tx(store, 'readwrite').put(value);
    request.onsuccess = () => resolve(request.result);
  });
}
function dbAdd(store, value){
  return new Promise((resolve) => {
    const request = tx(store, 'readwrite').add(value);
    request.onsuccess = () => resolve(request.result);
  });
}
function dbGet(store, key){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').get(key);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => resolve(null);
  });
}
function dbGetAll(store){
  return new Promise((resolve) => {
    const request = tx(store, 'readonly').getAll();
    request.onsuccess = () => resolve(request.result || []);
  });
}
function dbDelete(store, key){
  return new Promise((resolve) => {
    const request = tx(store, 'readwrite').delete(key);
    request.onsuccess = () => resolve(true);
  });
}
function dbDelAll(store){
  return new Promise((resolve) => {
    const request = tx(store, 'readwrite').clear();
    request.onsuccess = () => resolve(true);
  });
}

function showStatus(text, isError=false){
  const el = document.getElementById('statusTxt');
  el.textContent = text;
  el.style.color = isError ? 'var(--danger)' : 'inherit';
}

function notif(msg, type='ok'){
  showStatus(msg, type==='err');
  setTimeout(()=> updateStatus(), 3500);
}

function renderNum(){
  const numPad = String(appState.folio).padStart(4,'0');
  const techPad = appState.techId ? String(appState.techId).padStart(2,'0') : 'XX';
  document.getElementById('num').textContent = `N° ${techPad}${numPad}`; 
}

async function initApp(){
  if(!document.getElementById('fecha').value) document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
  document.getElementById('nomTec').addEventListener('change', onTechSelect);
  document.getElementById('cliNom').addEventListener('change', onClientSelect);
  document.getElementById('syncBtn').addEventListener('click', sync);

  const lastTech = await dbGet('config', 'lastTech');
  if (lastTech) {
    document.getElementById('nomTec').value = lastTech.name;
    await onTechSelect.call(document.getElementById('nomTec'));
  }
  
  await loadLists();
  await loadServices();
  await renderPendingBadge();
  syncServer();
  window.addEventListener('online', () => { updateStatus(); sync(); });
  window.addEventListener('offline', updateStatus);
  updateStatus();
  renderNum();
}

async function onTechSelect() {
  const name = this.value.trim();
  const techList = await dbGetAll('tecnicos');
  const selectedTech = techList.find(t => t.nombre === name);
  if (selectedTech) {
    appState.techId = selectedTech.id;
    appState.techName = selectedTech.nombre;
    await dbSet('config', { key: 'lastTech', id: appState.techId, name: appState.techName });
    const cfg = await dbGet('config', `folio_${appState.techId}`);
    appState.folio = cfg ? cfg.value : 1;
    renderNum();
  }
}

async function loadLists(){
  const clientes = await dbGetAll('clientes');
  const marcas = await dbGetAll('marcas');
  const modelos = await dbGetAll('modelos');
  const reps = await dbGetAll('repuestos');
  const tecnicos = await dbGetAll('tecnicos');

  document.getElementById('cli-list').innerHTML = clientes.map(c => `<option value="${escapeHtml(c.nombre)}">`).join('');
  document.getElementById('marca-list').innerHTML = marcas.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('modelo-list').innerHTML = modelos.map(m => `<option value="${escapeHtml(m.nombre)}">`).join('');
  document.getElementById('rep-list').innerHTML = reps.map(r => `<option value="${escapeHtml(r.nombre)}">`).join('');
  document.getElementById('tech-list').innerHTML = tecnicos.map(t => `<option value="${escapeHtml(t.nombre)}">`).join(''); 
}

/* Modificado para llenar el SELECT */
async function loadServices(){
  const servicios = await dbGetAll('servicios');
  const select = document.getElementById('trabSelect');
  select.innerHTML = '<option value="">-- Seleccione para agregar --</option>';
  servicios.forEach(s => {
    const val = s.value || s;
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  });
}

/* Función para agregar texto desde el menú */
function addTrabFromSelect() {
    const select = document.getElementById('trabSelect');
    const area = document.getElementById('trabDesc');
    if(!select.value) return;

    let currentText = area.value.trim();
    if(currentText === "") {
        area.value = select.value;
    } else {
        // Añade coma si no termina en una
        if(!currentText.endsWith(',')) currentText += ', ';
        area.value = currentText + ' ' + select.value;
    }
    select.value = ""; // Resetear selector
}

async function onClientSelect(){
  const nom = document.getElementById('cliNom').value.trim();
  if(!nom) return;
  const c = await dbGet('clientes', nom);
  if (c){
    document.getElementById('cliRut').value = c.rut || '';
    document.getElementById('cliDir').value = c.direccion || '';
    document.getElementById('cliCiu').value = c.ciudad || '';
    document.getElementById('cliCon').value = c.contacto || '';
    document.getElementById('cliMail').value = c.email || '';
    document.getElementById('cliTel').value = c.telefono || '';
  }
}

function addRepInst(){
  const c = document.getElementById('repInst');
  const d = document.createElement('div');
  d.className = 'rep-row';
  d.innerHTML = `<div><label>Repuesto</label><input type="text" class="rep-nom" list="rep-list" placeholder="Nombre repuesto"></div>
                 <div><label>Serie</label><input type="text" class="rep-ser" placeholder="N° Serie"></div>
                 <div style="align-self:center"><button class="btn-del" onclick="this.closest('.rep-row').remove()">X</button></div>`;
  c.appendChild(d);
}

async function save(){
  if (isSaving) return;
  isSaving = true;
  document.getElementById('saveBtn').disabled = true;

  try {
    if (!appState.techId) { notif('Seleccione Técnico.', 'err'); return; }
    const cliNom = document.getElementById('cliNom').value.trim();
    if(!cliNom){ notif('Ingrese cliente', 'err'); return; }

    const folioActual = String(appState.folio).padStart(4,'0');
    const correlativoCompleto = String(appState.techId).padStart(2,'0') + folioActual;

    // Guardar nuevos servicios escritos a mano para el futuro
    const rawTrab = document.getElementById('trabDesc').value;
    const listaTrabajos = rawTrab.split(',').map(t => t.trim()).filter(t => t.length > 2);
    
    for(const t of listaTrabajos) {
        const existe = await dbGetAll('servicios');
        if(!existe.find(s => (s.value || s) === t)) {
            await dbAdd('servicios', { value: t });
        }
    }
    await loadServices(); // Actualizar menú para la próxima

    const orden = {
      numero: correlativoCompleto, 
      fecha: document.getElementById('fecha').value,
      cliente: { nombre: cliNom, rut: document.getElementById('cliRut').value, direccion: document.getElementById('cliDir').value },
      equipo: { marca: document.getElementById('eqMarca').value, modelo: document.getElementById('eqMod').value, serie: document.getElementById('eqSer').value },
      contadores: { bn: document.getElementById('contBN').value || '0', color: document.getElementById('contColor').value || '0' },
      trab: listaTrabajos,
      obs: document.getElementById('obs').value.trim(),
      extra: { tecnico: appState.techName, idTecnico: appState.techId, folioTecnico: appState.folio }
    };

    await dbAdd('ordenesPend', orden);
    appState.folio++;
    await dbSet('config', { key: `folio_${appState.techId}`, value: appState.folio });
    renderNum();
    notif(`Guardada N°${correlativoCompleto}`, 'ok');
    
    // Limpiar
    document.getElementById('trabDesc').value = "";
    document.getElementById('obs').value = "";
    document.getElementById('cliNom').value = "";
    // ... más limpias si se desea
    
    if(navigator.onLine) await sync();
  } finally {
    isSaving = false;
    document.getElementById('saveBtn').disabled = false;
  }
}

async function renderPendingBadge(){
  const pend = await dbGetAll('ordenesPend');
  document.getElementById('badge').textContent = pend.length;
  document.getElementById('badge').style.display = pend.length > 0 ? 'inline-block' : 'none';
  document.getElementById('syncBtn').style.display = pend.length > 0 ? 'inline-block' : 'none';
}

async function sync(){
  if(isSyncing || !navigator.onLine) return;
  const pend = await dbGetAll('ordenesPend');
  if(pend.length === 0) return;
  isSyncing = true;
  showStatus('Sincronizando...');
  for(const o of pend){
    try {
      const res = await fetch(URL, { method: 'POST', body: JSON.stringify({ action: 'saveOrden', data: o }) });
      if((await res.json()).success) await dbDelete('ordenesPend', o.id);
    } catch (e){}
  }
  isSyncing = false;
  await renderPendingBadge();
  updateStatus();
}

async function syncServer(){
  if(!navigator.onLine) return;
  try {
    const r = await fetch(`${URL}?action=loadData&techId=${appState.techId || ''}`);
    const data = await r.json();
    if(data.success){
      if(data.tecnicos) { await dbDelAll('tecnicos'); for(const t of data.tecnicos) await dbSet('tecnicos', t); }
      if(data.servs){ await dbDelAll('servicios'); for(const s of data.servs) await dbAdd('servicios', { value: s }); }
      // ... cargar resto de listas
      await loadLists();
      await loadServices();
    }
  } catch (e){}
}

function updateStatus(){
  showStatus(navigator.onLine ? 'Conectado' : 'Offline', !navigator.onLine);
}

function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

window.addEventListener('DOMContentLoaded', () => {
    // Asegurar que el textarea esté listo
});
</script>
</body>
</html>
