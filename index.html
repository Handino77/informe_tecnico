<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Orden de Servicio Técnico - Realtech SpA</title>
<link rel="icon" href="logo_realtech.png" />
<style>
  :root{
    --blue: #004a99;
    --blue-dark: #003370;
    --muted: #f8fafc;
    --accent: #38a169;
    --danger: #e53e3e;
    --card: #ffffff;
    --text: #1f2937;
    --sub: #64748b;
    --border: #e2e8f0;
    --radius: 10px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: #f1f5f9;
    color: var(--text);
    padding: 15px;
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding-bottom: 100px;
  }

  .container {
    width: 100%;
    max-width: 980px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 25px;
    position: relative;
  }

  header {
    display: flex;
    gap: 20px;
    align-items: center;
    border-bottom: 2px solid var(--muted);
    padding-bottom: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .logo img { width: 80px; height: auto; border-radius: 6px; object-fit: contain; }
  .brand { flex: 1; min-width: 200px; }
  .brand h1 { margin: 0; font-size: 20px; color: var(--blue); line-height: 1.2; }
  .brand p { margin: 4px 0 0; font-size: 13px; color: var(--sub); line-height: 1.4; }
  
  .meta { 
    text-align: right; 
    min-width: 140px; 
    background: var(--muted);
    padding: 10px;
    border-radius: 8px;
  }
  .meta .num { font-weight: 800; color: var(--blue); font-size: 18px; margin-bottom: 4px; }
  .meta .fecha { font-size: 13px; color: var(--sub); display: flex; flex-direction: column; align-items: flex-end; }
  .meta .fecha input { text-align: right; padding: 4px; border: none; background: transparent; font-weight: 600; color: var(--sub); }

  .grid, .grid-eq {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
    align-items: end;
  }

  .grid-cliente {
    display: grid;
    grid-template-columns: 2fr 1fr; 
    gap: 15px;
    margin-bottom: 15px;
    align-items: end;
  }
  .grid-cliente > div:nth-child(3) { grid-column: 1 / 2; }
  .grid-cliente > div:nth-child(4) { grid-column: 2 / 3; }
  .grid-cliente > div:nth-child(5) { grid-column: 1 / 2; }
  .grid-cliente > div:nth-child(6) { grid-column: 2 / 3; }
  .grid-cliente .full-width { grid-column: 1 / -1; }

  label { display: block; font-size: 12px; color: var(--blue); font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  
  input[type="text"], input[type="date"], input[type="number"], textarea, select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: all 0.2s;
    height: 42px;
  }
  input:focus, textarea:focus, select:focus {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(0, 74, 153, 0.1);
  }
  textarea { min-height: 80px; resize: vertical; height: auto; }

  .section-title { margin: 25px 0 10px; }
  .section-title h2 {
    margin: 0; font-size: 14px;
    background: #f0f7ff;
    padding: 10px 15px;
    border-radius: 6px;
    border-left: 5px solid var(--blue);
    color: var(--blue);
    text-transform: uppercase;
  }

  .exp { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; }

  .footer { margin-top: 30px; border-top: 2px solid var(--muted); padding-top: 20px; }
  .firmas { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
  .firma-line { margin-top: 5px; border-top: 1px dashed var(--sub); padding-top: 5px; font-size: 11px; text-align: center; color: var(--sub); text-transform: uppercase; }

  .controls {
    position: fixed;
    bottom: 20px; right: 20px;
    display: flex; flex-direction: column; gap: 10px;
    z-index: 1000;
  }
  .controls button {
    padding: 12px 20px;
    border-radius: 50px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    min-width: 160px;
  }
  .btn-save { background: var(--accent); color: #fff; }
  .btn-blue { background: var(--blue); color: #fff; }

  .statusbar {
    position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    padding: 8px 16px;
    border-radius: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    z-index: 1100;
    display: flex; gap: 10px; align-items: center; font-size: 13px;
    border: 1px solid var(--border);
  }

  .img-thumb-container { 
    position: relative; 
    width: 100px; 
    height: 100px; 
    border-radius: 8px; 
    overflow: hidden; 
    border: 1px solid var(--border); 
    display: inline-block;
  }
  .img-thumb-container img { width: 100%; height: 100%; object-fit: cover; }
  .btn-img-del { 
    position: absolute; 
    top: 4px; 
    right: 4px; 
    background: rgba(229, 62, 62, 0.9); 
    color: white; 
    border: none; 
    width: 22px; 
    height: 22px; 
    border-radius: 50%; 
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
  }

  @media print {
    .no-print, .controls, .statusbar, #imgInput, .btn-img-del { display: none !important; }
    body, .container { background: #fff; margin: 0; padding: 0; box-shadow: none; width: 100%; }
    textarea, input { border: none !important; resize: none; overflow: hidden; }
  }

  @media (max-width: 768px) {
    .grid-cliente { grid-template-columns: 1fr; gap: 12px; }
    .grid-cliente > div { grid-column: 1 / -1 !important; }
    .controls { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 12px; flex-direction: row; border-top: 1px solid var(--border); }
    .controls button { flex: 1; min-width: auto; }
  }
</style>
</head>
<body>

<div class="statusbar" id="statusbar">
  <strong id="statusTxt">Cargando...</strong>
  <span id="badge" style="display:none;background:#f97316;color:#fff;padding:2px 6px;border-radius:10px;font-size:11px;">0</span>
  <button id="syncBtn" style="display:none;padding:4px 8px;border-radius:6px;border:none;background:#eef4ff;color:var(--blue);cursor:pointer;font-weight:bold;font-size:11px;">Sincronizar</button>
</div>

<div class="container">
  <header>
    <div class="logo"><img src="logo_realtech.png" alt="Realtech" onerror="this.style.display='none'"></div>
    <div class="brand">
      <h1>Realtech SpA – Orden de Servicio Técnico</h1>
      <p>RUT: 77.651.114-5 – Arturo Prat 780 of 203A, Temuco</p>
    </div>
    <div class="meta">
      <div class="num" id="num">N° XXXX</div> 
      <div class="fecha">Emisión: <input type="date" id="fecha"></div>
    </div>
  </header>

  <div class="grid-cliente">
    <div>
      <label>Cliente / Empresa</label>
      <input type="text" id="cliNom" list="clientesList" placeholder="Buscar o escribir nuevo">
      <datalist id="clientesList"></datalist>
    </div>
    <div>
      <label>RUT</label>
      <input type="text" id="cliRut" placeholder="76.123.456-7">
    </div>
    <div>
      <label>Dirección</label>
      <input type="text" id="cliDir">
    </div>
    <div>
      <label>Ciudad</label>
      <input type="text" id="cliCiu">
    </div>
    <div>
      <label>Contacto</label>
      <input type="text" id="cliCon">
    </div>
    <div>
      <label>Teléfono</label>
      <input type="text" id="cliTel">
    </div>
    <div>
      <label>Email</label>
      <input type="text" id="cliMail">
    </div>
  </div>

  <div class="section-title"><h2>Equipo</h2></div>
  <div class="grid-eq">
    <div>
      <label>Marca</label>
      <input type="text" id="eqMarca" list="marcasList" placeholder="Ej: Kyocera">
      <datalist id="marcasList"></datalist>
    </div>
    <div>
      <label>Modelo</label>
      <input type="text" id="eqMod" list="modelosList" placeholder="Ej: TASKalfa 3554ci">
      <datalist id="modelosList"></datalist>
    </div>
    <div>
      <label>Serie</label>
      <input type="text" id="eqSer">
    </div>
    <div>
      <label>Condición</label>
      <input type="text" id="eqCond" placeholder="Arriendo / Venta / Garantía">
    </div>
    <div>
      <label>Contador B/N</label>
      <input type="number" id="contBN">
    </div>
    <div>
      <label>Contador Color</label>
      <input type="number" id="contColor">
    </div>
  </div>

  <div class="section-title"><h2>Trabajo Realizado</h2></div>
  <textarea id="trabText" placeholder="Describa detalladamente el trabajo realizado..."></textarea>

  <div class="section-title"><h2>Observaciones</h2></div>
  <textarea id="obs" placeholder="Observaciones adicionales, recomendaciones, etc."></textarea>

  <div class="section-title"><h2>Evidencia Fotográfica</h2></div>
  <div class="exp">
    <input type="file" id="imgInput" accept="image/*" multiple class="no-print">
    <div id="imgPreview"></div>
    <p id="imgCounter">0 / 8 imágenes</p>
  </div>

  <div class="footer">
    <div class="section-title"><h2>Firmas</h2></div>
    <div class="firmas">
      <div>
        <label>Técnico</label>
        <input type="text" id="nomTec" placeholder="Nombre del técnico">
        <div class="firma-line">Firma</div>
      </div>
      <div>
        <label>Cliente</label>
        <input type="text" id="nomCliFirma" placeholder="Nombre quien recibe">
        <div class="firma-line">Firma</div>
      </div>
    </div>
  </div>
</div>

<canvas id="imgCanvas" style="display:none"></canvas>

<div class="controls no-print">
  <button class="btn-save" id="saveBtn" onclick="save()">GUARDAR</button>
</div>

<script>
// === URLs CORRECTAS PARA QUE TODO FUNCIONE ===
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzZkp-oX5hzqenXPrx_AuzDg2THUGChwCUU8OcW75YGLpm8lIJnDYfz0ibuIZs4WqE3/exec';
const WORKER_URL = 'https://informes-realtech.realtech-spa.workers.dev/';

const MAX_IMAGES = 8;
const MAX_IMAGE_SIZE = 1024;

let db;
let appImages = [];
let isSaving = false;
let isSyncing = false;

const appState = {
  folio: localStorage.getItem('folio') ? parseInt(localStorage.getItem('folio')) : 1,
  techId: localStorage.getItem('techId') || ''
};

function renderNum() {
  const num = document.getElementById('num');
  num.textContent = `N° ${appState.techId.padStart(2, '0')}${appState.folio.toString().padStart(4, '0')}`;
}

function loadLists() {
  // Clientes
  const clientesList = document.getElementById('clientesList');
  clientesList.innerHTML = '';
  const txCli = db.transaction('clientes');
  txCli.objectStore('clientes').getAll().onsuccess = (e) => {
    e.target.result.forEach(c => {
      const option = document.createElement('option');
      option.value = c.nombre;
      clientesList.appendChild(option);
    });
  };

  // Marcas
  const marcasList = document.getElementById('marcasList');
  marcasList.innerHTML = '';
  const txMarc = db.transaction('marcas');
  txMarc.objectStore('marcas').getAll().onsuccess = (e) => {
    e.target.result.forEach(m => {
      const option = document.createElement('option');
      option.value = m.nombre;
      marcasList.appendChild(option);
    });
  };

  // Modelos
  const modelosList = document.getElementById('modelosList');
  modelosList.innerHTML = '';
  const txMod = db.transaction('modelos');
  txMod.objectStore('modelos').getAll().onsuccess = (e) => {
    e.target.result.forEach(m => {
      const option = document.createElement('option');
      option.value = m.nombre;
      modelosList.appendChild(option);
    });
  };
}

async function updatePendingCount() {
  const tx = db.transaction('ordenesPend');
  const req = tx.objectStore('ordenesPend').count();
  req.onsuccess = () => {
    const count = req.result;
    const badge = document.getElementById('badge');
    const syncBtn = document.getElementById('syncBtn');
    const statusTxt = document.getElementById('statusTxt');
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'inline-block';
      syncBtn.style.display = 'inline-block';
      statusTxt.textContent = 'Pendientes por sincronizar';
    } else {
      badge.style.display = 'none';
      syncBtn.style.display = 'none';
      statusTxt.textContent = 'Sincronizado';
    }
  };
}

// Carga datos desde la planilla al abrir la app
async function syncServer() {
  if (!navigator.onLine) return;
  try {
    const r = await fetch(GAS_URL + '?action=loadData');
    const d = await r.json();
    if (d.success) {
      const tx = db.transaction(['clientes', 'tecnicos', 'servicios', 'marcas', 'modelos'], 'readwrite');
      
      await tx.objectStore('clientes').clear();
      await tx.objectStore('marcas').clear();
      await tx.objectStore('modelos').clear();
      await tx.objectStore('tecnicos').clear();
      await tx.objectStore('servicios').clear();

      d.cli.forEach(c => tx.objectStore('clientes').add(c));
      d.marcas.forEach(m => tx.objectStore('marcas').add({nombre: m}));
      d.modelos.forEach(m => tx.objectStore('modelos').add({nombre: m}));
      d.tecnicos.forEach(t => tx.objectStore('tecnicos').add(t));
      d.servs.forEach(s => tx.objectStore('servicios').add({value: s}));

      await tx.done;

      loadLists();
      console.log('Datos cargados y desplegables actualizados');
    }
  } catch(e) {
    console.error('Error cargando datos:', e);
  }
}

// Sincroniza órdenes pendientes usando el Worker
async function syncPendingOrders() {
  if (isSyncing || !navigator.onLine) return;
  
  isSyncing = true;
  const syncBtn = document.getElementById('syncBtn');
  syncBtn.textContent = 'Sincronizando...';
  
  try {
    const tx = db.transaction('ordenesPend', 'readonly');
    const ordenes = await new Promise((resolve, reject) => {
      const req = tx.objectStore('ordenesPend').getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = reject;
    });
    
    if (ordenes.length === 0) {
      await updatePendingCount();
      return;
    }
    
    for (const orden of ordenes) {
      try {
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveOrden',
            data: orden
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          const txDel = db.transaction('ordenesPend', 'readwrite');
          await txDel.objectStore('ordenesPend').delete(orden.id);
        }
      } catch(e) {
        console.error('Error al sincronizar orden:', e);
      }
    }
    
    await updatePendingCount();
    alert('Órdenes sincronizadas correctamente');
    
  } catch(e) {
    console.error('Error en sincronización:', e);
    alert('Error al sincronizar órdenes');
  } finally {
    isSyncing = false;
    syncBtn.textContent = 'Sincronizar';
  }
}

// Inicialización de IndexedDB
function initDB() {
  const request = indexedDB.open('InformesDB', 1);
  request.onupgradeneeded = (event) => {
    db = event.target.result;
    db.createObjectStore('clientes', { keyPath: 'nombre' });
    db.createObjectStore('marcas', { keyPath: 'nombre' });
    db.createObjectStore('modelos', { keyPath: 'nombre' });
    db.createObjectStore('tecnicos', { keyPath: 'id' });
    db.createObjectStore('servicios', { autoIncrement: true });
    db.createObjectStore('ordenesPend', { keyPath: 'id', autoIncrement: true });
  };
  request.onsuccess = (event) => {
    db = event.target.result;
    updatePendingCount();
    syncServer(); // Carga los datos al abrir la app
  };
}

initDB();

// El resto de tu código original (handleImageUpload, compressImage, renderImagePreviews, removeImage, save, clearForm, etc.) queda exactamente igual que en tu archivo actual

renderNum();
document.getElementById('fecha').valueAsDate = new Date();

</script>
</body>
</html>
