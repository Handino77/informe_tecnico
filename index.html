<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Informe Técnico Realtech</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; padding:20px }
label { display:block; margin-top:10px }
input, textarea, button {
  width:100%; padding:8px; margin-top:4px
}
button { margin-top:15px }
#preview img {
  max-width:110px;
  margin:5px;
  border-radius:6px;
  border:1px solid #ccc;
}
</style>
</head>

<body>

<h2>Informe Técnico</h2>

<label>N° Orden</label>
<input id="numero" readonly>

<label>Cliente</label>
<input id="cliente">

<label>RUT</label>
<input id="rut">

<label>Modelo</label>
<input id="modelo">

<label>Serie</label>
<input id="serie">

<label>Trabajo Realizado</label>
<textarea id="trabajo"></textarea>

<label>Adjuntar Imágenes</label>
<input type="file" id="imagenes" accept="image/*" multiple>
<div id="preview"></div>

<button onclick="guardarOrden()">Guardar Orden</button>

<script>
/* ==========================
   CONFIG
========================== */

const API_URL = "https://informes-realtech.realtech-spa.workers.dev/";
let folio = 1;
let db;
let syncRunning = false;
let imagenesAdjuntas = [];

/* ==========================
   INIT
========================== */

document.addEventListener("DOMContentLoaded", () => {
  initDB();
  loadData();
});

/* ==========================
   LOAD DATA (GET)
========================== */

function loadData() {
  fetch(API_URL + "?action=loadData")
    .then(r => r.json())
    .then(d => {
      if (d.lastNumTech) folio = d.lastNumTech + 1;
      renderFolio();
    });
}

function renderFolio() {
  document.getElementById("numero").value =
    "OT-" + String(folio).padStart(4, "0");
}

/* ==========================
   INDEXED DB
========================== */

function initDB() {
  const req = indexedDB.open("realtechDB", 1);

  req.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("pendientes")) {
      db.createObjectStore("pendientes", { autoIncrement:true });
    }
  };

  req.onsuccess = e => db = e.target.result;
}

/* ==========================
   IMAGE HANDLING + COMPRESS
========================== */

document.getElementById("imagenes").addEventListener("change", e => {
  imagenesAdjuntas = [];
  document.getElementById("preview").innerHTML = "";

  Array.from(e.target.files).forEach(file => {
    compressImage(file, 1000, 0.7).then(base64 => {
      imagenesAdjuntas.push(base64);

      const img = document.createElement("img");
      img.src = base64;
      document.getElementById("preview").appendChild(img);
    });
  });
});

function compressImage(file, maxSize, quality) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);

    img.onload = () => {
      let { width, height } = img;
      if (width > maxSize) {
        height *= maxSize / width;
        width = maxSize;
      }

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;

      canvas.getContext("2d").drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL("image/jpeg", quality));
    };
  });
}

/* ==========================
   SAVE ORDER
========================== */

function guardarOrden() {
  const orden = {
    numero: document.getElementById("numero").value,
    fecha: new Date().toISOString().split("T")[0],
    cliente: {
      nombre: cliente.value,
      rut: rut.value
    },
    equipo: {
      modelo: modelo.value,
      serie: serie.value
    },
    trab: trabajo.value,
    imagenes: imagenesAdjuntas
  };

  const tx = db.transaction("pendientes", "readwrite");
  tx.objectStore("pendientes").add(orden);

  tx.oncomplete = () => {
    alert("Orden guardada");
    folio++;
    renderFolio();
    limpiarFormulario();
    if (navigator.onLine) sync();
  };
}

function limpiarFormulario() {
  cliente.value = rut.value = modelo.value = serie.value = trabajo.value = "";
  imagenesAdjuntas = [];
  preview.innerHTML = "";
  imagenes.value = "";
}

/* ==========================
   SYNC (POST)
========================== */

function sync() {
  if (!navigator.onLine || syncRunning) return;
  syncRunning = true;

  const tx = db.transaction("pendientes", "readwrite");
  const store = tx.objectStore("pendientes");
  store.openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (!cursor) { syncRunning = false; return; }

    fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(cursor.value)
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) cursor.delete();
      cursor.continue();
    })
    .catch(() => syncRunning = false);
  };
}

window.addEventListener("online", sync);
</script>

</body>
</html>
