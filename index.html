<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Orden de Servicio Técnico - Realtech SpA</title>
<link rel="icon" href="logo_realtech.png" />
<style>
  :root{
    --blue: #004a99;
    --blue-dark: #003370;
    --muted: #f8fafc;
    --accent: #38a169;
    --danger: #e53e3e;
    --card: #ffffff;
    --text: #1f2937;
    --sub: #64748b;
    --border: #e2e8f0;
    --radius: 10px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: #f1f5f9;
    color: var(--text);
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .container { width: 100%; max-width: 800px; }

  header {
    background: var(--blue);
    color: white;
    padding: 20px;
    border-radius: var(--radius);
    text-align: center;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
  }

  .card {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
  }

  h2 { font-size: 1.1rem; margin-top: 0; color: var(--blue); border-bottom: 2px solid var(--muted); padding-bottom: 10px; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

  .field { margin-bottom: 15px; }
  label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--sub); margin-bottom: 5px; }
  
  input, select, textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  input:focus { outline: none; border-color: var(--blue); }

  .btn {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .btn-primary { background: var(--blue); color: white; }
  .btn-sync { background: var(--accent); color: white; margin-bottom: 10px; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  #status { font-size: 0.8rem; text-align: center; margin-top: 10px; color: var(--sub); }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1 style="margin:0; font-size: 1.4rem;">Realtech SpA</h1>
    <p style="margin:5px 0 0; font-size: 0.9rem; opacity: 0.9;">Generador de Informes Técnicos</p>
  </header>

  <button id="syncBtn" class="btn btn-sync" onclick="syncServer()">Sincronizar Datos</button>

  <form id="informeForm">
    <div class="card">
      <h2>Datos del Cliente</h2>
      <div class="field">
        <label>Buscar Cliente</label>
        <input type="text" id="clienteNombre" list="clientesList" placeholder="Escriba el nombre..." oninput="onClientSelect()">
        <datalist id="clientesList"></datalist>
      </div>
      <div class="grid">
        <div class="field">
          <label>RUT</label>
          <input type="text" id="clienteRut" readonly>
        </div>
        <div class="field">
          <label>Ciudad</label>
          <input type="text" id="clienteCiudad" readonly>
        </div>
      </div>
      <div class="field">
        <label>Dirección</label>
        <input type="text" id="clienteDireccion" readonly>
      </div>
    </div>

    <div class="card">
      <h2>Datos del Equipo</h2>
      <div class="grid">
        <div class="field">
          <label>Marca</label>
          <input type="text" id="marca" list="marcasList" placeholder="Seleccione o escriba...">
          <datalist id="marcasList"></datalist>
        </div>
        <div class="field">
          <label>Modelo</label>
          <input type="text" id="modelo" list="modelosList" placeholder="Seleccione o escriba...">
          <datalist id="modelosList"></datalist>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Detalles del Servicio</h2>
      <div class="field">
        <label>Técnico Asignado</label>
        <select id="tecnico" required>
          <option value="">Seleccione Técnico...</option>
        </select>
      </div>
      <div class="field">
        <label>Trabajo Realizado</label>
        <textarea id="trabajo" rows="4"></textarea>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Guardar Informe Técnico</button>
  </form>

  <div id="status">Iniciando sistema...</div>
</div>

<script>
// --- CONFIGURACIÓN ---
const WORKER_URL = 'https://informes-realtech.realtech-spa.workers.dev/';

let db;

// 1. INICIALIZAR BASE DE DATOS LOCAL
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('RealtechDB', 2); // Versión 2

    request.onupgradeneeded = (e) => {
      const dbSetup = e.target.result;
      const stores = ['clientes', 'marcas', 'modelos', 'tecnicos', 'servicios'];
      stores.forEach(s => {
        if (!dbSetup.objectStoreNames.contains(s)) {
          dbSetup.createObjectStore(s, { keyPath: 'id', autoIncrement: true });
        }
      });
      console.log("Estructura de DB creada/actualizada");
    };

    request.onsuccess = (e) => {
      db = e.target.result;
      resolve(db);
    };

    request.onerror = (e) => {
      console.error("Error al abrir IndexedDB", e);
      reject(e);
    };
  });
}

// 2. SINCRONIZAR DESDE GOOGLE SHEETS (VÍA WORKER)
async function syncServer() {
  if (!navigator.onLine) {
    alert("No tienes conexión a internet");
    return;
  }

  const btn = document.getElementById('syncBtn');
  btn.disabled = true;
  btn.textContent = 'Cargando datos...';

  try {
    const response = await fetch(WORKER_URL + '?action=loadData');
    const data = await response.json();

    if (data.success) {
      // Guardar en la base de datos local
      const stores = {
        'clientes': data.cli,
        'marcas': data.marcas.map(m => ({nombre: m})),
        'modelos': data.modelos.map(m => ({nombre: m})),
        'tecnicos': data.tecnicos,
        'servicios': data.servs.map(s => ({value: s}))
      };

      for (const [storeName, items] of Object.entries(stores)) {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        await store.clear();
        items.forEach(item => store.add(item));
        await tx.done;
      }

      alert("Datos sincronizados con éxito");
      loadLists(); // Refrescar los desplegables
    }
  } catch (error) {
    console.error("Error en syncServer:", error);
    alert("Error al obtener datos del servidor.");
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sincronizar Datos';
  }
}

// 3. CARGAR LISTAS EN EL FORMULARIO
async function loadLists() {
  if (!db) return;

  // Cargar Clientes
  const txCli = db.transaction('clientes', 'readonly');
  const clientes = await new Promise(r => {
    txCli.objectStore('clientes').getAll().onsuccess = (e) => r(e.target.result);
  });
  document.getElementById('clientesList').innerHTML = clientes.map(c => `<option value="${c.nombre}">`).join('');

  // Cargar Marcas
  const txMarcas = db.transaction('marcas', 'readonly');
  const marcas = await new Promise(r => {
    txMarcas.objectStore('marcas').getAll().onsuccess = (e) => r(e.target.result);
  });
  document.getElementById('marcasList').innerHTML = marcas.map(m => `<option value="${m.nombre}">`).join('');

  // Cargar Modelos
  const txModelos = db.transaction('modelos', 'readonly');
  const modelos = await new Promise(r => {
    txModelos.objectStore('modelos').getAll().onsuccess = (e) => r(e.target.result);
  });
  document.getElementById('modelosList').innerHTML = modelos.map(m => `<option value="${m.nombre}">`).join('');

  // Cargar Técnicos al Select
  const txTec = db.transaction('tecnicos', 'readonly');
  const tecnicos = await new Promise(r => {
    txTec.objectStore('tecnicos').getAll().onsuccess = (e) => r(e.target.result);
  });
  const tecSelect = document.getElementById('tecnico');
  tecSelect.innerHTML = '<option value="">Seleccione Técnico...</option>' + 
    tecnicos.map(t => `<option value="${t.nombre}">${t.nombre}</option>`).join('');

  document.getElementById('status').textContent = 'Sistema listo y cargado.';
}

// 4. AUTOCOMPLETAR DATOS DEL CLIENTE
async function onClientSelect() {
  const nombreBuscado = document.getElementById('clienteNombre').value;
  if (!nombreBuscado) return;

  const tx = db.transaction('clientes', 'readonly');
  const store = tx.objectStore('clientes');
  
  store.getAll().onsuccess = (e) => {
    const clientes = e.target.result;
    const encontrado = clientes.find(c => c.nombre === nombreBuscado);
    
    if (encontrado) {
      document.getElementById('clienteRut').value = encontrado.rut || '';
      document.getElementById('clienteDireccion').value = encontrado.direccion || '';
      document.getElementById('clienteCiudad').value = encontrado.ciudad || '';
    }
  };
}

// 5. INICIO DE LA APLICACIÓN
async function initApp() {
  try {
    document.getElementById('status').textContent = 'Iniciando Base de Datos...';
    await initDB();
    await loadLists();
    console.log("App Inicializada correctamente");
  } catch (err) {
    document.getElementById('status').textContent = 'Error al iniciar sistema.';
    console.error(err);
  }
}

window.onload = initApp;

</script>
</body>
</html>
